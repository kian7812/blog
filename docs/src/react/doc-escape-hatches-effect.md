# \*è„±å›´æœºåˆ¶ - effectï¼ˆæ–‡æ¡£ï¼‰

https://zh-hans.react.dev/learn/escape-hatches

- ï¼ˆè¿™äº›ç« èŠ‚ï¼Œæ›´å¤šæ˜¯ä¸ºäº†ç†è§£é—®é¢˜å’Œå®è·µï¼Œä¸æ˜¯ä½œä¸ºé¢˜ï¼Œä½†å¯ä»¥èŠåˆ°é¢˜é‡Œï¼Œå¦‚æœå¯ä»¥ï¼‰
- **å¾ˆå…¨é¢çš„è¯´æ˜äº†ï¼Œå„ç§ useEffect çš„ä½¿ç”¨åœºæ™¯ï¼Œå’Œä¸å¿…è¦ä½¿ç”¨çš„åœºæ™¯åŠæ›¿ä»£æ–¹æ¡ˆ**ã€‚âœ…

## \*ä½¿ç”¨ Effect åŒæ­¥

ä½¿ç”¨ useEffect åŒ…è£¹å‰¯ä½œç”¨ï¼ŒæŠŠå®ƒåˆ†ç¦»åˆ°æ¸²æŸ“é€»è¾‘çš„è®¡ç®—è¿‡ç¨‹ä¹‹å¤–ã€‚

### ä»€ä¹ˆæ˜¯ Effectï¼Œå®ƒä¸äº‹ä»¶ï¼ˆeventï¼‰æœ‰ä½•ä¸åŒï¼Ÿ

ï¼ˆ**ğŸ‘‡ğŸ» è¿™èŠ‚æè¿°æ–‡å­—æ¯”è¾ƒå¤šï¼Œä¸ç”¨è®°å¿†ï¼Œè¾…åŠ©ç†è§£å¾ˆå¥½ï¼Œæˆ–è€…ç›´æ¥çœ‹æ–‡æ¡£**ï¼‰

åœ¨è°ˆåˆ° Effect ä¹‹å‰ï¼Œä½ éœ€è¦ç†Ÿæ‚‰ React ç»„ä»¶ä¸­çš„ä¸¤ç§é€»è¾‘ç±»å‹ï¼š

- **æ¸²æŸ“é€»è¾‘ä»£ç **ï¼ˆåœ¨ æè¿° UI ä¸­æœ‰ä»‹ç»ï¼‰ä½äºç»„ä»¶çš„é¡¶å±‚ã€‚ä½ å°†åœ¨è¿™é‡Œæ¥æ”¶ props å’Œ stateï¼Œå¹¶å¯¹å®ƒä»¬è¿›è¡Œè½¬æ¢ï¼Œæœ€ç»ˆè¿”å›ä½ æƒ³åœ¨å±å¹•ä¸Šçœ‹åˆ°çš„ JSXã€‚**æ¸²æŸ“çš„ä»£ç å¿…é¡»æ˜¯çº¯ç²¹çš„**â€”â€”å°±åƒæ•°å­¦å…¬å¼ä¸€æ ·ï¼Œå®ƒåªåº”è¯¥â€œè®¡ç®—â€ç»“æœï¼Œè€Œä¸åšå…¶ä»–ä»»ä½•äº‹æƒ…ã€‚

- **äº‹ä»¶å¤„ç†ç¨‹åº**ï¼ˆåœ¨ æ·»åŠ äº¤äº’æ€§ ä¸­ä»‹ç»ï¼‰æ˜¯åµŒå¥—åœ¨ç»„ä»¶å†…éƒ¨çš„å‡½æ•°ï¼Œè€Œä¸ä»…ä»…æ˜¯è®¡ç®—å‡½æ•°ã€‚äº‹ä»¶å¤„ç†ç¨‹åºå¯èƒ½ä¼šæ›´æ–°è¾“å…¥å­—æ®µã€æäº¤ HTTP POST è¯·æ±‚ä»¥è´­ä¹°äº§å“ï¼Œæˆ–è€…å°†ç”¨æˆ·å¯¼èˆªåˆ°å¦ä¸€ä¸ªå±å¹•ã€‚äº‹ä»¶å¤„ç†ç¨‹åºåŒ…å«ç”±ç‰¹å®šç”¨æˆ·æ“ä½œï¼ˆä¾‹å¦‚æŒ‰é’®ç‚¹å‡»æˆ–é”®å…¥ï¼‰å¼•èµ·çš„â€œå‰¯ä½œç”¨â€ï¼ˆå®ƒä»¬æ”¹å˜äº†ç¨‹åºçš„çŠ¶æ€ï¼‰ã€‚

æœ‰æ—¶è¿™è¿˜ä¸å¤Ÿã€‚è€ƒè™‘ä¸€ä¸ª ChatRoom ç»„ä»¶ï¼Œå®ƒåœ¨å±å¹•ä¸Šå¯è§æ—¶å¿…é¡»è¿æ¥åˆ°èŠå¤©æœåŠ¡å™¨ã€‚è¿æ¥åˆ°æœåŠ¡å™¨ä¸æ˜¯ä¸€ä¸ªçº¯è®¡ç®—ï¼ˆå®ƒåŒ…å«å‰¯ä½œç”¨ï¼‰ï¼Œå› æ­¤å®ƒä¸èƒ½åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­å‘ç”Ÿã€‚ç„¶è€Œï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªç‰¹å®šçš„äº‹ä»¶ï¼ˆæ¯”å¦‚ç‚¹å‡»ï¼‰å¯¼è‡´ ChatRoom è¢«æ˜¾ç¤ºã€‚

**Effect å…è®¸ä½ æŒ‡å®šç”±æ¸²æŸ“æœ¬èº«ï¼Œè€Œä¸æ˜¯ç‰¹å®šäº‹ä»¶å¼•èµ·çš„å‰¯ä½œç”¨**ã€‚åœ¨èŠå¤©ä¸­å‘é€æ¶ˆæ¯æ˜¯ä¸€ä¸ªâ€œäº‹ä»¶â€ï¼Œå› ä¸ºå®ƒç›´æ¥ç”±ç”¨æˆ·ç‚¹å‡»ç‰¹å®šæŒ‰é’®å¼•èµ·ã€‚ç„¶è€Œï¼Œå»ºç«‹æœåŠ¡å™¨è¿æ¥æ˜¯ Effectï¼Œå› ä¸ºå®ƒåº”è¯¥å‘ç”Ÿæ— è®ºå“ªç§äº¤äº’å¯¼è‡´ç»„ä»¶å‡ºç°ã€‚Effect åœ¨å±å¹•æ›´æ–°åçš„ æäº¤é˜¶æ®µ è¿è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ—¶æœºï¼Œå¯ä»¥å°† React ç»„ä»¶ä¸æŸä¸ªå¤–éƒ¨ç³»ç»Ÿï¼ˆå¦‚ç½‘ç»œæˆ–ç¬¬ä¸‰æ–¹åº“ï¼‰åŒæ­¥ã€‚

:::info INFO: ä»€ä¹ˆåœºæ™¯ä½¿ç”¨ Effect (åˆ›å»ºå‰¯ä½œç”¨)

- âœ… **æ¸²æŸ“çš„ä»£ç å¿…é¡»æ˜¯çº¯ç²¹çš„**
- âœ… ä»è¿™ä¸ªè§’åº¦ç†è§£ï¼Œ**React ç¡®å®æ˜¯çº¯ç²¹çš„æ¸²æŸ“ä»£ç ï¼Œå’Œå„ç§å„æ ·çš„ å‰¯ä½œç”¨** ç»„æˆçš„ã€‚
- âœ…âœ… **Effect å…è®¸ä½ æŒ‡å®šç”±æ¸²æŸ“æœ¬èº«ï¼Œè€Œä¸æ˜¯ç‰¹å®šäº‹ä»¶å¼•èµ·çš„å‰¯ä½œç”¨**
- ä¸‹é¢å¾ˆå¤šå†…å®¹æ˜¯å¦‚ä½•ä½¿ç”¨ Effect åˆ›å»ºå‰¯ä½œç”¨

:::

### å¦‚ä½•ç¼–å†™ Effect

ç¼–å†™ Effect éœ€è¦éµå¾ªä»¥ä¸‹ä¸‰ä¸ªè§„åˆ™ï¼š

1. **å£°æ˜ Effect**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒEffect ä¼šåœ¨æ¯æ¬¡ commit åéƒ½ä¼šæ‰§è¡Œã€‚
2. **æŒ‡å®š Effect ä¾èµ–**ã€‚å¤§å¤šæ•° Effect åº”è¯¥æŒ‰éœ€æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨æ¯æ¬¡æ¸²æŸ“åéƒ½æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œæ·¡å…¥åŠ¨ç”»åº”è¯¥åªåœ¨ç»„ä»¶å‡ºç°æ—¶è§¦å‘ã€‚è¿æ¥å’Œæ–­å¼€æœåŠ¡å™¨çš„æ“ä½œåªåº”åœ¨ç»„ä»¶å‡ºç°å’Œæ¶ˆå¤±æ—¶ï¼Œæˆ–è€…åˆ‡æ¢èŠå¤©å®¤æ—¶æ‰§è¡Œã€‚æ–‡ç« å°†ä»‹ç»å¦‚ä½•é€šè¿‡æŒ‡å®šä¾èµ–æ¥æ§åˆ¶å¦‚ä½•æŒ‰éœ€æ‰§è¡Œã€‚
3. **å¿…è¦æ—¶æ·»åŠ æ¸…ç†ï¼ˆcleanupï¼‰å‡½æ•°**ã€‚æœ‰æ—¶ Effect éœ€è¦æŒ‡å®šå¦‚ä½•åœæ­¢ã€æ’¤é”€ï¼Œæˆ–è€…æ¸…é™¤å®ƒçš„æ•ˆæœã€‚ä¾‹å¦‚ï¼Œâ€œè¿æ¥â€æ“ä½œéœ€è¦â€œæ–­è¿â€ï¼Œâ€œè®¢é˜…â€éœ€è¦â€œé€€è®¢â€ï¼Œâ€œè·å–â€æ—¢éœ€è¦â€œå–æ¶ˆâ€ä¹Ÿéœ€è¦â€œå¿½ç•¥â€ã€‚ä½ å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨ æ¸…ç†å‡½æ•° æ¥åšåˆ°è¿™ä¸€åˆ‡ã€‚

### ä¸ºä»€ä¹ˆä¾èµ–æ•°ç»„ä¸­å¯ä»¥çœç•¥ ref?

è¿™æ˜¯å› ä¸º ref å…·æœ‰ ç¨³å®š çš„æ ‡è¯†ï¼šReact ä¿è¯ æ¯è½®æ¸²æŸ“ä¸­è°ƒç”¨ useRef æ‰€äº§ç”Ÿçš„å¼•ç”¨å¯¹è±¡æ—¶ï¼Œè·å–åˆ°çš„å¯¹è±¡å¼•ç”¨æ€»æ˜¯ç›¸åŒçš„ï¼Œå³è·å–åˆ°çš„å¯¹è±¡å¼•ç”¨æ°¸è¿œä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥å®ƒä¸ä¼šå¯¼è‡´é‡æ–°è¿è¡Œ Effectã€‚å› æ­¤ï¼Œä¾èµ–æ•°ç»„ä¸­æ˜¯å¦åŒ…å«å®ƒå¹¶ä¸é‡è¦ã€‚å½“ç„¶ä¹Ÿå¯ä»¥åŒ…æ‹¬å®ƒã€‚

å¦‚æœ ref æ˜¯ä»çˆ¶ç»„ä»¶ä¼ é€’çš„ï¼Œåˆ™å¿…é¡»åœ¨ä¾èµ–é¡¹æ•°ç»„ä¸­æŒ‡å®šå®ƒã€‚è¿™æ ·åšæ˜¯åˆé€‚çš„ï¼Œå› ä¸ºæ— æ³•ç¡®å®šçˆ¶ç»„ä»¶æ˜¯å¦å§‹ç»ˆæ˜¯ä¼ é€’ç›¸åŒçš„ refï¼Œæˆ–è€…å¯èƒ½æ˜¯æœ‰æ¡ä»¶åœ°ä¼ é€’å‡ ä¸ª ref ä¹‹ä¸€ã€‚å› æ­¤ï¼Œä½ çš„ Effect å°†å–å†³äºä¼ é€’çš„æ˜¯å“ªä¸ª refã€‚

### \*æŒ‰éœ€æ·»åŠ æ¸…ç†ï¼ˆcleanupï¼‰å‡½æ•°

**æ¯æ¬¡é‡æ–°æ‰§è¡Œ Effect ä¹‹å‰ï¼ŒReact éƒ½ä¼šè°ƒç”¨æ¸…ç†å‡½æ•°ï¼›ç»„ä»¶è¢«å¸è½½æ—¶ï¼Œä¹Ÿä¼šè°ƒç”¨æ¸…ç†å‡½æ•°**ã€‚âœ…

```js
import { useState, useEffect } from "react";
import { createConnection } from "./chat.js";

export default function ChatRoom() {
  useEffect(() => {
    const connection = createConnection();
    connection.connect();
    return () => connection.disconnect(); // âœ…
  }, []);
  return <h1>æ¬¢è¿æ¥åˆ°èŠå¤©å®¤ï¼</h1>;
}

// chat.js
export function createConnection() {
  // çœŸå®çš„å®ç°ä¼šå°†å…¶è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œæ­¤å¤„ä»£ç åªæ˜¯ç¤ºä¾‹
  return {
    connect() {
      console.log("âœ… è¿æ¥ä¸­â€¦â€¦");
    },
    disconnect() {
      console.log("âŒ è¿æ¥æ–­å¼€ã€‚");
    },
  };
}
```

### å¦‚ä½•å¤„ç†åœ¨å¼€å‘ç¯å¢ƒä¸­ Effect æ‰§è¡Œä¸¤æ¬¡ï¼Ÿ

ï¼ˆ**ğŸ‘‡ğŸ» è¿™èŠ‚çš„å„åœºæ™¯ä¸­ï¼Œæè¿°æ–‡å­—æ¯”è¾ƒå¤šï¼Œä¸ç”¨è®°å¿†ï¼Œè¾…åŠ©ç†è§£å¾ˆå¥½ï¼Œæˆ–è€…ç›´æ¥çœ‹æ–‡æ¡£**ï¼‰

#### æ§åˆ¶é React ç»„ä»¶

æŸäº› API å¯èƒ½ä¸å…è®¸è¿ç»­è°ƒç”¨ä¸¤æ¬¡ã€‚ä¾‹å¦‚ï¼Œå†…ç½®çš„ `<dialog>` å…ƒç´ çš„ showModal æ–¹æ³•åœ¨è¿ç»­è°ƒç”¨ä¸¤æ¬¡æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ­¤æ—¶å®ç°æ¸…ç†å‡½æ•°å¹¶ä½¿å…¶å…³é—­å¯¹è¯æ¡†ï¼š

```js
useEffect(() => {
  const dialog = dialogRef.current;
  dialog.showModal();
  return () => dialog.close();
}, []);
```

_åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼ŒEffect å°†è°ƒç”¨ showModal()ï¼Œç„¶åç«‹å³è°ƒç”¨ close()ï¼Œç„¶åå†æ¬¡è°ƒç”¨ showModal()ã€‚è¿™ä¸è°ƒç”¨åªä¸€æ¬¡ showModal() çš„æ•ˆæœç›¸åŒã€‚ä¹Ÿæ­£å¦‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çœ‹åˆ°çš„é‚£æ ·_ã€‚

#### è®¢é˜…äº‹ä»¶

å¦‚æœ Effect è®¢é˜…äº†æŸäº›äº‹ä»¶ï¼Œæ¸…ç†å‡½æ•°åº”è¯¥é€€è®¢è¿™äº›äº‹ä»¶ï¼š

```js
useEffect(() => {
  function handleScroll(e) {
    console.log(window.scrollX, window.scrollY);
  }
  window.addEventListener("scroll", handleScroll);
  return () => window.removeEventListener("scroll", handleScroll);
}, []);
```

_åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼ŒEffect ä¼šè°ƒç”¨ addEventListener()ï¼Œç„¶åç«‹å³è°ƒç”¨ removeEventListener()ï¼Œç„¶åå†è°ƒç”¨ç›¸åŒçš„ addEventListener()ï¼Œè¿™ä¸åªè®¢é˜…ä¸€æ¬¡äº‹ä»¶çš„ Effect ç­‰æ•ˆï¼›è¿™ä¹Ÿä¸ç”¨æˆ·åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åªè°ƒç”¨ä¸€æ¬¡ addEventListener() å…·æœ‰ç›¸åŒçš„æ„ŸçŸ¥æ•ˆæœ_ã€‚

#### è§¦å‘åŠ¨ç”»

å¦‚æœ Effect å¯¹æŸäº›å†…å®¹åŠ å…¥äº†åŠ¨ç”»ï¼Œæ¸…ç†å‡½æ•°åº”å°†åŠ¨ç”»é‡ç½®ï¼š

```js
useEffect(() => {
  const node = ref.current;
  node.style.opacity = 1; // è§¦å‘åŠ¨ç”»
  return () => {
    node.style.opacity = 0; // é‡ç½®ä¸ºåˆå§‹å€¼
  };
}, []);
```

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œé€æ˜åº¦ç”± 1 å˜ä¸º 0ï¼Œå†å˜ä¸º 1ã€‚è¿™ä¸åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œç›´æ¥å°†å…¶è®¾ç½®ä¸º 1 å…·æœ‰ç›¸åŒçš„æ„ŸçŸ¥æ•ˆæœï¼Œå¦‚æœä½ ä½¿ç”¨æ”¯æŒè¿‡æ¸¡çš„ç¬¬ä¸‰æ–¹åŠ¨ç”»åº“ï¼Œä½ çš„æ¸…ç†å‡½æ•°åº”å°†æ—¶é—´è½´é‡ç½®ä¸ºå…¶åˆå§‹çŠ¶æ€ã€‚

#### \*è·å–æ•°æ®

_å¦‚æœ Effect å°†ä¼šè·å–æ•°æ®ï¼Œæ¸…ç†å‡½æ•°åº”è¯¥è¦ä¹ˆ ä¸­æ­¢è¯¥æ•°æ®è·å–æ“ä½œï¼Œè¦ä¹ˆå¿½ç•¥å…¶ç»“æœ_ï¼š

ï¼ˆ**ä¸‹é¢ ğŸ‘‡ğŸ» ignore æ˜¯é€šè¿‡é—­åŒ…æ¥å®ç°çš„ï¼Œå¼‚æ­¥ä»»åŠ¡ä½¿ç”¨äº†çˆ¶çº§ä½œç”¨åŸŸçš„å˜é‡**âœ…ï¼‰

```js
useEffect(() => {
  let ignore = false;

  async function startFetching() {
    const json = await fetchTodos(userId);
    if (!ignore) {
      setTodos(json);
    }
  }

  startFetching();

  return () => {
    ignore = true;
  };
}, [userId]);
```

æˆ‘ä»¬æ— æ³•æ’¤æ¶ˆå·²ç»å‘ç”Ÿçš„ç½‘ç»œè¯·æ±‚ï¼Œä½†æ˜¯æ¸…ç†å‡½æ•°åº”å½“ç¡®ä¿è·å–æ•°æ®çš„è¿‡ç¨‹ä»¥åŠè·å–åˆ°çš„ç»“æœä¸ä¼šç»§ç»­å½±å“ç¨‹åºè¿è¡Œã€‚å¦‚æœ userId ä» 'Alice' å˜ä¸º 'Bob'ï¼Œé‚£ä¹ˆè¯·ç¡®ä¿ 'Alice' å“åº”æ•°æ®è¢«å¿½ç•¥ï¼Œå³ä½¿å®ƒåœ¨ 'Bob' ä¹‹ååˆ°è¾¾ã€‚

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œæµè§ˆå™¨è°ƒè¯•å·¥å…·çš„â€œç½‘ç»œâ€é€‰é¡¹å¡ä¸­ä¼šå‡ºç°ä¸¤ä¸ª fetch è¯·æ±‚ã€‚è¿™æ˜¯æ­£å¸¸çš„ã€‚ä½¿ç”¨ä¸Šè¿°æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ª Effect å°†ç«‹å³è¢«æ¸…ç†ï¼Œè€Œ ignore å°†è¢«è®¾ç½®ä¸º trueã€‚å› æ­¤ï¼Œå³ä½¿æœ‰é¢å¤–çš„è¯·æ±‚ï¼Œç”±äºæœ‰ if (!ignore) åˆ¤æ–­æ£€æŸ¥ï¼Œä¹Ÿä¸ä¼šå½±å“ç¨‹åºçŠ¶æ€ã€‚

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåªä¼šæ˜¾ç¤ºå‘é€äº†ä¸€æ¡è·å–è¯·æ±‚ã€‚å¦‚æœå¼€å‘ç¯å¢ƒä¸­ï¼Œç¬¬äºŒæ¬¡è¯·æ±‚ç»™ä½ é€ æˆäº†å›°æ‰°ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ç§å¯ä»¥åˆ é™¤é‡å¤è¯·æ±‚ã€å¹¶ç¼“å­˜è¯·æ±‚å“åº”çš„è§£å†³æ–¹æ¡ˆ

#### Effect ä¸­æœ‰å“ªäº›å¥½çš„æ•°æ®è·å–æ›¿ä»£æ–¹æ¡ˆï¼Ÿ

åœ¨ Effect ä¸­è°ƒç”¨ fetch è¯·æ±‚æ•°æ® æ˜¯ä¸€ç§éå¸¸å—æ¬¢è¿çš„æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯åœ¨å®¢æˆ·ç«¯åº”ç”¨ä¸­ã€‚ç„¶è€Œï¼Œå®ƒéå¸¸ä¾èµ–æ‰‹åŠ¨æ“ä½œï¼Œæœ‰å¾ˆå¤šçš„ç¼ºç‚¹ï¼š

- Effect ä¸èƒ½åœ¨æœåŠ¡ç«¯æ‰§è¡Œ
- ç›´æ¥åœ¨ Effect ä¸­è·å–æ•°æ®å®¹æ˜“äº§ç”Ÿç½‘ç»œç€‘å¸ƒï¼ˆnetwork waterfallï¼‰
- ç›´æ¥åœ¨ Effect ä¸­è·å–æ•°æ®é€šå¸¸æ„å‘³ç€æ— æ³•é¢„åŠ è½½æˆ–ç¼“å­˜æ•°æ®
- è¿™ä¸æ˜¯å¾ˆç¬¦åˆäººæœºäº¤äº’åŸåˆ™

æˆ‘ä»¬æ¨èä»¥ä¸‹æ–¹æ³•ï¼š

- å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ æ¡†æ¶ ï¼Œä½¿ç”¨å…¶å†…ç½®çš„æ•°æ®è·å–æœºåˆ¶ã€‚ç°ä»£ React æ¡†æ¶é›†æˆäº†é«˜æ•ˆçš„æ•°æ®è·å–æœºåˆ¶ï¼Œä¸ä¼šå‡ºç°ä¸Šè¿°é—®é¢˜ã€‚å¦‚ nextjs
- å¦åˆ™ï¼Œè¯·è€ƒè™‘ä½¿ç”¨æˆ–æ„å»ºå®¢æˆ·ç«¯ç¼“å­˜ã€‚ç›®å‰å—æ¬¢è¿çš„å¼€æºè§£å†³æ–¹æ¡ˆæ˜¯ React Queryã€useSWR å’Œ React Router v6.4+ã€‚
- ä½ ä¹Ÿå¯ä»¥æ„å»ºè‡ªå·±çš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥åœ¨å¹•åä½¿ç”¨ Effectï¼Œä½†æ˜¯è¯·æ³¨æ„æ·»åŠ ç”¨äºåˆ é™¤é‡å¤è¯·æ±‚ã€ç¼“å­˜å“åº”å’Œé¿å…ç½‘ç»œç€‘å¸ƒï¼ˆé€šè¿‡é¢„åŠ è½½æ•°æ®æˆ–å°†æ•°æ®éœ€æ±‚æå‡åˆ°è·¯ç”±ï¼‰çš„é€»è¾‘ã€‚

#### å‘é€åˆ†ææŠ¥å‘Š

è€ƒè™‘åœ¨è®¿é—®é¡µé¢æ—¶å‘é€æ—¥å¿—åˆ†æï¼š

```js
useEffect(() => {
  logVisit(url); // å‘é€ POST è¯·æ±‚
}, [url]);
```

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼ŒlogVisit ä¼šä¸ºæ¯ä¸ª URL å‘é€ä¸¤æ¬¡è¯·æ±‚ï¼Œæ‰€ä»¥ä½ å¯èƒ½ä¼šæƒ³å°è¯•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä¸è¿‡æˆ‘ä»¬å»ºè®®**ä¸å¿…ä¿®æ”¹æ­¤å¤„ä»£ç **ï¼Œä¸å‰é¢çš„ç¤ºä¾‹ä¸€æ ·ï¼Œä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œè¿è¡Œä¸€æ¬¡å’Œè¿è¡Œä¸¤æ¬¡ä¹‹é—´ä¸ä¼š æ„ŸçŸ¥ åˆ°è¡Œä¸ºå·®å¼‚ã€‚ä»å®é™…çš„è§’åº¦æ¥çœ‹ï¼ŒlogVisit ä¸åº”è¯¥åœ¨å¼€å‘ç¯å¢ƒä¸­åšä»»ä½•å½±å“ç”Ÿäº§äº‹æƒ…ã€‚ç”±äºæ¯æ¬¡ä¿å­˜ä»£ç æ–‡ä»¶æ—¶éƒ½ä¼šé‡æ–°æŒ‚è½½ç»„ä»¶ï¼Œå› æ­¤åœ¨å¼€å‘ç¯å¢ƒä¸­ä¼šé¢å¤–è®°å½•è®¿é—®æ¬¡æ•°ã€‚**åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸ä¼šäº§ç”Ÿæœ‰é‡å¤çš„è®¿é—®æ—¥å¿—**ã€‚

#### åˆå§‹åŒ–åº”ç”¨æ—¶ä¸éœ€è¦ä½¿ç”¨ Effect çš„æƒ…å½¢

æŸäº›é€»è¾‘åº”è¯¥åªåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è¿è¡Œä¸€æ¬¡ã€‚æ¯”å¦‚ï¼ŒéªŒè¯ç™»é™†çŠ¶æ€å’ŒåŠ è½½æœ¬åœ°ç¨‹åºæ•°æ®ã€‚ä½ å¯ä»¥å°†å…¶æ”¾åœ¨ç»„ä»¶ä¹‹å¤–ï¼š

```js
if (typeof window !== "undefined") {
  // æ£€æŸ¥æ˜¯å¦åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ
  checkAuthToken();
  loadDataFromLocalStorage();
}

function App() {
  // â€¦â€¦
}
```

è¿™ä¿è¯äº†è¿™ç§é€»è¾‘åœ¨æµè§ˆå™¨åŠ è½½é¡µé¢ååªè¿è¡Œä¸€æ¬¡ã€‚

#### ä¸è¦åœ¨ Effect ä¸­æ‰§è¡Œè´­ä¹°å•†å“ä¸€ç±»çš„æ“ä½œ

æœ‰æ—¶ï¼Œå³ä½¿ç¼–å†™äº†ä¸€ä¸ªæ¸…ç†å‡½æ•°ï¼Œä¹Ÿä¸èƒ½é¿å…æ‰§è¡Œä¸¤æ¬¡ Effectã€‚ä¾‹å¦‚ï¼ŒEffect åŒ…å«ä¼šå‘é€ POST è¯·æ±‚ä»¥æ‰§è¡Œè´­ä¹°æ“ä½œï¼š

```js
useEffect(() => {
  // ğŸ”´ é”™è¯¯ï¼šæ­¤å¤„çš„ Effect ä¼šåœ¨å¼€å‘ç¯å¢ƒä¸­æ‰§è¡Œä¸¤æ¬¡ï¼Œè¿™åœ¨ä»£ç ä¸­æ˜¯æœ‰é—®é¢˜çš„ã€‚
  fetch("/api/buy", { method: "POST" });
}, []);
```

ä¸€æ–¹é¢ï¼Œå¼€å‘ç¯å¢ƒä¸‹ï¼ŒEffect ä¼šæ‰§è¡Œä¸¤æ¬¡ï¼Œè¿™æ„å‘³ç€è´­ä¹°æ“ä½œæ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œä½†æ˜¯è¿™å¹¶éæ˜¯é¢„æœŸçš„ç»“æœï¼Œæ‰€ä»¥ä¸åº”è¯¥æŠŠè¿™ä¸ªä¸šåŠ¡é€»è¾‘æ”¾åœ¨ Effect ä¸­ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœç”¨æˆ·è½¬åˆ°å¦ä¸€ä¸ªé¡µé¢ï¼Œç„¶åæŒ‰â€œåé€€â€æŒ‰é’®å›åˆ°äº†è¿™ä¸ªç•Œé¢ï¼Œè¯¥æ€ä¹ˆåŠï¼ŸEffect ä¼šéšç€ç»„ä»¶å†æ¬¡æŒ‚è½½è€Œå†æ¬¡æ‰§è¡Œã€‚æ‰€ä»¥ï¼Œå½“ç”¨æˆ·é‡æ–°è®¿é—®æŸä¸ªé¡µé¢æ—¶ï¼Œä¸åº”å½“æ‰§è¡Œè´­ä¹°æ“ä½œï¼›å½“åªæœ‰ç”¨æˆ·ç‚¹å‡»â€œè´­ä¹°â€æŒ‰é’®æ—¶ï¼Œæ‰æ‰§è¡Œè´­ä¹°æ“ä½œã€‚

å› æ­¤ï¼Œâ€œè´­ä¹°â€çš„æ“ä½œä¸åº”ç”±ç»„ä»¶çš„æŒ‚è½½ã€æ¸²æŸ“å¼•èµ·çš„ï¼›å®ƒæ˜¯ç”±ç‰¹å®šçš„äº¤äº’ä½œç”¨å¼•èµ·çš„ï¼Œå®ƒåº”è¯¥åªåœ¨ç”¨æˆ·æŒ‰ä¸‹æŒ‰é’®æ—¶è¿è¡Œã€‚å› æ­¤ï¼Œå®ƒä¸åº”è¯¥å†™åœ¨ Effect ä¸­ï¼Œåº”å½“æŠŠ /api/buy è¯·æ±‚æ“ä½œç§»åŠ¨åˆ°è´­ä¹°æŒ‰é’®äº‹ä»¶å¤„ç†ç¨‹åºä¸­ï¼š

```js
function handleClick() {
  // âœ… è´­ä¹°å•†å“åº”å½“åœ¨äº‹ä»¶ä¸­æ‰§è¡Œï¼Œå› ä¸ºè¿™æ˜¯ç”±ç‰¹å®šçš„æ“ä½œå¼•èµ·çš„ã€‚
  fetch("/api/buy", { method: "POST" });
}
```

**è¿™ä¸ªä¾‹å­è¯´æ˜å¦‚æœé‡æ–°æŒ‚è½½ç ´åäº†åº”ç”¨ç¨‹åºçš„é€»è¾‘ï¼Œåˆ™é€šå¸¸å«æœ‰æœªè¢«å‘ç°çš„é”™è¯¯**ã€‚ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œè®¿é—®ä¸€ä¸ªé¡µé¢ä¸åº”è¯¥ä¸è®¿é—®å®ƒã€ç‚¹å‡»é“¾æ¥ç„¶åæŒ‰ä¸‹è¿”å›é”®å†æ¬¡æŸ¥çœ‹é¡µé¢æœ‰ä»€ä¹ˆä¸åŒã€‚React é€šè¿‡åœ¨å¼€å‘ç¯å¢ƒä¸­é‡å¤æŒ‚è½½ç»„ä»¶ä»¥éªŒè¯ç»„ä»¶æ˜¯å¦éµå®ˆæ­¤åŸåˆ™ã€‚

### \*æ¯ä¸€è½®æ¸²æŸ“éƒ½æœ‰è‡ªå·±çš„ Effectï¼ˆæ€»ç»“ï¼‰

1. **å³ä½¿æœ‰æ¸…ç†å‡½æ•°ï¼Œä¹Ÿæ‰§è¡Œæ¸…ç†å‡½æ•°è€Œå·²ã€‚ä½†æ¯ä¸ª Effect å›è°ƒå‡½æ•°ï¼Œåœ¨ commit é˜¶æ®µéƒ½ä¼šæ‰§è¡Œçš„** âœ…ã€‚
   - ç¤ºä¾‹ä¸­ï¼šç°åœ¨ç¼–è¾‘è¾“å…¥æ¡†ï¼Œè¾“å…¥ abcã€‚å¦‚æœè¾“å…¥é€Ÿåº¦è¶³å¤Ÿå¿«ï¼Œä½ ä¼šçœ‹åˆ° å®‰æ’ "ab" æ—¥å¿—ï¼Œç´§æ¥ç€çš„æ˜¯ å–æ¶ˆ "ab" æ—¥å¿— å’Œ å®‰æ’ "abc" æ—¥å¿—ã€‚
   - å°±è§£é‡Šäº†ï¼Œä¸ºä»€ä¹ˆ å®‰æ’ "xx" æ²¡æœ‰è¢«æ¸…ç†æ‰ï¼ŒEffect å›è°ƒå‡½æ•°æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šæ‰§è¡Œçš„ï¼Œåªæ˜¯å¦‚æœæœ‰æ¸…ç†å‡½æ•°ï¼Œä¼šæ‰§è¡ŒåŒä¸€ä¸ª Effect çš„ä¸Šä¸€è½®æ¸²æŸ“çš„ Effect çš„æ¸…ç†å‡½æ•°ã€‚
2. æœ‰æ¸…ç†å‡½æ•°ï¼š

   1. **React æ€»æ˜¯åœ¨æ‰§è¡Œä¸‹ä¸€è½®æ¸²æŸ“çš„ Effect ä¹‹å‰ï¼Œæ‰§è¡Œä¸Šä¸€è½®æ¸²æŸ“çš„ Effect çš„æ¸…ç†å‡½æ•°ã€‚**
   2. ç»„ä»¶å¸è½½æ—¶ï¼Œä¼šæ‰§è¡ŒåŒä¸€ä¸ª Effect çš„æœ€åä¸€è½®æ¸²æŸ“çš„ Effect çš„æ¸…ç†å‡½æ•°ã€‚

3. **é—­åŒ…é—®é¢˜**ï¼ŒuseEffect çš„å›è°ƒå‡½æ•°ï¼Œä»¥åŠé‡Œé¢ setTimeout å›è°ƒå‡½æ•°ï¼Œéƒ½ä¼šç”¨åˆ°å¤–å±‚å‡½æ•°ç»„ä»¶ä½œç”¨åŸŸçš„å˜é‡ã€‚
4. **æ³¨é‡Šæ‰æ¸…ç†å‡½æ•°**ï¼š
   è¿™æ ·å®‰æ’æ“ä½œå°±ä¸ä¼šè¢«å–æ¶ˆã€‚å°è¯•å¿«é€Ÿè¾“å…¥ abcdeï¼š
   ä¸‰ç§’åï¼Œä½ åº”è¯¥çœ‹åˆ°ä¸€ç³»åˆ—æ—¥å¿—ï¼šaã€abã€abcã€abcd ä¸ abcdeï¼Œè€Œä¸æ˜¯äº”ä¸ª abcdeã€‚æ¯ä¸ª Effect éƒ½ä¼šâ€œæ•è·â€å…¶å¯¹åº”æ¸²æŸ“çš„ text å€¼ã€‚text state å‘ç”Ÿå˜åŒ–å¹¶ä¸é‡è¦ï¼šæ¥è‡ª text = 'ab' çš„æ¸²æŸ“çš„ Effect å§‹ç»ˆä¼šå¾—åˆ° 'ab'ã€‚æ¢å¥è¯è¯´ï¼Œæ¯ä¸ªæ¸²æŸ“çš„ Effect éƒ½æ˜¯ç›¸äº’éš”ç¦»çš„ã€‚å¦‚æœä½ å¯¹è¿™æ˜¯å¦‚ä½•å·¥ä½œçš„æ„Ÿåˆ°å¥½å¥‡ï¼Œä½ å¯ä»¥é˜…è¯»æœ‰å…³ é—­åŒ… çš„å†…å®¹ã€‚
5. ã€‚

```js
import { useState, useEffect } from "react";

function Playground() {
  const [text, setText] = useState("a");

  useEffect(() => {
    function onTimeout() {
      console.log("â° " + text);
    }

    console.log('ğŸ”µ å®‰æ’ "' + text + '" æ—¥å¿—');
    const timeoutId = setTimeout(onTimeout, 3000);

    return () => {
      console.log('ğŸŸ¡ å–æ¶ˆ "' + text + '" æ—¥å¿—');
      clearTimeout(timeoutId);
    };
  }, [text]);

  return (
    <>
      <label>
        æ—¥å¿—å†…å®¹ï¼š{" "}
        <input value={text} onChange={(e) => setText(e.target.value)} />
      </label>
      <h1>{text}</h1>
    </>
  );
}

export default function App() {
  const [show, setShow] = useState(false);
  return (
    <>
      <button onClick={() => setShow(!show)}>
        {show ? "å¸è½½" : "æŒ‚è½½"} ç»„ä»¶
      </button>
      {show && <hr />}
      {show && <Playground />}
    </>
  );
}
```

## ä½ å¯èƒ½ä¸éœ€è¦ Effect

Effect æ˜¯ React èŒƒå¼ä¸­çš„ä¸€ç§è„±å›´æœºåˆ¶ã€‚å®ƒä»¬è®©ä½ å¯ä»¥ â€œé€ƒå‡ºâ€ React å¹¶ä½¿ç»„ä»¶å’Œä¸€äº›å¤–éƒ¨ç³»ç»ŸåŒæ­¥ï¼Œæ¯”å¦‚é React ç»„ä»¶ã€ç½‘ç»œå’Œæµè§ˆå™¨ DOMã€‚å¦‚æœæ²¡æœ‰æ¶‰åŠåˆ°å¤–éƒ¨ç³»ç»Ÿï¼ˆä¾‹å¦‚ï¼Œä½ æƒ³æ ¹æ® props æˆ– state çš„å˜åŒ–æ¥æ›´æ–°ä¸€ä¸ªç»„ä»¶çš„ stateï¼‰ï¼Œä½ å°±ä¸åº”è¯¥ä½¿ç”¨ Effectã€‚ç§»é™¤ä¸å¿…è¦çš„ Effect å¯ä»¥è®©ä½ çš„ä»£ç æ›´å®¹æ˜“ç†è§£ï¼Œè¿è¡Œå¾—æ›´å¿«ï¼Œå¹¶ä¸”æ›´å°‘å‡ºé”™ã€‚

### \*å¦‚ä½•ç§»é™¤ä¸å¿…è¦çš„ Effect

æœ‰ä¸¤ç§ä¸å¿…ä½¿ç”¨ Effect çš„å¸¸è§æƒ…å†µï¼š

1. **ä½ ä¸å¿…ä½¿ç”¨ Effect æ¥è½¬æ¢æ¸²æŸ“æ‰€éœ€çš„æ•°æ®**ã€‚ï¼ˆä½¿ç”¨å‡½æ•°æ€ç»´å¤„ç†ï¼Œæ”¹å˜ state æˆ– props ä¼šé‡æ–°æ¸²æŸ“å‡½æ•°ï¼Œæ­¤æ—¶å‡½æ•°é‡Œç›´æ¥å¤„ç†ï¼‰ï¼ˆæ–°è¯ï¼šåœ¨æ¸²æŸ“æœŸé—´è®¡ç®— âœ…ï¼‰
   - é€šè¿‡æ·»åŠ  key æ¥é‡ç½®æ‰€æœ‰ stateï¼Œæˆ–è€… åœ¨æ¸²æŸ“æœŸé—´è®¡ç®—æ‰€éœ€å†…å®¹ã€‚
2. **ä½ ä¸å¿…ä½¿ç”¨ Effect æ¥å¤„ç†ç”¨æˆ·äº‹ä»¶**ã€‚ï¼ˆç”¨æˆ·è§¦å‘çš„äº‹ä»¶ï¼Œé€šè¿‡äº‹ä»¶å‡½æ•°å¤„ç†ï¼‰

:::info

- **Effect æ˜¯ React èŒƒå¼ä¸­çš„ä¸€ç§è„±å›´æœºåˆ¶ã€‚å¤„ç†å‰¯ä½œç”¨çš„ï¼Œå¦‚æœæ²¡æœ‰å‰¯ä½œç”¨å°±ä¸åº”ç”¨ä½¿ç”¨ã€‚âœ…**
- **å°½å¯èƒ½åœ¨æ¸²æŸ“æœŸé—´è¿›è¡Œè®¡ç®—ï¼Œä»¥åŠåœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­è°ƒæ•´ state**ã€‚
  :::

#### æ ¹æ® props æˆ– state æ¥æ›´æ–° state

**å¦‚æœä¸€ä¸ªå€¼å¯ä»¥åŸºäºç°æœ‰çš„ props æˆ– state è®¡ç®—å¾—å‡ºï¼Œä¸è¦æŠŠå®ƒä½œä¸ºä¸€ä¸ª stateï¼Œè€Œæ˜¯åœ¨æ¸²æŸ“æœŸé—´ç›´æ¥è®¡ç®—è¿™ä¸ªå€¼ã€‚** ï¼ˆå‡½æ•°æ€ç»´ âœ…ï¼‰ï¼ˆä¹Ÿç®—æ˜¯è®¡ç®—å±æ€§ï¼Œä½†æ¯æ¬¡éƒ½è®¡ç®—ï¼‰

#### ç¼“å­˜æ˜‚è´µçš„è®¡ç®—

```js
function TodoList({ todos, filter }) {
  const [newTodo, setNewTodo] = useState("");

  // ğŸ”´ é¿å…ï¼šå¤šä½™çš„ state å’Œä¸å¿…è¦çš„ Effect
  const [visibleTodos, setVisibleTodos] = useState([]);
  useEffect(() => {
    setVisibleTodos(getFilteredTodos(todos, filter));
  }, [todos, filter]);

  // ...
}
```

å°±åƒä¹‹å‰çš„ä¾‹å­ä¸€æ ·ï¼Œè¿™æ—¢æ²¡æœ‰å¿…è¦ï¼Œä¹Ÿå¾ˆä½æ•ˆã€‚é¦–å…ˆï¼Œç§»é™¤ state å’Œ Effectï¼š

```js
function TodoList({ todos, filter }) {
  const [newTodo, setNewTodo] = useState("");
  // âœ… å¦‚æœ getFilteredTodos() çš„è€—æ—¶ä¸é•¿ï¼Œè¿™æ ·å†™å°±å¯ä»¥äº†ã€‚
  const visibleTodos = getFilteredTodos(todos, filter);
  // ...
}
```

å¦‚æœï¼ŒgetFilteredTodos() çš„è€—æ—¶å¯èƒ½ä¼šå¾ˆé•¿ï¼Œå¯ä»¥ä½¿ç”¨ useMemo Hook ç¼“å­˜ï¼Œè¿™ä¼šå‘Šè¯‰ Reactï¼Œé™¤é todos æˆ– filter å‘ç”Ÿå˜åŒ–ï¼Œå¦åˆ™ä¸è¦é‡æ–°æ‰§è¡Œä¼ å…¥çš„å‡½æ•°ã€‚

```js
import { useMemo, useState } from "react";

function TodoList({ todos, filter }) {
  const [newTodo, setNewTodo] = useState("");
  const visibleTodos = useMemo(() => {
    // âœ… é™¤é todos æˆ– filter å‘ç”Ÿå˜åŒ–ï¼Œå¦åˆ™ä¸ä¼šé‡æ–°æ‰§è¡Œ
    return getFilteredTodos(todos, filter);
  }, [todos, filter]);
  // ...
}
```

å¦‚ä½•åˆ¤æ–­è®¡ç®—æ˜¯æ˜‚è´µçš„ï¼Ÿhttps://zh-hans.react.dev/learn/you-might-not-need-an-effect#how-to-tell-if-a-calculation-is-expensive

#### å½“ props å˜åŒ–æ—¶é‡ç½®æ‰€æœ‰ state

åœ¨ userId å˜åŒ–æ—¶ï¼Œæ¸…é™¤ comment å˜é‡ï¼š

```js
export default function ProfilePage({ userId }) {
  const [comment, setComment] = useState("");

  // ğŸ”´ é¿å…ï¼šå½“ prop å˜åŒ–æ—¶ï¼Œåœ¨ Effect ä¸­é‡ç½® state
  useEffect(() => {
    setComment("");
  }, [userId]);
  // ...
}
```

å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œä½ å¯ä»¥é€šè¿‡ä¸ºæ¯ä¸ªç”¨æˆ·çš„ä¸ªäººèµ„æ–™ç»„ä»¶æä¾›ä¸€ä¸ªæ˜ç¡®çš„é”®æ¥å‘Šè¯‰ React å®ƒä»¬åŸåˆ™ä¸Šæ˜¯ ä¸åŒ çš„ä¸ªäººèµ„æ–™ç»„ä»¶ã€‚å°†ä½ çš„ç»„ä»¶æ‹†åˆ†ä¸ºä¸¤ä¸ªç»„ä»¶ï¼Œå¹¶ä»å¤–éƒ¨çš„ç»„ä»¶ä¼ é€’ä¸€ä¸ª key å±æ€§ç»™å†…éƒ¨çš„ç»„ä»¶ï¼š

```js
export default function ProfilePage({ userId }) {
  return <Profile userId={userId} key={userId} />;
}

function Profile({ userId }) {
  // âœ… å½“ key å˜åŒ–æ—¶ï¼Œè¯¥ç»„ä»¶å†…çš„ comment æˆ–å…¶ä»– state ä¼šè‡ªåŠ¨è¢«é‡ç½®
  const [comment, setComment] = useState("");
  // ...
}
```

é€šå¸¸ï¼Œå½“åœ¨ç›¸åŒçš„ä½ç½®æ¸²æŸ“ç›¸åŒçš„ç»„ä»¶æ—¶ï¼ŒReact ä¼šä¿ç•™çŠ¶æ€ã€‚**é€šè¿‡å°† userId ä½œä¸º key ä¼ é€’ç»™ Profile ç»„ä»¶ï¼Œä½¿ React å°†å…·æœ‰ä¸åŒ userId çš„ä¸¤ä¸ª Profile ç»„ä»¶è§†ä¸ºä¸¤ä¸ªä¸åº”å…±äº«ä»»ä½•çŠ¶æ€çš„ä¸åŒç»„ä»¶**ã€‚æ¯å½“ keyï¼ˆè¿™é‡Œæ˜¯ userIdï¼‰å˜åŒ–æ—¶ï¼ŒReact å°†é‡æ–°åˆ›å»º DOMï¼Œå¹¶ é‡ç½® Profile ç»„ä»¶å’Œå®ƒçš„æ‰€æœ‰å­ç»„ä»¶çš„ stateã€‚ç°åœ¨ï¼Œå½“åœ¨ä¸åŒçš„ä¸ªäººèµ„æ–™ä¹‹é—´å¯¼èˆªæ—¶ï¼Œcomment åŒºåŸŸå°†è‡ªåŠ¨è¢«æ¸…ç©ºã€‚

ï¼ˆè¿™å’Œ Vue è§£å†³é—®é¢˜æ€è·¯å®Œå…¨ä¸ä¸€æ ·ï¼ŒVue å¯èƒ½ç”¨ watch âœ…ï¼‰

#### \*å½“ prop å˜åŒ–æ—¶è°ƒæ•´éƒ¨åˆ† state

ï¼ˆè¿™ä¸ªåœºæ™¯å¾ˆå¥½ï¼Œå…¨æ–‡æ‘˜ä¸‹æ¥äº†ï¼‰

æœ‰æ—¶å€™ï¼Œå½“ prop å˜åŒ–æ—¶ï¼Œä½ å¯èƒ½åªæƒ³é‡ç½®æˆ–è°ƒæ•´éƒ¨åˆ† state ï¼Œè€Œä¸æ˜¯æ‰€æœ‰ stateã€‚

List ç»„ä»¶æ¥æ”¶ä¸€ä¸ª items åˆ—è¡¨ä½œä¸º propï¼Œç„¶åç”¨ state å˜é‡ selection æ¥ä¿æŒå·²é€‰ä¸­çš„é¡¹ã€‚å½“ items æ¥æ”¶åˆ°ä¸€ä¸ªä¸åŒçš„æ•°ç»„æ—¶ï¼Œä½ æƒ³å°† selection é‡ç½®ä¸º nullï¼š

```js
function List({ items }) {
  const [isReverse, setIsReverse] = useState(false);
  const [selection, setSelection] = useState(null);

  // ğŸ”´ é¿å…ï¼šå½“ prop å˜åŒ–æ—¶ï¼Œåœ¨ Effect ä¸­è°ƒæ•´ state
  useEffect(() => {
    setSelection(null);
  }, [items]);
  // ...
}
```

è¿™ä¸å¤ªç†æƒ³ã€‚æ¯å½“ items å˜åŒ–æ—¶ï¼ŒList åŠå…¶å­ç»„ä»¶ä¼šå…ˆä½¿ç”¨æ—§çš„ selection å€¼æ¸²æŸ“ã€‚ç„¶å React ä¼šæ›´æ–° DOM å¹¶æ‰§è¡Œ Effectã€‚æœ€åï¼Œ**è°ƒç”¨ setSelection(null) å°†å¯¼è‡´ List åŠå…¶å­ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œé‡æ–°å¯åŠ¨æ•´ä¸ªæµç¨‹**ã€‚

è®©æˆ‘ä»¬ä»åˆ é™¤ Effect å¼€å§‹ã€‚å–è€Œä»£ä¹‹çš„æ˜¯åœ¨æ¸²æŸ“æœŸé—´ç›´æ¥è°ƒæ•´ stateï¼š

```js
function List({ items }) {
  const [isReverse, setIsReverse] = useState(false);
  const [selection, setSelection] = useState(null);

  // å¥½ä¸€äº›ï¼šåœ¨æ¸²æŸ“æœŸé—´è°ƒæ•´ state
  const [prevItems, setPrevItems] = useState(items);
  if (items !== prevItems) {
    setPrevItems(items);
    setSelection(null);
  }
  // ...
}
```

åƒè¿™æ · å­˜å‚¨å‰åºæ¸²æŸ“çš„ä¿¡æ¯ å¯èƒ½å¾ˆéš¾ç†è§£ï¼Œä½†å®ƒæ¯”åœ¨ Effect ä¸­æ›´æ–°è¿™ä¸ª state è¦å¥½ã€‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œåœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ç›´æ¥è°ƒç”¨äº† setSelectionã€‚å½“å®ƒæ‰§è¡Œåˆ° return è¯­å¥é€€å‡ºåï¼ŒReact å°† ç«‹å³ é‡æ–°æ¸²æŸ“ Listã€‚æ­¤æ—¶ React è¿˜æ²¡æœ‰æ¸²æŸ“ List çš„å­ç»„ä»¶æˆ–æ›´æ–° DOMï¼Œè¿™ä½¿å¾— List çš„å­ç»„ä»¶å¯ä»¥è·³è¿‡æ¸²æŸ“æ—§çš„ selection å€¼ã€‚ï¼ˆè¿™ä¸ªæ–¹æ¡ˆæ˜¯åœ¨æ¸²æŸ“æœŸé—´æ›´æ–° stateï¼‰

åœ¨æ¸²æŸ“æœŸé—´æ›´æ–°ç»„ä»¶æ—¶ï¼ŒReact ä¼šä¸¢å¼ƒå·²ç»è¿”å›çš„ JSX å¹¶ç«‹å³å°è¯•é‡æ–°æ¸²æŸ“ã€‚ä¸ºäº†é¿å…éå¸¸ç¼“æ…¢çš„çº§è”é‡è¯•ï¼ŒReact åªå…è®¸åœ¨æ¸²æŸ“æœŸé—´æ›´æ–° åŒä¸€ ç»„ä»¶çš„çŠ¶æ€ã€‚å¦‚æœä½ åœ¨æ¸²æŸ“æœŸé—´æ›´æ–°å¦ä¸€ä¸ªç»„ä»¶çš„çŠ¶æ€ï¼Œä½ ä¼šçœ‹åˆ°ä¸€æ¡æŠ¥é”™ä¿¡æ¯ã€‚æ¡ä»¶åˆ¤æ–­ items !== prevItems æ˜¯å¿…è¦çš„ï¼Œå®ƒå¯ä»¥é¿å…æ— é™å¾ªç¯ã€‚ä½ å¯ä»¥åƒè¿™æ ·è°ƒæ•´ stateï¼Œä½†ä»»ä½•å…¶ä»–å‰¯ä½œç”¨ï¼ˆæ¯”å¦‚å˜åŒ– DOM æˆ–è®¾ç½®çš„å»¶æ—¶ï¼‰åº”è¯¥ç•™åœ¨äº‹ä»¶å¤„ç†å‡½æ•°æˆ– Effect ä¸­ï¼Œä»¥ ä¿æŒç»„ä»¶çº¯ç²¹ã€‚ï¼ˆ**æ¸²æŸ“æœŸé—´æ›´æ–° stateï¼Œä¸å¥½** âœ…ï¼‰

è™½ç„¶è¿™ç§æ–¹å¼æ¯” Effect æ›´é«˜æ•ˆï¼Œä½†å¤§å¤šæ•°ç»„ä»¶ä¹Ÿä¸éœ€è¦å®ƒã€‚**æ— è®ºä½ æ€ä¹ˆåšï¼Œæ ¹æ® props æˆ–å…¶ä»– state æ¥è°ƒæ•´ state éƒ½ä¼šä½¿æ•°æ®æµæ›´éš¾ç†è§£å’Œè°ƒè¯•**ã€‚**æ€»æ˜¯æ£€æŸ¥æ˜¯å¦å¯ä»¥é€šè¿‡æ·»åŠ  key æ¥é‡ç½®æ‰€æœ‰ stateï¼Œæˆ–è€… åœ¨æ¸²æŸ“æœŸé—´è®¡ç®—æ‰€éœ€å†…å®¹**ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥å­˜å‚¨å·²é€‰ä¸­çš„ item ID è€Œä¸æ˜¯å­˜å‚¨ï¼ˆå¹¶é‡ç½®ï¼‰å·²é€‰ä¸­çš„ itemï¼š

```js
function List({ items }) {
  const [isReverse, setIsReverse] = useState(false);
  const [selectedId, setSelectedId] = useState(null);
  // âœ… éå¸¸å¥½ï¼šåœ¨æ¸²æŸ“æœŸé—´è®¡ç®—æ‰€éœ€å†…å®¹
  const selection = items.find((item) => item.id === selectedId) ?? null;
  // ...
}
```

ç°åœ¨å®Œå…¨ä¸éœ€è¦ â€œè°ƒæ•´â€ state äº†ã€‚å¦‚æœåŒ…å«å·²é€‰ä¸­ ID çš„é¡¹å‡ºç°åœ¨åˆ—è¡¨ä¸­ï¼Œåˆ™ä»ç„¶ä¿æŒé€‰ä¸­çŠ¶æ€ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é¡¹ï¼Œåˆ™åœ¨æ¸²æŸ“æœŸé—´è®¡ç®—çš„ selection å°†ä¼šæ˜¯ nullã€‚è¡Œä¸ºä¸åŒäº†ï¼Œä½†å¯ä»¥è¯´æ›´å¥½äº†ï¼Œå› ä¸ºå¤§å¤šæ•°å¯¹ items çš„æ›´æ”¹ä»å¯ä»¥ä¿æŒé€‰ä¸­çŠ¶æ€ã€‚ï¼ˆ**è¿˜è½¬æ¢ä¸º åœ¨æ¸²æŸ“æœŸé—´è®¡ç®—** âœ…ï¼‰

#### åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­å…±äº«é€»è¾‘

**å½“ä½ ä¸ç¡®å®šæŸäº›ä»£ç åº”è¯¥æ”¾åœ¨ Effect ä¸­è¿˜æ˜¯äº‹ä»¶å¤„ç†å‡½æ•°ä¸­æ—¶ï¼Œå…ˆè‡ªé—® ä¸ºä»€ä¹ˆ è¦æ‰§è¡Œè¿™äº›ä»£ç ã€‚Effect åªç”¨æ¥æ‰§è¡Œé‚£äº›æ˜¾ç¤ºç»™ç”¨æˆ·æ—¶ç»„ä»¶ éœ€è¦æ‰§è¡Œ çš„ä»£ç **ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œé€šçŸ¥åº”è¯¥åœ¨ç”¨æˆ· æŒ‰ä¸‹æŒ‰é’® åå‡ºç°ï¼Œè€Œä¸æ˜¯å› ä¸ºé¡µé¢æ˜¾ç¤ºå‡ºæ¥æ—¶ï¼åˆ é™¤ Effect å¹¶å°†å…±äº«çš„é€»è¾‘æ”¾å…¥ä¸€ä¸ªè¢«ä¸¤ä¸ªäº‹ä»¶å¤„ç†ç¨‹åºè°ƒç”¨çš„å‡½æ•°ä¸­ã€‚

#### å‘é€ POST è¯·æ±‚

å½“ä½ å†³å®šå°†æŸäº›é€»è¾‘æ”¾å…¥äº‹ä»¶å¤„ç†å‡½æ•°è¿˜æ˜¯ Effect ä¸­æ—¶ï¼Œä½ éœ€è¦å›ç­”çš„ä¸»è¦é—®é¢˜æ˜¯ï¼šä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹å®ƒæ˜¯ æ€æ ·çš„é€»è¾‘ã€‚å¦‚æœè¿™ä¸ªé€»è¾‘æ˜¯ç”±æŸä¸ªç‰¹å®šçš„äº¤äº’å¼•èµ·çš„ï¼Œè¯·å°†å®ƒä¿ç•™åœ¨ç›¸åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°ä¸­ã€‚å¦‚æœæ˜¯ç”±ç”¨æˆ·åœ¨å±å¹•ä¸Š çœ‹åˆ° ç»„ä»¶æ—¶å¼•èµ·çš„ï¼Œè¯·å°†å®ƒä¿ç•™åœ¨ Effect ä¸­ã€‚

```js
function Form() {
  const [firstName, setFirstName] = useState("");
  const [lastName, setLastName] = useState("");

  // âœ… éå¸¸å¥½ï¼šè¿™ä¸ªé€»è¾‘åº”è¯¥åœ¨ç»„ä»¶æ˜¾ç¤ºæ—¶æ‰§è¡Œ
  useEffect(() => {
    post("/analytics/event", { eventName: "visit_form" });
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    // âœ… éå¸¸å¥½ï¼šäº‹ä»¶ç‰¹å®šçš„é€»è¾‘åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­å¤„ç†
    post("/api/register", { firstName, lastName });
  }
  // ...
}
```

#### é“¾å¼è®¡ç®—

è¿™æ®µä»£ç é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ã€‚ï¼ˆä»£ç çœ‹æ–‡æ¡£å§ï¼‰

ä¸€ä¸ªé—®é¢˜æ˜¯å®ƒéå¸¸ä½æ•ˆï¼šåœ¨é“¾å¼çš„æ¯ä¸ª set è°ƒç”¨ä¹‹é—´ï¼Œç»„ä»¶ï¼ˆåŠå…¶å­ç»„ä»¶ï¼‰éƒ½ä¸å¾—ä¸é‡æ–°æ¸²æŸ“ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ**åœ¨æœ€åçš„æƒ…å†µä¸‹ï¼ˆsetCard â†’ æ¸²æŸ“ â†’ setGoldCardCount â†’ æ¸²æŸ“ â†’ setRound â†’ æ¸²æŸ“ â†’ setIsGameOver â†’ æ¸²æŸ“ï¼‰æœ‰ä¸‰æ¬¡ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“**ã€‚

å³ä½¿ä¸è€ƒè™‘æ¸²æŸ“æ•ˆç‡é—®é¢˜ï¼Œéšç€ä»£ç ä¸æ–­æ‰©å±•ï¼Œä½ ä¼šé‡åˆ°è¿™æ¡ â€œé“¾å¼â€ è°ƒç”¨ä¸ç¬¦åˆæ–°éœ€æ±‚çš„æƒ…å†µã€‚

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ›´å¥½çš„åšæ³•æ˜¯ï¼š**å°½å¯èƒ½åœ¨æ¸²æŸ“æœŸé—´è¿›è¡Œè®¡ç®—ï¼Œä»¥åŠåœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­è°ƒæ•´ state**âœ…ï¼š

```js
function Game() {
  const [card, setCard] = useState(null);
  const [goldCardCount, setGoldCardCount] = useState(0);
  const [round, setRound] = useState(1);

  // âœ… å°½å¯èƒ½åœ¨æ¸²æŸ“æœŸé—´è¿›è¡Œè®¡ç®—
  const isGameOver = round > 5;

  function handlePlaceCard(nextCard) {
    if (isGameOver) {
      throw Error('æ¸¸æˆå·²ç»ç»“æŸäº†ã€‚');
    }

    // âœ… åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­è®¡ç®—å‰©ä¸‹çš„æ‰€æœ‰ state
    setCard(nextCard);
    if (nextCard.gold) {
      if (goldCardCount <= 3) {
        setGoldCardCount(goldCardCount + 1);
      } else {
        setGoldCardCount(0);
        setRound(round + 1);
        if (round === 5) {
          alert('æ¸¸æˆç»“æŸï¼');
        }
      }
    }
  }

  // ...
```

#### åˆå§‹åŒ–åº”ç”¨

æ³¨æ„ï¼šå¼€å‘ç¯å¢ƒä¼šæ‰§è¡Œä¸¤æ¬¡ã€‚

#### é€šçŸ¥çˆ¶ç»„ä»¶æœ‰å…³ state å˜åŒ–çš„ä¿¡æ¯

ï¼ˆä»£ç çœ‹æ–‡æ¡£å§ï¼‰

å’Œä¹‹å‰ä¸€æ ·ï¼Œè¿™ä¸å¤ªç†æƒ³ã€‚Toggle é¦–å…ˆæ›´æ–°å®ƒçš„ stateï¼Œç„¶å React ä¼šæ›´æ–°å±å¹•ã€‚ç„¶å React æ‰§è¡Œ Effect ä¸­çš„ä»£ç ï¼Œè°ƒç”¨ä»çˆ¶ç»„ä»¶ä¼ å…¥çš„ onChange å‡½æ•°ã€‚ç°åœ¨çˆ¶ç»„ä»¶å¼€å§‹æ›´æ–°å®ƒè‡ªå·±çš„ stateï¼Œå¼€å¯å¦ä¸€ä¸ªæ¸²æŸ“æµç¨‹ã€‚æ›´å¥½çš„æ–¹å¼æ˜¯åœ¨å•ä¸ªæµç¨‹ä¸­å®Œæˆæ‰€æœ‰æ“ä½œã€‚

åˆ é™¤ Effectï¼Œå¹¶åœ¨åŒä¸€ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ä¸­æ›´æ–° ä¸¤ä¸ª ç»„ä»¶çš„ stateã€‚

**é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒToggle ç»„ä»¶åŠå…¶çˆ¶ç»„ä»¶éƒ½åœ¨äº‹ä»¶å¤„ç†æœŸé—´æ›´æ–°äº†å„è‡ªçš„ stateã€‚React ä¼š æ‰¹é‡ å¤„ç†æ¥è‡ªä¸åŒç»„ä»¶çš„æ›´æ–°ï¼Œæ‰€ä»¥åªä¼šæœ‰ä¸€ä¸ªæ¸²æŸ“æµç¨‹**ã€‚

ä½ ä¹Ÿå¯ä»¥å®Œå…¨ç§»é™¤è¯¥ stateï¼Œå¹¶ä»çˆ¶ç»„ä»¶ä¸­æ¥æ”¶ isOnã€‚â€œçŠ¶æ€æå‡â€ å…è®¸çˆ¶ç»„ä»¶é€šè¿‡åˆ‡æ¢è‡ªèº«çš„ state æ¥å®Œå…¨æ§åˆ¶ Toggle ç»„ä»¶ã€‚

#### å°†æ•°æ®ä¼ é€’ç»™çˆ¶ç»„ä»¶

å½“å­ç»„ä»¶åœ¨ Effect ä¸­æ›´æ–°å…¶çˆ¶ç»„ä»¶çš„ state æ—¶ï¼Œæ•°æ®æµå˜å¾—éå¸¸éš¾ä»¥è¿½è¸ªã€‚æ—¢ç„¶å­ç»„ä»¶å’Œçˆ¶ç»„ä»¶éƒ½éœ€è¦ç›¸åŒçš„æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥è®©çˆ¶ç»„ä»¶è·å–é‚£äº›æ•°æ®ï¼Œå¹¶å°†å…¶ å‘ä¸‹ä¼ é€’ ç»™å­ç»„ä»¶ã€‚

è¿™æ›´ç®€å•ï¼Œå¹¶ä¸”å¯ä»¥ä¿æŒæ•°æ®æµçš„å¯é¢„æµ‹æ€§ï¼šæ•°æ®ä»çˆ¶ç»„ä»¶æµå‘å­ç»„ä»¶ã€‚

#### è®¢é˜…å¤–éƒ¨ store

https://zh-hans.react.dev/reference/react/useSyncExternalStore

#### è·å–æ•°æ®

è®¸å¤šåº”ç”¨ä½¿ç”¨ Effect æ¥å‘èµ·æ•°æ®è·å–è¯·æ±‚ã€‚åƒè¿™æ ·åœ¨ Effect ä¸­å†™ä¸€ä¸ªæ•°æ®è·å–è¯·æ±‚æ˜¯ç›¸å½“å¸¸è§çš„ï¼š

ä½  **ä¸éœ€è¦ æŠŠè¿™ä¸ªæ•°æ®è·å–é€»è¾‘è¿ç§»åˆ°ä¸€ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ä¸­**ã€‚

è¿™å¯èƒ½çœ‹èµ·æ¥ä¸ä¹‹å‰éœ€è¦å°†é€»è¾‘æ”¾å…¥äº‹ä»¶å¤„ç†å‡½æ•°ä¸­çš„ç¤ºä¾‹ç›¸çŸ›ç›¾ï¼ä½†æ˜¯ï¼Œ**è€ƒè™‘åˆ°è¿™å¹¶ä¸æ˜¯ é”®å…¥äº‹ä»¶**ï¼Œè¿™æ˜¯åœ¨è¿™é‡Œè·å–æ•°æ®çš„ä¸»è¦åŸå› ã€‚æœç´¢è¾“å…¥æ¡†çš„å€¼ç»å¸¸ä» URL ä¸­é¢„å¡«å……ï¼Œç”¨æˆ·å¯ä»¥åœ¨ä¸å…³å¿ƒè¾“å…¥æ¡†çš„æƒ…å†µä¸‹å¯¼èˆªåˆ°åé€€å’Œå‰è¿›é¡µé¢ã€‚

page å’Œ query çš„æ¥æºå…¶å®å¹¶ä¸é‡è¦ã€‚**åªè¦è¯¥ç»„ä»¶å¯è§ï¼Œä½ å°±éœ€è¦é€šè¿‡å½“å‰ page å’Œ query çš„å€¼ï¼Œä¿æŒ results å’Œç½‘ç»œæ•°æ®çš„ åŒæ­¥ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™é‡Œæ˜¯ä¸€ä¸ª Effect çš„åŸå› **ã€‚

ç„¶è€Œï¼Œä¸Šé¢çš„ä»£ç æœ‰ä¸€ä¸ªé—®é¢˜ã€‚å‡è®¾ä½ å¿«é€Ÿåœ°è¾“å…¥ â€œhelloâ€ã€‚é‚£ä¹ˆ query ä¼šä» â€œhâ€ å˜æˆ â€œheâ€ï¼Œâ€œhelâ€ï¼Œâ€œhellâ€ æœ€åæ˜¯ â€œhelloâ€ã€‚è¿™ä¼šè§¦å‘ä¸€è¿ä¸²ä¸åŒçš„æ•°æ®è·å–è¯·æ±‚ï¼Œä½†æ— æ³•ä¿è¯å¯¹åº”çš„è¿”å›é¡ºåºã€‚ä¾‹å¦‚ï¼Œâ€œhellâ€ çš„å“åº”å¯èƒ½åœ¨ â€œhelloâ€ çš„å“åº” ä¹‹å è¿”å›ã€‚ç”±äºå®ƒçš„ setResults() æ˜¯åœ¨æœ€åè¢«è°ƒç”¨çš„ï¼Œä½ å°†ä¼šæ˜¾ç¤ºé”™è¯¯çš„æœç´¢ç»“æœã€‚è¿™ç§æƒ…å†µè¢«ç§°ä¸º â€œç«æ€æ¡ä»¶â€ï¼šä¸¤ä¸ªä¸åŒçš„è¯·æ±‚ â€œç›¸äº’ç«äº‰â€ï¼Œå¹¶ä»¥ä¸ä½ é¢„æœŸä¸ç¬¦çš„é¡ºåºè¿”å›ã€‚

**ä¸ºäº†ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œä½ éœ€è¦æ·»åŠ ä¸€ä¸ª æ¸…ç†å‡½æ•° æ¥å¿½ç•¥è¾ƒæ—©çš„è¿”å›ç»“æœ**ï¼š

```js
function SearchResults({ query }) {
  const [results, setResults] = useState([]);
  const [page, setPage] = useState(1);
  useEffect(() => {
    let ignore = false;
    fetchResults(query, page).then((json) => {
      if (!ignore) {
        setResults(json);
      }
    });
    return () => {
      ignore = true; // é€šå¸¸é€šè¿‡ å¿½ç•¥å…¶ç»“æœ çš„æ–¹å¼ï¼Œæ¸…é™¤çŠ¶æ€æ•°æ®èµ‹å€¼âœ…
    };
  }, [query, page]);

  function handleNextPageClick() {
    setPage(page + 1);
  }
  // ...
}
```

è¿™ç¡®ä¿äº†å½“ä½ åœ¨ Effect ä¸­è·å–æ•°æ®æ—¶ï¼Œ**é™¤äº†æœ€åä¸€æ¬¡è¯·æ±‚çš„æ‰€æœ‰è¿”å›ç»“æœéƒ½å°†è¢«å¿½ç•¥**ã€‚

å¤„ç†ç«æ€æ¡ä»¶å¹¶ä¸æ˜¯å®ç°æ•°æ®è·å–çš„å”¯ä¸€éš¾ç‚¹ã€‚ä½ å¯èƒ½è¿˜éœ€è¦è€ƒè™‘ç¼“å­˜å“åº”ç»“æœï¼ˆä½¿ç”¨æˆ·ç‚¹å‡»åé€€æŒ‰é’®æ—¶å¯ä»¥ç«‹å³çœ‹åˆ°å…ˆå‰çš„å±å¹•å†…å®¹ï¼‰ï¼Œå¦‚ä½•åœ¨æœåŠ¡ç«¯è·å–æ•°æ®ï¼ˆä½¿æœåŠ¡ç«¯åˆå§‹æ¸²æŸ“çš„ HTML ä¸­åŒ…å«è·å–åˆ°çš„å†…å®¹è€Œä¸æ˜¯åŠ è½½åŠ¨ç”»ï¼‰ï¼Œä»¥åŠå¦‚ä½•é¿å…ç½‘ç»œç€‘å¸ƒï¼ˆä½¿å­ç»„ä»¶ä¸å¿…ç­‰å¾…æ¯ä¸ªçˆ¶ç»„ä»¶çš„æ•°æ®è·å–å®Œæ¯•åæ‰å¼€å§‹è·å–æ•°æ®ï¼‰ã€‚

è¿™äº›é—®é¢˜é€‚ç”¨äºä»»ä½• UI åº“ï¼Œè€Œä¸ä»…ä»…æ˜¯ Reactã€‚è§£å†³è¿™äº›é—®é¢˜å¹¶ä¸å®¹æ˜“ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç°ä»£ æ¡†æ¶ æä¾›äº†æ¯”åœ¨ Effect ä¸­è·å–æ•°æ®æ›´æœ‰æ•ˆçš„å†…ç½®æ•°æ®è·å–æœºåˆ¶çš„åŸå› ã€‚

å¦‚æœä½ ä¸ä½¿ç”¨æ¡†æ¶ï¼ˆä¹Ÿä¸æƒ³å¼€å‘è‡ªå·±çš„æ¡†æ¶ï¼‰ï¼Œä½†å¸Œæœ›ä½¿ä» Effect ä¸­è·å–æ•°æ®æ›´ç¬¦åˆäººç±»ç›´è§‰ï¼Œè¯·è€ƒè™‘åƒè¿™ä¸ªä¾‹å­ä¸€æ ·ï¼Œå°†è·å–é€»è¾‘æå–åˆ°ä¸€ä¸ªè‡ªå®šä¹‰ Hook ä¸­ï¼š

```js
function SearchResults({ query }) {
  const [page, setPage] = useState(1);
  const params = new URLSearchParams({ query, page });
  const results = useData(`/api/search?${params}`);

  function handleNextPageClick() {
    setPage(page + 1);
  }
  // ...
}

function useData(url) {
  const [data, setData] = useState(null);
  useEffect(() => {
    let ignore = false;
    fetch(url)
      .then((response) => response.json())
      .then((json) => {
        if (!ignore) {
          setData(json);
        }
      });
    return () => {
      ignore = true;
    };
  }, [url]);
  return data;
}
```

ä½ å¯èƒ½è¿˜æƒ³æ·»åŠ ä¸€äº›é”™è¯¯å¤„ç†é€»è¾‘ä»¥åŠè·Ÿè¸ªå†…å®¹æ˜¯å¦å¤„äºåŠ è½½ä¸­ã€‚ä½ å¯ä»¥è‡ªå·±ç¼–å†™è¿™æ ·çš„ Hookï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ React ç”Ÿæ€ä¸­å·²ç»å­˜åœ¨çš„è®¸å¤šè§£å†³æ–¹æ¡ˆã€‚è™½ç„¶ä»…ä»…ä½¿ç”¨è‡ªå®šä¹‰ Hook ä¸å¦‚ä½¿ç”¨æ¡†æ¶å†…ç½®çš„æ•°æ®è·å–æœºåˆ¶é«˜æ•ˆï¼Œä½†å°†æ•°æ®è·å–é€»è¾‘ç§»åŠ¨åˆ°è‡ªå®šä¹‰ Hook ä¸­å°†ä½¿åç»­é‡‡ç”¨é«˜æ•ˆçš„æ•°æ®è·å–ç­–ç•¥æ›´åŠ å®¹æ˜“ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œå½“ä½ ä¸å¾—ä¸ç¼–å†™ Effect æ—¶ï¼Œè¯·ç•™æ„æ˜¯å¦å¯ä»¥å°†æŸæ®µåŠŸèƒ½æå–åˆ°ä¸“é—¨çš„å†…ç½® API æˆ–ä¸€ä¸ªæ›´å…·å£°æ˜æ€§çš„è‡ªå®šä¹‰ Hook ä¸­ï¼Œæ¯”å¦‚ä¸Šé¢çš„ useDataã€‚ä½ ä¼šå‘ç°ç»„ä»¶ä¸­çš„åŸå§‹ useEffect è°ƒç”¨è¶Šå°‘ï¼Œç»´æŠ¤åº”ç”¨å°†å˜å¾—æ›´åŠ å®¹æ˜“ã€‚

#### æ‘˜è¦

- å¦‚æœä½ å¯ä»¥åœ¨æ¸²æŸ“æœŸé—´è®¡ç®—æŸäº›å†…å®¹ï¼Œåˆ™ä¸éœ€è¦ä½¿ç”¨ Effectã€‚
- æƒ³è¦ç¼“å­˜æ˜‚è´µçš„è®¡ç®—ï¼Œè¯·ä½¿ç”¨ useMemo è€Œä¸æ˜¯ useEffectã€‚
- æƒ³è¦é‡ç½®æ•´ä¸ªç»„ä»¶æ ‘çš„ stateï¼Œè¯·ä¼ å…¥ä¸åŒçš„ keyã€‚
- æƒ³è¦åœ¨ prop å˜åŒ–æ—¶é‡ç½®æŸäº›ç‰¹å®šçš„ stateï¼Œè¯·åœ¨æ¸²æŸ“æœŸé—´å¤„ç†ã€‚
- ç»„ä»¶ æ˜¾ç¤º æ—¶å°±éœ€è¦æ‰§è¡Œçš„ä»£ç åº”è¯¥æ”¾åœ¨ Effect ä¸­ï¼Œå¦åˆ™åº”è¯¥æ”¾åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­ã€‚
- å¦‚æœä½ éœ€è¦æ›´æ–°å¤šä¸ªç»„ä»¶çš„ stateï¼Œæœ€å¥½åœ¨å•ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ä¸­å¤„ç†ã€‚
- å½“ä½ å°è¯•åœ¨ä¸åŒç»„ä»¶ä¸­åŒæ­¥ state å˜é‡æ—¶ï¼Œè¯·è€ƒè™‘çŠ¶æ€æå‡ã€‚
- ä½ å¯ä»¥ä½¿ç”¨ Effect è·å–æ•°æ®ï¼Œä½†ä½ éœ€è¦å®ç°æ¸…é™¤é€»è¾‘ä»¥é¿å…ç«æ€æ¡ä»¶ã€‚

## å“åº”å¼ Effect çš„ç”Ÿå‘½å‘¨æœŸ

**Effect ä¸ç»„ä»¶æœ‰ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸã€‚ç»„ä»¶å¯ä»¥æŒ‚è½½ã€æ›´æ–°æˆ–å¸è½½ã€‚Effect åªèƒ½åšä¸¤ä»¶äº‹ï¼šå¼€å§‹åŒæ­¥æŸäº›ä¸œè¥¿ï¼Œç„¶ååœæ­¢åŒæ­¥å®ƒã€‚å¦‚æœ Effect ä¾èµ–äºéšæ—¶é—´å˜åŒ–çš„ props å’Œ stateï¼Œè¿™ä¸ªå¾ªç¯å¯èƒ½ä¼šå‘ç”Ÿå¤šæ¬¡** ã€‚ï¼ˆEffect æ ¸å¿ƒè¿è¡Œè§„åˆ™ âœ…ï¼‰

### Effect çš„ç”Ÿå‘½å‘¨æœŸ

æ¯ä¸ª React ç»„ä»¶éƒ½ç»å†ç›¸åŒçš„ç”Ÿå‘½å‘¨æœŸï¼š

- å½“ç»„ä»¶è¢«æ·»åŠ åˆ°å±å¹•ä¸Šæ—¶ï¼Œå®ƒä¼šè¿›è¡Œç»„ä»¶çš„ æŒ‚è½½ã€‚
- å½“ç»„ä»¶æ¥æ”¶åˆ°æ–°çš„ props æˆ– state æ—¶ï¼Œé€šå¸¸æ˜¯ä½œä¸ºå¯¹äº¤äº’çš„å“åº”ï¼Œå®ƒä¼šè¿›è¡Œç»„ä»¶çš„ æ›´æ–°ã€‚
- å½“ç»„ä»¶ä»å±å¹•ä¸Šç§»é™¤æ—¶ï¼Œå®ƒä¼šè¿›è¡Œç»„ä»¶çš„ å¸è½½ã€‚

**è¿™æ˜¯ä¸€ç§å¾ˆå¥½çš„æ€è€ƒç»„ä»¶çš„æ–¹å¼ï¼Œä½†å¹¶ä¸é€‚ç”¨äº Effectã€‚ç›¸åï¼Œå°è¯•ä»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸä¸­è·³è„±å‡ºæ¥ï¼Œç‹¬ç«‹æ€è€ƒ Effectã€‚Effect æè¿°äº†å¦‚ä½•å°†å¤–éƒ¨ç³»ç»Ÿä¸å½“å‰çš„ props å’Œ state åŒæ­¥**âœ…ã€‚éšç€ä»£ç çš„å˜åŒ–ï¼ŒåŒæ­¥çš„é¢‘ç‡å¯èƒ½ä¼šå¢åŠ æˆ–å‡å°‘ã€‚

ä½ å¯èƒ½ä¼šç›´è§‚åœ°è®¤ä¸ºå½“ç»„ä»¶æŒ‚è½½æ—¶ React ä¼š å¼€å§‹åŒæ­¥ï¼Œè€Œå½“ç»„ä»¶å¸è½½æ—¶ä¼š åœæ­¢åŒæ­¥ã€‚ç„¶è€Œï¼Œäº‹æƒ…å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼æœ‰æ—¶ï¼Œåœ¨ç»„ä»¶ä¿æŒæŒ‚è½½çŠ¶æ€çš„åŒæ—¶ï¼Œ**å¯èƒ½è¿˜éœ€è¦ å¤šæ¬¡å¼€å§‹å’Œåœæ­¢åŒæ­¥**ã€‚

è®©æˆ‘ä»¬æ¥çœ‹çœ‹ ä¸ºä»€ä¹ˆ è¿™æ˜¯å¿…è¦çš„ã€ä½•æ—¶ ä¼šå‘ç”Ÿä»¥åŠ å¦‚ä½• æ§åˆ¶è¿™ç§è¡Œä¸ºã€‚

#### ä¸ºä»€ä¹ˆåŒæ­¥å¯èƒ½éœ€è¦å¤šæ¬¡è¿›è¡Œ

#### React å¦‚ä½•é‡æ–°åŒæ­¥ Effect

#### ä» Effect çš„è§’åº¦æ€è€ƒ

è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä» ChatRoom ç»„ä»¶çš„è§’åº¦æ‰€å‘ç”Ÿçš„ä¸€åˆ‡ï¼š

1. ChatRoom ç»„ä»¶æŒ‚è½½ï¼ŒroomId è®¾ç½®ä¸º "general"
2. ChatRoom ç»„ä»¶æ›´æ–°ï¼ŒroomId è®¾ç½®ä¸º "travel"
3. ChatRoom ç»„ä»¶æ›´æ–°ï¼ŒroomId è®¾ç½®ä¸º "music"
4. ChatRoom ç»„ä»¶å¸è½½

åœ¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„æ¯ä¸ªé˜¶æ®µï¼ŒEffect æ‰§è¡Œäº†ä¸åŒçš„æ“ä½œï¼š

1. Effect è¿æ¥åˆ°äº† "general" èŠå¤©å®¤
2. Effect æ–­å¼€äº†ä¸ "general" èŠå¤©å®¤çš„è¿æ¥ï¼Œå¹¶è¿æ¥åˆ°äº† "travel" èŠå¤©å®¤
3. Effect æ–­å¼€äº†ä¸ "travel" èŠå¤©å®¤çš„è¿æ¥ï¼Œå¹¶è¿æ¥åˆ°äº† "music" èŠå¤©å®¤
4. Effect æ–­å¼€äº†ä¸ "music" èŠå¤©å®¤çš„è¿æ¥

ç°åœ¨è®©æˆ‘ä»¬ä» Effect æœ¬èº«çš„è§’åº¦æ¥æ€è€ƒæ‰€å‘ç”Ÿçš„äº‹æƒ…ï¼š

```js
useEffect(() => {
  // Effect è¿æ¥åˆ°äº†é€šè¿‡ roomId æŒ‡å®šçš„èŠå¤©å®¤...
  const connection = createConnection(serverUrl, roomId);
  connection.connect();
  return () => {
    // ...ç›´åˆ°å®ƒæ–­å¼€è¿æ¥
    connection.disconnect();
  };
}, [roomId]);
```

è¿™æ®µä»£ç çš„ç»“æ„å¯èƒ½ä¼šå°†æ‰€å‘ç”Ÿçš„äº‹æƒ…çœ‹ä½œæ˜¯ä¸€ç³»åˆ—ä¸é‡å çš„æ—¶é—´æ®µï¼š

1. Effect è¿æ¥åˆ°äº† "general" èŠå¤©å®¤ï¼ˆç›´åˆ°æ–­å¼€è¿æ¥ï¼‰
2. Effect è¿æ¥åˆ°äº† "travel" èŠå¤©å®¤ï¼ˆç›´åˆ°æ–­å¼€è¿æ¥ï¼‰
3. Effect è¿æ¥åˆ°äº† "music" èŠå¤©å®¤ï¼ˆç›´åˆ°æ–­å¼€è¿æ¥ï¼‰

**ä¹‹å‰ï¼Œä½ æ˜¯ä»ç»„ä»¶çš„è§’åº¦æ€è€ƒçš„ã€‚å½“ä½ ä»ç»„ä»¶çš„è§’åº¦æ€è€ƒæ—¶ï¼Œå¾ˆå®¹æ˜“å°† Effect è§†ä¸ºåœ¨ç‰¹å®šæ—¶é—´ç‚¹è§¦å‘çš„â€œå›è°ƒå‡½æ•°â€æˆ–â€œç”Ÿå‘½å‘¨æœŸäº‹ä»¶â€ï¼Œä¾‹å¦‚â€œæ¸²æŸ“åâ€æˆ–â€œå¸è½½å‰â€ã€‚è¿™ç§æ€ç»´æ–¹å¼å¾ˆå¿«å˜å¾—å¤æ‚ï¼Œæ‰€ä»¥æœ€å¥½é¿å…ä½¿ç”¨**ã€‚

**ç›¸åï¼Œå§‹ç»ˆä¸“æ³¨äºå•ä¸ªå¯åŠ¨/åœæ­¢å‘¨æœŸã€‚æ— è®ºç»„ä»¶æ˜¯æŒ‚è½½ã€æ›´æ–°è¿˜æ˜¯å¸è½½ï¼Œéƒ½ä¸åº”è¯¥æœ‰å½±å“ã€‚åªéœ€è¦æè¿°å¦‚ä½•å¼€å§‹åŒæ­¥å’Œå¦‚ä½•åœæ­¢ã€‚å¦‚æœåšå¾—å¥½ï¼ŒEffect å°†èƒ½å¤Ÿåœ¨éœ€è¦æ—¶å§‹ç»ˆå…·å¤‡å¯åŠ¨å’Œåœæ­¢çš„å¼¹æ€§**ã€‚âœ…

è¿™å¯èƒ½ä¼šè®©ä½ æƒ³èµ·å½“ç¼–å†™åˆ›å»º JSX çš„æ¸²æŸ“é€»è¾‘æ—¶ï¼Œå¹¶ä¸è€ƒè™‘ç»„ä»¶æ˜¯æŒ‚è½½è¿˜æ˜¯æ›´æ–°ã€‚æè¿°çš„æ˜¯åº”è¯¥æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å†…å®¹ï¼Œè€Œ React ä¼š è§£å†³å…¶ä½™çš„é—®é¢˜ã€‚

#### React å¦‚ä½•éªŒè¯ Effect å¯ä»¥é‡æ–°è¿›è¡ŒåŒæ­¥

**React é€šè¿‡åœ¨å¼€å‘ç¯å¢ƒä¸­ç«‹å³å¼ºåˆ¶ Effect é‡æ–°è¿›è¡ŒåŒæ­¥æ¥éªŒè¯å…¶æ˜¯å¦èƒ½å¤Ÿé‡æ–°åŒæ­¥ã€‚è¿™å¯èƒ½è®©ä½ æƒ³èµ·æ‰“å¼€é—¨å¹¶é¢å¤–å…³é—­å®ƒä»¥æ£€æŸ¥é—¨é”æ˜¯å¦æœ‰æ•ˆçš„æƒ…æ™¯ã€‚React åœ¨å¼€å‘ç¯å¢ƒä¸­é¢å¤–å¯åŠ¨å’Œåœæ­¢ Effect ä¸€æ¬¡ï¼Œä»¥æ£€æŸ¥ æ˜¯å¦æ­£ç¡®å®ç°äº†å®ƒçš„æ¸…ç†åŠŸèƒ½**ã€‚âœ…

#### React å¦‚ä½•çŸ¥é“éœ€è¦é‡æ–°è¿›è¡Œ Effect çš„åŒæ­¥

å¦‚æœåœ¨åˆå§‹æ¸²æŸ“æ—¶ä¼ é€’äº† ["general"]ï¼Œç„¶ååœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“æ—¶ä¼ é€’äº† ["travel"]ï¼ŒReact å°†æ¯”è¾ƒ "general" å’Œ "travel"ã€‚è¿™äº›æ˜¯ä¸åŒçš„å€¼ï¼ˆä½¿ç”¨ Object.is è¿›è¡Œæ¯”è¾ƒï¼‰ï¼Œå› æ­¤ React å°†é‡æ–°åŒæ­¥ Effectã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœç»„ä»¶é‡æ–°æ¸²æŸ“ä½† roomId æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼ŒEffect å°†ç»§ç»­è¿æ¥åˆ°ç›¸åŒçš„æˆ¿é—´ã€‚

#### \*æ¯ä¸ª Effect è¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„åŒæ­¥è¿‡ç¨‹

ä»£ç ä¸­çš„æ¯ä¸ª Effect åº”è¯¥ä»£è¡¨ä¸€ä¸ªç‹¬ç«‹çš„åŒæ­¥è¿‡ç¨‹ã€‚

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œåˆ é™¤ä¸€ä¸ª Effect ä¸ä¼šå½±å“å¦ä¸€ä¸ª Effect çš„é€»è¾‘ã€‚è¿™è¡¨æ˜å®ƒä»¬åŒæ­¥ä¸åŒçš„å†…å®¹ï¼Œå› æ­¤å°†å®ƒä»¬æ‹†åˆ†å¼€æ˜¯æœ‰æ„ä¹‰çš„ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœå°†ä¸€ä¸ªå†…èšçš„é€»è¾‘æ‹†åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„ Effectsï¼Œä»£ç å¯èƒ½ä¼šçœ‹èµ·æ¥æ›´åŠ â€œæ¸…æ™°â€ï¼Œä½† ç»´æŠ¤èµ·æ¥ä¼šæ›´åŠ å›°éš¾ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ åº”è¯¥è€ƒè™‘è¿™äº›è¿‡ç¨‹æ˜¯ç›¸åŒè¿˜æ˜¯ç‹¬ç«‹çš„ï¼Œè€Œä¸æ˜¯åªè€ƒè™‘ä»£ç æ˜¯å¦çœ‹èµ·æ¥æ›´æ•´æ´ã€‚

### Effect ä¼šâ€œå“åº”â€äºå“åº”å¼å€¼

#### æ²¡æœ‰ä¾èµ–é¡¹çš„ Effect çš„å«ä¹‰

ç°åœ¨ Effect çš„ä»£ç ä¸ä½¿ç”¨ä»»ä½•å“åº”å¼å€¼ï¼Œå› æ­¤å®ƒçš„ä¾èµ–å¯ä»¥æ˜¯ç©ºçš„ ([])ã€‚

ä»ç»„ä»¶çš„è§’åº¦æ¥çœ‹ï¼Œç©ºçš„ [] ä¾èµ–æ•°ç»„æ„å‘³ç€è¿™ä¸ª Effect ä»…åœ¨ç»„ä»¶æŒ‚è½½æ—¶è¿æ¥åˆ°èŠå¤©å®¤ï¼Œå¹¶åœ¨ç»„ä»¶å¸è½½æ—¶æ–­å¼€è¿æ¥ã€‚ï¼ˆè¯·è®°ä½ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­ï¼ŒReact ä»ä¼š é¢å¤–æ‰§è¡Œä¸€æ¬¡ æ¥å¯¹é€»è¾‘è¿›è¡Œå‹åŠ›æµ‹è¯•ã€‚ï¼‰

ç„¶è€Œï¼Œ**å¦‚æœä½  ä» Effect çš„è§’åº¦æ€è€ƒï¼Œæ ¹æœ¬ä¸éœ€è¦è€ƒè™‘æŒ‚è½½å’Œå¸è½½**ã€‚é‡è¦çš„æ˜¯ï¼Œä½ å·²ç»æŒ‡å®šäº† Effect å¦‚ä½•å¼€å§‹å’Œåœæ­¢åŒæ­¥ã€‚ç›®å‰ï¼Œå®ƒæ²¡æœ‰ä»»ä½•å“åº”å¼ä¾èµ–ã€‚ä½†æ˜¯ï¼Œå¦‚æœå¸Œæœ›ç”¨æˆ·éšæ—¶é—´æ”¹å˜ roomId æˆ– serverUrlï¼ˆå®ƒä»¬å°†å˜ä¸ºå“åº”å¼ï¼‰ï¼ŒEffect çš„ä»£ç ä¸éœ€è¦æ”¹å˜ã€‚åªéœ€è¦å°†å®ƒä»¬æ·»åŠ åˆ°ä¾èµ–é¡¹ä¸­å³å¯ã€‚

#### åœ¨ç»„ä»¶ä¸»ä½“ä¸­å£°æ˜çš„æ‰€æœ‰å˜é‡éƒ½æ˜¯å“åº”å¼çš„

Props å’Œ state å¹¶ä¸æ˜¯å”¯ä¸€çš„å“åº”å¼å€¼ã€‚**ä»å®ƒä»¬è®¡ç®—å‡ºçš„å€¼ä¹Ÿæ˜¯å“åº”å¼çš„**ã€‚å¦‚æœ props æˆ– state å‘ç”Ÿå˜åŒ–ï¼Œç»„ä»¶å°†é‡æ–°æ¸²æŸ“ï¼Œä»ä¸­è®¡ç®—å‡ºçš„å€¼ä¹Ÿä¼šéšä¹‹æ”¹å˜ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Effect ä½¿ç”¨çš„ç»„ä»¶ä¸»ä½“ä¸­çš„æ‰€æœ‰å˜é‡éƒ½åº”è¯¥åœ¨ä¾èµ–åˆ—è¡¨ä¸­ã€‚

å‡è®¾ç”¨æˆ·å¯ä»¥åœ¨ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©èŠå¤©æœåŠ¡å™¨ï¼Œä½†ä»–ä»¬è¿˜å¯ä»¥åœ¨è®¾ç½®ä¸­é…ç½®é»˜è®¤æœåŠ¡å™¨ã€‚å‡è®¾ä½ å·²ç»å°†è®¾ç½®çŠ¶æ€æ”¾å…¥äº† ä¸Šä¸‹æ–‡ï¼Œå› æ­¤ä»è¯¥ä¸Šä¸‹æ–‡ä¸­è¯»å– settingsã€‚ç°åœ¨ï¼Œå¯ä»¥æ ¹æ® props ä¸­é€‰æ‹©çš„æœåŠ¡å™¨å’Œé»˜è®¤æœåŠ¡å™¨æ¥è®¡ç®— serverUrlï¼š

è¿™ä¸ªä¾‹å­ä¸­ï¼ŒserverUrl ä¸æ˜¯ prop æˆ– state å˜é‡ã€‚**å®ƒæ˜¯åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­è®¡ç®—çš„æ™®é€šå˜é‡ã€‚ä½†æ˜¯å®ƒæ˜¯åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­è®¡ç®—çš„ï¼Œæ‰€ä»¥å®ƒå¯èƒ½ä¼šå› ä¸ºé‡æ–°æ¸²æŸ“è€Œæ”¹å˜ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒæ˜¯å“åº”å¼çš„**ã€‚

**ç»„ä»¶å†…éƒ¨çš„æ‰€æœ‰å€¼ï¼ˆåŒ…æ‹¬ propsã€state å’Œç»„ä»¶ä½“å†…çš„å˜é‡ï¼‰éƒ½æ˜¯å“åº”å¼çš„ã€‚ä»»ä½•å“åº”å¼å€¼éƒ½å¯ä»¥åœ¨é‡æ–°æ¸²æŸ“æ—¶å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥éœ€è¦å°†å“åº”å¼å€¼åŒ…æ‹¬åœ¨ Effect çš„ä¾èµ–é¡¹ä¸­**ã€‚

æ¢å¥è¯è¯´ï¼ŒEffect å¯¹ç»„ä»¶ä½“å†…çš„æ‰€æœ‰å€¼éƒ½ä¼šâ€œreactâ€ã€‚

#### å…¨å±€å˜é‡æˆ–å¯å˜å€¼å¯ä»¥ä½œä¸ºä¾èµ–é¡¹å—ï¼Ÿ

**å¯å˜å€¼ï¼ˆåŒ…æ‹¬å…¨å±€å˜é‡ï¼‰ä¸æ˜¯å“åº”å¼çš„**ã€‚

ä¾‹å¦‚ï¼Œåƒ location.pathname è¿™æ ·çš„å¯å˜å€¼ä¸èƒ½ä½œä¸ºä¾èµ–é¡¹ã€‚å®ƒæ˜¯å¯å˜çš„ï¼Œå› æ­¤å¯ä»¥åœ¨ React æ¸²æŸ“æ•°æ®æµä¹‹å¤–çš„ä»»ä½•æ—¶é—´å‘ç”Ÿå˜åŒ–ã€‚æ›´æ”¹å®ƒä¸ä¼šè§¦å‘ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚å› æ­¤ï¼Œå³ä½¿åœ¨ä¾èµ–é¡¹ä¸­æŒ‡å®šäº†å®ƒï¼ŒReact ä¹Ÿæ— æ³•çŸ¥é“åœ¨å…¶æ›´æ”¹æ—¶é‡æ–°åŒæ­¥ Effectã€‚è¿™ä¹Ÿè¿åäº† React çš„è§„åˆ™ï¼Œå› ä¸ºåœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­è¯»å–å¯å˜æ•°æ®ï¼ˆå³åœ¨è®¡ç®—ä¾èµ–é¡¹æ—¶ï¼‰ä¼šç ´å çº¯ç²¹çš„æ¸²æŸ“ã€‚ç›¸åï¼Œåº”è¯¥ä½¿ç”¨ useSyncExternalStore æ¥è¯»å–å’Œè®¢é˜…å¤–éƒ¨å¯å˜å€¼ã€‚

å¦å¤–ï¼Œ**åƒ ref.current æˆ–ä»ä¸­è¯»å–çš„å€¼ä¹Ÿä¸èƒ½ä½œä¸ºä¾èµ–é¡¹**ã€‚useRef è¿”å›çš„ ref å¯¹è±¡æœ¬èº«å¯ä»¥ä½œä¸ºä¾èµ–é¡¹ï¼Œä½†å…¶ current å±æ€§æ˜¯æœ‰æ„å¯å˜çš„ã€‚å®ƒå…è®¸ è·Ÿè¸ªæŸäº›å€¼è€Œä¸è§¦å‘é‡æ–°æ¸²æŸ“ã€‚ä½†ç”±äºæ›´æ”¹å®ƒä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ï¼Œå®ƒä¸æ˜¯å“åº”å¼å€¼ï¼ŒReact ä¸ä¼šçŸ¥é“åœ¨å…¶æ›´æ”¹æ—¶é‡æ–°è¿è¡Œ Effectã€‚

#### React ä¼šéªŒè¯æ˜¯å¦å°†æ¯ä¸ªå“åº”å¼å€¼éƒ½æŒ‡å®šä¸ºäº†ä¾èµ–é¡¹

åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒReact çŸ¥é“ ä¸€ä¸ªå€¼æ°¸è¿œä¸ä¼šæ”¹å˜ï¼Œå³ä½¿å®ƒåœ¨ç»„ä»¶å†…éƒ¨å£°æ˜ã€‚

ä¾‹å¦‚ï¼Œ**ä» useState è¿”å›çš„ set å‡½æ•°**âœ… å’Œä» useRef è¿”å›çš„ ref å¯¹è±¡æ˜¯ ç¨³å®šçš„ â€”â€”å®ƒä»¬ä¿è¯åœ¨é‡æ–°æ¸²æŸ“æ—¶ä¸ä¼šæ”¹å˜ã€‚ç¨³å®šå€¼ä¸æ˜¯å“åº”å¼çš„ï¼Œå› æ­¤å¯ä»¥ä»åˆ—è¡¨ä¸­çœç•¥å®ƒä»¬ã€‚åŒ…æ‹¬å®ƒä»¬æ˜¯å…è®¸çš„ï¼šå®ƒä»¬ä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥æ— å…³ç´§è¦ã€‚

**é¿å…å°†å¯¹è±¡å’Œå‡½æ•°ä½œä¸ºä¾èµ–é¡¹ã€‚å¦‚æœåœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­åˆ›å»ºå¯¹è±¡å’Œå‡½æ•°ï¼Œç„¶ååœ¨ Effect ä¸­è¯»å–å®ƒä»¬ï¼Œå®ƒä»¬å°†åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½ä¸åŒã€‚è¿™å°†å¯¼è‡´ Effect æ¯æ¬¡éƒ½é‡æ–°åŒæ­¥**ã€‚

#### å½“ä½ ä¸æƒ³è¿›è¡Œé‡æ–°åŒæ­¥æ—¶è¯¥æ€ä¹ˆåŠ

1. å¯ä»¥å°†å®ƒä»¬ç§»åˆ°ç»„ä»¶å¤–éƒ¨ã€‚ç°åœ¨å®ƒä»¬ä¸éœ€è¦æˆä¸ºä¾èµ–é¡¹ã€‚
2. ä¹Ÿå¯ä»¥å°†å®ƒä»¬ ç§»åŠ¨åˆ° Effect å†…éƒ¨ã€‚å®ƒä»¬ä¸æ˜¯åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­è®¡ç®—çš„ï¼Œå› æ­¤å®ƒä»¬ä¸æ˜¯å“åº”å¼çš„ã€‚

Effect æ˜¯ä¸€æ®µå“åº”å¼çš„ä»£ç å—ã€‚å®ƒä»¬åœ¨è¯»å–çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶é‡æ–°è¿›è¡ŒåŒæ­¥ã€‚ä¸äº‹ä»¶å¤„ç†ç¨‹åºä¸åŒï¼Œäº‹ä»¶å¤„ç†ç¨‹åºåªåœ¨æ¯æ¬¡äº¤äº’æ—¶è¿è¡Œä¸€æ¬¡ï¼Œè€Œ Effect åˆ™åœ¨éœ€è¦è¿›è¡ŒåŒæ­¥æ—¶è¿è¡Œã€‚

#### æ‘˜è¦

- ç»„ä»¶å¯ä»¥æŒ‚è½½ã€æ›´æ–°å’Œå¸è½½ã€‚
- æ¯ä¸ª Effect ä¸å‘¨å›´ç»„ä»¶æœ‰ç€ç‹¬ç«‹çš„ç”Ÿå‘½å‘¨æœŸã€‚
- æ¯ä¸ª Effect æè¿°äº†ä¸€ä¸ªç‹¬ç«‹çš„åŒæ­¥è¿‡ç¨‹ï¼Œå¯ä»¥ å¼€å§‹ å’Œ åœæ­¢ã€‚
- åœ¨ç¼–å†™å’Œè¯»å– Effect æ—¶ï¼Œè¦ç‹¬ç«‹åœ°è€ƒè™‘æ¯ä¸ª Effectï¼ˆå¦‚ä½•å¼€å§‹å’Œåœæ­¢åŒæ­¥ï¼‰ï¼Œè€Œä¸æ˜¯ä»ç»„ä»¶çš„è§’åº¦æ€è€ƒï¼ˆå¦‚ä½•æŒ‚è½½ã€æ›´æ–°æˆ–å¸è½½ï¼‰ã€‚
- åœ¨ç»„ä»¶ä¸»ä½“å†…å£°æ˜çš„å€¼æ˜¯â€œå“åº”å¼â€çš„ã€‚
- å“åº”å¼å€¼åº”è¯¥é‡æ–°è¿›è¡ŒåŒæ­¥ Effectï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥éšç€æ—¶é—´çš„æ¨ç§»è€Œå‘ç”Ÿå˜åŒ–ã€‚
- æ£€æŸ¥å·¥å…·éªŒè¯åœ¨ Effect å†…éƒ¨ä½¿ç”¨çš„æ‰€æœ‰å“åº”å¼å€¼éƒ½è¢«æŒ‡å®šä¸ºä¾èµ–é¡¹ã€‚
- æ£€æŸ¥å·¥å…·æ ‡è®°çš„æ‰€æœ‰é”™è¯¯éƒ½æ˜¯åˆç†çš„ã€‚æ€»æ˜¯æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥ä¿®å¤ä»£ç ï¼ŒåŒæ—¶ä¸è¿åè§„åˆ™ã€‚

#### å°è¯•ä¸€äº›æŒ‘æˆ˜

5 ä¸ªç¤ºä¾‹éƒ½ä¸é”™ã€‚

## å°†äº‹ä»¶ä» Effect ä¸­åˆ†å¼€

...

### åœ¨äº‹ä»¶å¤„ç†å‡½æ•°å’Œ Effect ä¸­åšé€‰æ‹©

...

#### äº‹ä»¶å¤„ç†å‡½æ•°åªåœ¨å“åº”ç‰¹å®šçš„äº¤äº’æ“ä½œæ—¶è¿è¡Œ

...

#### æ¯å½“éœ€è¦åŒæ­¥ï¼ŒEffect å°±ä¼šè¿è¡Œ

...

### \*å“åº”å¼å€¼å’Œå“åº”å¼é€»è¾‘

...

#### äº‹ä»¶å¤„ç†å‡½æ•°å†…éƒ¨çš„é€»è¾‘æ˜¯éå“åº”å¼çš„

...

#### Effect å†…éƒ¨çš„é€»è¾‘æ˜¯å“åº”å¼çš„

...

### ä» Effect ä¸­æå–éå“åº”å¼é€»è¾‘

...

#### \*å£°æ˜ä¸€ä¸ª Effect Event

ï¼ˆ**useEffectEvent æ˜¯é…åˆ useEffect ä½¿ç”¨** âœ…ï¼‰

**ä½¿ç”¨ useEffectEvent è¿™ä¸ªç‰¹æ®Šçš„ Hook ä» Effect ä¸­æå–éå“åº”å¼é€»è¾‘ âœ…**ã€‚

è¿™é‡Œçš„ onConnected è¢«ç§°ä¸º **Effect Eventã€‚å®ƒæ˜¯ Effect é€»è¾‘çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯å…¶è¡Œä¸ºæ›´åƒäº‹ä»¶å¤„ç†å‡½æ•°ã€‚å®ƒå†…éƒ¨çš„é€»è¾‘ä¸æ˜¯å“åº”å¼çš„ï¼Œè€Œä¸”èƒ½ä¸€ç›´â€œçœ‹è§â€æœ€æ–°çš„ props å’Œ stateâœ…**ã€‚

ç°åœ¨ä½ å¯ä»¥åœ¨ Effect å†…éƒ¨è°ƒç”¨ onConnected Effect Eventï¼š

```js
function ChatRoom({ roomId, theme }) {
  const onConnected = useEffectEvent(() => {
    showNotification('Connected!', theme);
  });

  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    connection.on('connected', () => {
      onConnected();
    });
    connection.connect();
    return () => connection.disconnect();
  }, [roomId]); // âœ… å£°æ˜æ‰€æœ‰ä¾èµ–é¡¹ï¼ˆâœ…è§£å†³ä¾èµ–themeçš„é—®é¢˜ï¼Œæ–‡æ¡£ä¸­æœ‰ï¼‰
  // ...
```

è¿™ä¸ªæ–¹æ³•è§£å†³äº†é—®é¢˜ã€‚æ³¨æ„ä½ å¿…é¡»ä» Effect ä¾èµ–é¡¹ä¸­ ç§»é™¤ onConnectedã€‚Effect Event æ˜¯éå“åº”å¼çš„å¹¶ä¸”å¿…é¡»ä»ä¾èµ–é¡¹ä¸­åˆ é™¤ã€‚

**ä½ å¯ä»¥å°† Effect Event çœ‹æˆå’Œäº‹ä»¶å¤„ç†å‡½æ•°ç›¸ä¼¼çš„ä¸œè¥¿ã€‚ä¸»è¦åŒºåˆ«æ˜¯äº‹ä»¶å¤„ç†å‡½æ•°åªåœ¨å“åº”ç”¨æˆ·äº¤äº’çš„æ—¶å€™è¿è¡Œï¼Œè€Œ Effect Event æ˜¯ä½ åœ¨ Effect ä¸­è§¦å‘çš„ã€‚Effect Event è®©ä½ åœ¨ Effect å“åº”æ€§å’Œä¸åº”æ˜¯å“åº”å¼çš„ä»£ç é—´â€œæ‰“ç ´é“¾æ¡â€**ã€‚

#### ä½¿ç”¨ Effect Event è¯»å–æœ€æ–°çš„ props å’Œ state

æ¯ä¸ª URL ä»£è¡¨ä¸åŒçš„é¡µé¢ã€‚æ¢è¨€ä¹‹ï¼ŒlogVisit è°ƒç”¨å¯¹äº url åº”è¯¥ æ˜¯å“åº”å¼çš„ã€‚

ç°åœ¨å‡è®¾ä½ æƒ³åœ¨æ¯æ¬¡é¡µé¢è®¿é—®ä¸­åŒ…å«è´­ç‰©è½¦ä¸­çš„å•†å“æ•°é‡ã€‚

ä½ åœ¨ Effect å†…éƒ¨ä½¿ç”¨äº† numberOfItemsï¼Œæ‰€ä»¥ä»£ç æ£€æŸ¥å·¥å…·ä¼šè®©ä½ æŠŠå®ƒåŠ åˆ°ä¾èµ–é¡¹ä¸­ã€‚ä½†æ˜¯ï¼Œä½  ä¸ æƒ³è¦ logVisit è°ƒç”¨å“åº” numberOfItemsã€‚å¦‚æœç”¨æˆ·æŠŠæŸæ ·ä¸œè¥¿æ”¾å…¥è´­ç‰©è½¦ï¼Œ numberOfItems ä¼šå˜åŒ–ï¼Œè¿™ å¹¶ä¸æ„å‘³ç€ ç”¨æˆ·å†æ¬¡è®¿é—®äº†è¿™ä¸ªé¡µé¢ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨æŸç§æ„ä¹‰ä¸Šï¼Œè®¿é—®é¡µé¢ æ˜¯ä¸€ä¸ªâ€œäº‹ä»¶â€ã€‚å®ƒå‘ç”Ÿåœ¨æŸä¸ªå‡†ç¡®çš„æ—¶åˆ»ã€‚

å°†ä»£ç åˆ†å‰²ä¸ºä¸¤éƒ¨åˆ†ï¼š

```js
function Page({ url }) {
  const { items } = useContext(ShoppingCartContext);
  const numberOfItems = items.length;

  const onVisit = useEffectEvent((visitedUrl) => {
    logVisit(visitedUrl, numberOfItems);
  });

  useEffect(() => {
    onVisit(url);
  }, [url]); // âœ… å£°æ˜æ‰€æœ‰ä¾èµ–é¡¹
  // ...
}
```

è¿™é‡Œçš„ onVisit æ˜¯ä¸€ä¸ª Effect Eventã€‚é‡Œé¢çš„ä»£ç ä¸æ˜¯å“åº”å¼çš„ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ å¯ä»¥ä½¿ç”¨ numberOfItemsï¼ˆæˆ–è€…ä»»æ„å“åº”å¼å€¼ï¼ï¼‰è€Œä¸ç”¨æ‹…å¿ƒå¼•èµ·å‘¨å›´ä»£ç å› ä¸ºå˜åŒ–è€Œé‡æ–°æ‰§è¡Œã€‚

å¦ä¸€æ–¹é¢ï¼ŒEffect æœ¬èº«ä»ç„¶æ˜¯å“åº”å¼çš„ã€‚å…¶å†…éƒ¨çš„ä»£ç ä½¿ç”¨äº† url propsï¼Œæ‰€ä»¥æ¯æ¬¡å› ä¸ºä¸åŒçš„ url é‡æ–°æ¸²æŸ“å Effect éƒ½ä¼šé‡æ–°è¿è¡Œã€‚è¿™ä¼šä¾æ¬¡è°ƒç”¨ onVisit è¿™ä¸ª Effect Eventã€‚

ç»“æœæ˜¯ä½ ä¼šå› ä¸º url çš„å˜åŒ–å»è°ƒç”¨ logVisitï¼Œå¹¶ä¸”è¯»å–çš„ä¸€ç›´éƒ½æ˜¯æœ€æ–°çš„ numberOfItemsã€‚ä½†æ˜¯å¦‚æœ numberOfItems è‡ªå·±å˜åŒ–ï¼Œä¸ä¼šå¼•èµ·ä»»ä½•ä»£ç çš„é‡æ–°è¿è¡Œã€‚

#### \*å¦‚æœ Effect å†…éƒ¨æœ‰ä¸€äº›å¼‚æ­¥é€»è¾‘

```js
function Page({ url }) {
  const { items } = useContext(ShoppingCartContext);
  const numberOfItems = items.length;

  const onVisit = useEffectEvent((url) => {
    logVisit(url, numberOfItems); // useEffect é—­åŒ…å›è°ƒä¿å­˜äº†ä¸Šä¸€æ¬¡çš„ urlâœ…ï¼‰
  });

  useEffect(() => {
    setTimeout(() => {
      onVisit(url);
    }, 5000); // å»¶è¿Ÿè®°å½•è®¿é—®
  }, [url]);
}
```

**åœ¨è¿™é‡Œï¼ŒonVisit å†…çš„ url å¯¹åº” æœ€æ–°çš„ urlï¼ˆå¯èƒ½å·²ç»å˜åŒ–äº†ï¼‰ï¼Œä½†æ˜¯ visitedUrl å¯¹åº”çš„æ˜¯æœ€å¼€å§‹å¼•èµ·è¿™ä¸ª Effectï¼ˆå¹¶ä¸”æ˜¯æœ¬æ¬¡ onVisit è°ƒç”¨ï¼‰è¿è¡Œçš„ url **ã€‚

#### \*åˆå§‹åŒ–ç›‘å¬

```js
export default function App() {
  const [position, setPosition] = useState({ x: 0, y: 0 });
  const [canMove, setCanMove] = useState(true);

  const onMove = useEffectEvent(e => {
    if (canMove) {
      setPosition({ x: e.clientX, y: e.clientY });
    }
  });

  useEffect(() => {
    window.addEventListener('pointermove', onMove);
    return () => window.removeEventListener('pointermove', onMove);
  }, []);
```

#### \*Effect Event çš„å±€é™æ€§

Effect Event çš„å±€é™æ€§åœ¨äºä½ å¦‚ä½•ä½¿ç”¨ä»–ä»¬ï¼š

- **åªåœ¨ Effect å†…éƒ¨è°ƒç”¨ä»–ä»¬ âœ…**ã€‚
- **æ°¸è¿œä¸è¦æŠŠä»–ä»¬ä¼ ç»™å…¶ä»–çš„ç»„ä»¶æˆ–è€… Hookâœ…**ã€‚

ä¾‹å¦‚ä¸è¦åƒè¿™æ ·å£°æ˜å’Œä¼ é€’ Effect Eventï¼š

**Effect Event æ˜¯ Effect ä»£ç çš„éå“åº”å¼â€œç‰‡æ®µâ€ã€‚ä»–ä»¬åº”è¯¥åœ¨ä½¿ç”¨ä»–ä»¬çš„ Effect çš„æ—è¾¹ âœ…**ã€‚

### \*æ‘˜è¦

- äº‹ä»¶å¤„ç†å‡½æ•°åœ¨å“åº”ç‰¹å®šäº¤äº’æ—¶è¿è¡Œã€‚
- Effect åœ¨éœ€è¦åŒæ­¥çš„æ—¶å€™è¿è¡Œã€‚
- äº‹ä»¶å¤„ç†å‡½æ•°å†…éƒ¨çš„é€»è¾‘æ˜¯éå“åº”å¼çš„ã€‚
- Effect å†…éƒ¨çš„é€»è¾‘æ˜¯å“åº”å¼çš„ã€‚
- ä½ å¯ä»¥å°†éå“åº”å¼é€»è¾‘ä» Effect ç§»åˆ° Effect Event ä¸­ã€‚
- åªåœ¨ Effect å†…éƒ¨è°ƒç”¨ Effect Eventã€‚
- ä¸è¦å°† Effect Event ä¼ ç»™å…¶ä»–ç»„ä»¶æˆ–è€… Hookã€‚

### å°è¯•ä¸€äº›æŒ‘æˆ˜

ç¬¬ 4 ä¸ªæŒ‘æˆ˜: ä¿®å¤å»¶è¿Ÿé€šçŸ¥ã€‚ä¹Ÿæ˜¯ useEffect ä½¿ç”¨å¼‚æ­¥é—®é¢˜ã€‚ï¼ˆ**useEffect é—­åŒ…å›è°ƒä¿å­˜äº†ä¸Šä¸€æ¬¡çš„ roomId**âœ…ï¼‰

## \*ç§»é™¤ Effect ä¾èµ–

ï¼ˆ**å¾ˆå¤šå®è·µåœºæ™¯**âœ…ï¼‰

### ä¾èµ–åº”è¯¥å’Œä»£ç ä¿æŒä¸€è‡´

...

#### å½“è¦ç§»é™¤ä¸€ä¸ªä¾èµ–æ—¶ï¼Œè¯·è¯æ˜å®ƒä¸æ˜¯ä¸€ä¸ªä¾èµ–

...

#### è¦æ”¹å˜ä¾èµ–ï¼Œè¯·æ”¹å˜ä»£ç 

...

### ç§»é™¤éå¿…éœ€çš„ä¾èµ–

...

#### è¿™æ®µä»£ç åº”è¯¥ç§»åˆ°äº‹ä»¶å¤„ç†ç¨‹åºä¸­å—ï¼Ÿ

...

#### Effect æ˜¯å¦åœ¨åšå‡ ä»¶ä¸ç›¸å…³çš„äº‹æƒ…ï¼Ÿ

...

#### æ˜¯å¦åœ¨è¯»å–ä¸€äº›çŠ¶æ€æ¥è®¡ç®—ä¸‹ä¸€ä¸ªçŠ¶æ€ï¼Ÿ

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸è¦åœ¨ Effect é‡Œé¢è¯»å– messagesã€‚ç›¸åï¼Œåº”è¯¥å°†ä¸€ä¸ª state æ›´æ–°å‡½æ•° ä¼ é€’ç»™ setMessagesï¼š

```js
function ChatRoom({ roomId }) {
  const [messages, setMessages] = useState([]);
  useEffect(() => {
    const connection = createConnection();
    connection.connect();
    connection.on('message', (receivedMessage) => {
      setMessages(msgs => [...msgs, receivedMessage]);
    });
    return () => connection.disconnect();
  }, [roomId]); // âœ… æ‰€æœ‰ä¾èµ–å·²å£°æ˜
  // ...
```

æ³¨æ„ **Effect ç°åœ¨æ ¹æœ¬ä¸è¯»å– messages å˜é‡**ã€‚ä½ åªéœ€è¦ä¼ é€’ä¸€ä¸ªæ›´æ–°å‡½æ•°ï¼Œæ¯”å¦‚ msgs => [...msgs, receivedMessage]ã€‚React å°†æ›´æ–°ç¨‹åºå‡½æ•°æ”¾å…¥é˜Ÿåˆ— å¹¶å°†åœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“æœŸé—´å‘å…¶æä¾› msgs å‚æ•°ã€‚è¿™å°±æ˜¯ Effect æœ¬èº«ä¸å†éœ€è¦ä¾èµ– messages çš„åŸå› ã€‚

#### ä½ æƒ³è¯»å–ä¸€ä¸ªå€¼è€Œä¸å¯¹å…¶å˜åŒ–åšå‡ºâ€œååº”â€å—ï¼Ÿ

...

#### \*åŒ…è£…æ¥è‡ª props çš„äº‹ä»¶å¤„ç†ç¨‹åº

å½“ç»„ä»¶æ¥æ”¶äº‹ä»¶å¤„ç†å‡½æ•°ä½œä¸º props æ—¶ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°ç±»ä¼¼çš„é—®é¢˜ï¼š

```js
function ChatRoom({ roomId, onReceiveMessage }) {
  const [messages, setMessages] = useState([]);

  useEffect(() => {
    const connection = createConnection();
    connection.connect();
    connection.on('message', (receivedMessage) => {
      onReceiveMessage(receivedMessage);
    });
    return () => connection.disconnect();
  }, [roomId, onReceiveMessage]); // âœ… æ‰€æœ‰ä¾èµ–å·²å£°æ˜
  // ...
```

**ç”±äº onReceiveMessage æ˜¯ä¾èµ–ï¼Œå®ƒä¼šå¯¼è‡´ Effect åœ¨æ¯æ¬¡çˆ¶çº§é‡æ–°æ¸²æŸ“åé‡æ–°åŒæ­¥ã€‚è¿™å°†å¯¼è‡´èŠå¤©é‡æ–°è¿æ¥ (è¦è§£å†³çš„é—®é¢˜ âœ…)**ã€‚è¦è§£å†³æ­¤é—®é¢˜ï¼Œè¯·ç”¨ Effect Event åŒ…è£¹ä¹‹åå†è°ƒç”¨ï¼š

ï¼ˆ**1. onReceiveMessage å˜åŒ–è¿˜æ˜¯ä¼šé‡æ–°æ¸²æŸ“ï¼Œä½†ä¸ä¼šå¼•èµ·é‡æ–°è¿æ¥äº†ï¼Œ2. åŒæ—¶ roomId æ”¹å˜æ—¶ä¼šé‡æ–°æ¸²æŸ“é‡æ–° useEffectï¼Œ3. æ­¤æ—¶ onReceiveMessage ä¹Ÿæ˜¯å“åº”æœ€æ–°çš„å‡½æ•° âœ…**ã€‚ï¼‰

```js
function ChatRoom({ roomId, onReceiveMessage }) {
  const [messages, setMessages] = useState([]);

  const onMessage = useEffectEvent(receivedMessage => {
    onReceiveMessage(receivedMessage);
  });

  useEffect(() => {
    const connection = createConnection();
    connection.connect();
    connection.on('message', (receivedMessage) => {
      onMessage(receivedMessage);
    });
    return () => connection.disconnect();
  }, [roomId]); // âœ… æ‰€æœ‰ä¾èµ–å·²å£°æ˜
  // ...
```

Effect Events ä¸æ˜¯å“åº”å¼çš„ï¼Œå› æ­¤ä½ ä¸éœ€è¦å°†å®ƒä»¬æŒ‡å®šä¸ºä¾èµ–ã€‚å› æ­¤ï¼Œå³ä½¿çˆ¶ç»„ä»¶ä¼ é€’çš„å‡½æ•°åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶éƒ½ä¸åŒï¼ŒèŠå¤©ä¹Ÿå°†ä¸å†é‡æ–°è¿æ¥ã€‚

#### \*|åˆ†ç¦»å“åº”å¼å’Œéå“åº”å¼ä»£ç 

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä½ å¸Œæœ›åœ¨æ¯æ¬¡ roomId æ›´æ”¹æ—¶è®°å½•ä¸€æ¬¡ã€‚ä½ å¸Œæœ›åœ¨æ¯ä¸ªæ—¥å¿—ä¸­åŒ…å«å½“å‰çš„ notificationCountï¼Œä½†ä½  ä¸ å¸Œæœ›é€šè¿‡æ›´æ”¹ notificationCount æ¥è§¦å‘æ—¥å¿—äº‹ä»¶ã€‚

**è§£å†³æ–¹æ¡ˆè¿˜æ˜¯å°†éå“åº”å¼ä»£ç æ‹†åˆ†ï¼Œå°†å…¶æ”¾åˆ° Effect Event å†…ï¼šâœ…**

```js
function Chat({ roomId, notificationCount }) {
  const onVisit = useEffectEvent((visitedRoomId) => {
    logVisit(visitedRoomId, notificationCount);
  });

  useEffect(() => {
    onVisit(roomId);
  }, [roomId]); // âœ… æ‰€æœ‰ä¾èµ–å·²å£°æ˜
  // ...
}
```

**ä½ å¸Œæœ›é€»è¾‘å¯¹ roomId åšå‡ºå“åº”ï¼Œå› æ­¤ä½ åœ¨ Effect ä¸­è¯»å– roomIdã€‚ä½†æ˜¯ï¼Œä½ ä¸å¸Œæœ›æ›´æ”¹ notificationCount æ¥è®°å½•é¢å¤–çš„æ—¥å¿—è¾“å‡ºï¼Œå› æ­¤ä½ å¯ä»¥åœ¨ Effect Event ä¸­è¯»å– notificationCountâœ…**ã€‚

#### \*ä¸€äº›å“åº”å¼å€¼æ˜¯å¦æ— æ„ä¸­æ”¹å˜äº†ï¼Ÿ

ï¼ˆ**å¯¹è±¡å’Œå‡½æ•°ç­‰å¼•ç”¨ç±»å‹çš„å˜é‡ï¼Œä½œä¸º Effect ä¾èµ–**âœ…ï¼‰

**å½“ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ï¼Œå…¶ä¸­çš„ä»£ç ä¼šä»å¤´å¼€å§‹é‡æ–°è¿è¡Œ**ã€‚

```js
const serverUrl = 'xxx';
function ChatRoom({ roomId }) {
  const [message, setMessage] = useState('');
  // æš‚æ—¶ç¦ç”¨ linter ä»¥æ¼”ç¤ºé—®é¢˜
  // eslint-disable-next-line react-hooks/exhaustive-deps
  const options = {
    serverUrl: serverUrl,
    roomId: roomId
  };

  useEffect(() => {
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [options]);
```

**åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“ ChatRoom ç»„ä»¶æ—¶ï¼Œéƒ½ä¼šä»å¤´å¼€å§‹åˆ›å»ºä¸€ä¸ªæ–°çš„ options å¯¹è±¡ã€‚React å‘ç° options å¯¹è±¡ä¸ä¸Šæ¬¡æ¸²æŸ“æœŸé—´åˆ›å»ºçš„ options å¯¹è±¡æ˜¯ ä¸åŒçš„å¯¹è±¡**ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒä¼šé‡æ–°åŒæ­¥ Effectï¼ˆä¾èµ–äº optionsï¼‰

**æ­¤é—®é¢˜ä»…å½±å“å¯¹è±¡å’Œå‡½æ•°ã€‚åœ¨ JavaScript ä¸­ï¼Œæ¯ä¸ªæ–°åˆ›å»ºçš„å¯¹è±¡å’Œå‡½æ•°éƒ½è¢«è®¤ä¸ºä¸å…¶ä»–æ‰€æœ‰å¯¹è±¡å’Œå‡½æ•°ä¸åŒã€‚å³ä½¿ä»–ä»¬çš„å€¼ç›¸åŒä¹Ÿæ²¡å…³ç³»ï¼**

**å¯¹è±¡å’Œå‡½æ•°ä½œä¸ºä¾èµ–ï¼Œä¼šä½¿ Effect æ¯”ä½ éœ€è¦çš„æ›´é¢‘ç¹åœ°é‡æ–°åŒæ­¥ã€‚**

**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ åº”è¯¥å°½å¯èƒ½é¿å…å°†å¯¹è±¡å’Œå‡½æ•°ä½œä¸º Effect çš„ä¾èµ–ã€‚æ‰€ä»¥ï¼Œå°è¯•å°†å®ƒä»¬ç§»åˆ°ç»„ä»¶å¤–éƒ¨ã€Effect å†…éƒ¨ï¼Œæˆ–ä»ä¸­æå–åŸå§‹å€¼**ã€‚

**å°†é™æ€å¯¹è±¡å’Œå‡½æ•°ç§»å‡ºç»„ä»¶ï¼ˆè§£å†³æ–¹æ¡ˆ 1ï¼‰**

1. å¦‚æœè¯¥å¯¹è±¡ä¸ä¾èµ–äºä»»ä½• props å’Œ stateï¼Œä½ å¯ä»¥å°†è¯¥å¯¹è±¡ç§»åˆ°ç»„ä»¶ä¹‹å¤–ï¼Œå®ƒä¸ä¼šå› ä¸ºé‡æ–°æ¸²æŸ“è€Œæ”¹å˜ï¼Œæ‰€ä»¥å®ƒä¸æ˜¯ä¾èµ–ã€‚ç°åœ¨é‡æ–°æ¸²æŸ“ ChatRoom ä¸ä¼šå¯¼è‡´ Effect é‡æ–°åŒæ­¥ã€‚

2. è¿™ä¹Ÿé€‚ç”¨äºå‡½æ•°åœºæ™¯ï¼Œç”±äº createOptions æ˜¯åœ¨ç»„ä»¶å¤–éƒ¨å£°æ˜çš„ï¼Œå› æ­¤å®ƒä¸æ˜¯å“åº”å¼å€¼ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒä¸éœ€è¦åœ¨ Effect çš„ä¾èµ–ä¸­æŒ‡å®šï¼Œä»¥åŠä¸ºä»€ä¹ˆå®ƒæ°¸è¿œä¸ä¼šå¯¼è‡´ Effect é‡æ–°åŒæ­¥ã€‚ï¼ˆ**å…³é”®æ˜¯ createOptions()åœ¨ useEffect é‡Œè°ƒç”¨çš„ âœ…**ï¼‰

```js
const options = {
  serverUrl: 'https://localhost:1234',
  roomId: 'éŸ³ä¹'
};
// æˆ–è€…
function createOptions() {
  return {
    serverUrl: 'https://localhost:1234',
    roomId: 'éŸ³ä¹'
  };
}

function ChatRoom() {
  const [message, setMessage] = useState('');

  useEffect(() => {
    const options = createOptions();
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, []); // âœ… æ‰€æœ‰ä¾èµ–å·²å£°æ˜
  // ...
```

**å°†åŠ¨æ€å¯¹è±¡å’Œå‡½æ•°ç§»åŠ¨åˆ° Effect ä¸­ï¼ˆè§£å†³æ–¹æ¡ˆ 2ï¼‰**

1. **åœ¨ Effect å†…éƒ¨ åˆ›å»ºå®ƒä»¬**ï¼Œç°åœ¨ options å·²åœ¨ Effect ä¸­å£°æ˜ï¼Œå®ƒä¸å†æ˜¯ Effect çš„ä¾èµ–ã€‚ç›¸åï¼ŒEffect ä½¿ç”¨çš„å”¯ä¸€å“åº”å¼å€¼æ˜¯ roomIdã€‚

```js
const serverUrl = 'xxx';

function ChatRoom({ roomId }) {
  const [message, setMessage] = useState('');

  useEffect(() => {
    const options = {
      serverUrl: serverUrl,
      roomId: roomId
    };
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [roomId]); // âœ… æ‰€æœ‰ä¾èµ–å·²å£°æ˜
  // ...
```

2. **è¿™ä¹Ÿé€‚ç”¨äºå‡½æ•°çš„åœºæ™¯ï¼Œåªè¦å°†è¿™äº›å‡½æ•°å£°æ˜åœ¨ Effect å†…éƒ¨ï¼Œå®ƒä»¬å°±ä¸æ˜¯å“åº”å¼å€¼ï¼Œå› æ­¤å®ƒä»¬ä¹Ÿä¸æ˜¯ Effect çš„ä¾èµ–**ã€‚

```js
const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId }) {
  const [message, setMessage] = useState('');

  useEffect(() => {
    function createOptions() {
      return {
        serverUrl: serverUrl,
        roomId: roomId
      };
    }

    const options = createOptions();
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [roomId]); // âœ… æ‰€æœ‰ä¾èµ–å·²å£°æ˜
  // ...
```

**ä»å¯¹è±¡ä¸­è¯»å–åŸå§‹å€¼ï¼ˆè§£å†³æ–¹æ¡ˆ 3ï¼‰**

æœ‰æ—¶ï¼Œä½ å¯èƒ½ä¼šé€šè¿‡ props æ¥æ”¶åˆ°ç±»å‹ä¸ºå¯¹è±¡çš„å€¼ã€‚

è¦è§£å†³æ­¤é—®é¢˜ï¼Œè¯·ä» Effect å¤–éƒ¨ è¯»å–å¯¹è±¡ä¿¡æ¯ï¼ˆ**è§£æ„å¯¹è±¡**ï¼‰ï¼Œå¹¶é¿å…ä¾èµ–å¯¹è±¡å’Œå‡½æ•°ç±»å‹ï¼š

```js
function ChatRoom({ options }) {
  const [message, setMessage] = useState('');

  const { roomId, serverUrl } = options;
  useEffect(() => {
    const connection = createConnection({
      roomId: roomId,
      serverUrl: serverUrl
    });
    connection.connect();
    return () => connection.disconnect();
  }, [roomId, serverUrl]); // âœ… æ‰€æœ‰ä¾èµ–å·²å£°æ˜
  // ...
```

åŒæ ·çš„æ–¹æ³•ä¹Ÿé€‚ç”¨äºå‡½æ•°ã€‚è¿™ä»…é€‚ç”¨äº çº¯ å‡½æ•°ï¼Œå› ä¸ºå®ƒä»¬åœ¨æ¸²æŸ“æœŸé—´å¯ä»¥å®‰å…¨è°ƒç”¨ã€‚å¦‚æœå‡½æ•°æ˜¯ä¸€ä¸ªäº‹ä»¶å¤„ç†ç¨‹åºï¼Œä½†ä½ ä¸å¸Œæœ›å®ƒçš„æ›´æ”¹é‡æ–°åŒæ­¥ Effectï¼Œå°†å®ƒåŒ…è£…åˆ° Effect Event ä¸­ã€‚

```js
function ChatRoom({ getOptions }) {
  const [message, setMessage] = useState('');

  const { roomId, serverUrl } = getOptions();
  useEffect(() => {
    const connection = createConnection({
      roomId: roomId,
      serverUrl: serverUrl
    });
    connection.connect();
    return () => connection.disconnect();
  }, [roomId, serverUrl]); // âœ… æ‰€æœ‰ä¾èµ–å·²å£°æ˜
  // ...
```

### |æ‘˜è¦

- ä¾èµ–åº”å§‹ç»ˆä¸ä»£ç åŒ¹é…ã€‚
- å½“ä½ å¯¹ä¾èµ–ä¸æ»¡æ„æ—¶ï¼Œä½ éœ€è¦ç¼–è¾‘çš„æ˜¯ä»£ç ã€‚
- æŠ‘åˆ¶ linter ä¼šå¯¼è‡´éå¸¸æ··ä¹±çš„é”™è¯¯ï¼Œä½ åº”è¯¥å§‹ç»ˆé¿å…å®ƒã€‚
- è¦ç§»é™¤ä¾èµ–ï¼Œä½ éœ€è¦å‘ linter â€œè¯æ˜â€å®ƒä¸æ˜¯å¿…éœ€çš„ã€‚
- å¦‚æœæŸäº›ä»£ç æ˜¯ä¸ºäº†å“åº”ç‰¹å®šäº¤äº’ï¼Œè¯·å°†è¯¥ä»£ç ç§»è‡³äº‹ä»¶å¤„ç†çš„åœ°æ–¹ã€‚
- å¦‚æœ Effect çš„ä¸åŒéƒ¨åˆ†å› ä¸åŒåŸå› éœ€è¦é‡æ–°è¿è¡Œï¼Œè¯·å°†å…¶æ‹†åˆ†ä¸ºå¤šä¸ª Effectã€‚
- å¦‚æœä½ æƒ³æ ¹æ®ä»¥å‰çš„çŠ¶æ€æ›´æ–°ä¸€äº›çŠ¶æ€ï¼Œä¼ é€’ä¸€ä¸ªæ›´æ–°å‡½æ•°ã€‚
- å¦‚æœä½ æƒ³è¯»å–æœ€æ–°å€¼è€Œä¸â€œååº”â€å®ƒï¼Œè¯·ä» Effect ä¸­æå–å‡ºä¸€ä¸ª Effect Eventã€‚
- åœ¨ JavaScript ä¸­ï¼Œå¦‚æœå¯¹è±¡å’Œå‡½æ•°æ˜¯åœ¨ä¸åŒæ—¶é—´åˆ›å»ºçš„ï¼Œåˆ™å®ƒä»¬è¢«è®¤ä¸ºæ˜¯ä¸åŒçš„ã€‚
- **å°½é‡é¿å…å¯¹è±¡å’Œå‡½æ•°ä¾èµ–ã€‚å°†å®ƒä»¬ç§»åˆ°ç»„ä»¶å¤–æˆ– Effect å†… âœ…**ã€‚

### |å°è¯•ä¸€äº›æŒ‘æˆ˜

4 ä¸ªæŒ‘æˆ˜åœºæ™¯éƒ½å¾ˆå®ç”¨ã€‚

#### |ç¬¬ 1 ä¸ªæŒ‘æˆ˜: ä¿®å¤é‡ç½® interval

è¿™ä¸ª Effect è®¾ç½®äº†ä¸€ä¸ªæ¯ç§’è¿è¡Œçš„ intervalã€‚ä½ å·²ç»æ³¨æ„åˆ°ä¸€äº›å¥‡æ€ªçš„äº‹æƒ…ï¼šä¼¼ä¹æ¯æ¬¡ interval éƒ½ä¼šè¢«é”€æ¯å¹¶é‡æ–°åˆ›å»ºã€‚ä¿®å¤ä»£ç ï¼Œä½¿ interval ä¸ä¼šè¢«ä¸æ–­é‡æ–°åˆ›å»ºã€‚

```js
export default function Timer() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    console.log("âœ… åˆ›å»ºå®šæ—¶å™¨");
    const id = setInterval(() => {
      console.log("â° Interval");
      setCount(count + 1);
    }, 1000);
    return () => {
      console.log("âŒ æ¸…é™¤å®šæ—¶å™¨");
      clearInterval(id);
    };
  }, [count]);

  return <h1>è®¡æ•°å™¨: {count}</h1>;
}
```

**ä½ æƒ³è¦ä» Effect å†…éƒ¨å°† count çŠ¶æ€æ›´æ–°ä¸º count + 1ã€‚ä½†æ˜¯ï¼Œè¿™ä¼šä½¿ Effect ä¾èµ–äº countï¼Œå®ƒä¼šéšç€æ¯æ¬¡æ»´ç­”è€Œå˜åŒ–ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ interval ä¼šåœ¨æ¯æ¬¡æ»´ç­”æ—¶é‡æ–°åˆ›å»º**ã€‚ï¼ˆ**æ³¨æ„ï¼šè¿™é‡Œæ¯æ¬¡ count åŠ  1 è®¡ç®—å¼æ­£ç¡®çš„ï¼Œåªæ˜¯ interval é”€æ¯é‡å»ºçš„é—®é¢˜**ã€‚âœ…ï¼‰

è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¯·ä½¿ç”¨ æ›´æ–°å‡½æ•° å¹¶ç¼–å†™ setCount(c => c + 1) è€Œä¸æ˜¯ setCount(count + 1):

```js
import { useState, useEffect } from "react";

export default function Timer() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    console.log("âœ… åˆ›å»ºå®šæ—¶å™¨");
    const id = setInterval(() => {
      console.log("â° Interval");
      setCount((c) => c + 1);
    }, 1000);
    return () => {
      console.log("âŒ æ¸…é™¤å®šæ—¶å™¨");
      clearInterval(id);
    };
  }, []);

  return <h1>è®¡æ•°å™¨: {count}</h1>;
}
```

è¯‘æ³¨ï¼š
åœ¨åˆ›å»º onTick å‡½æ•°æ—¶ï¼Œç”±äºé—­åŒ…çš„ç¼˜æ•…ï¼ŒsetCount(count + increment) æ•è·çš„æ˜¯åˆ›å»ºæ—¶ count å’Œ increment å€¼ã€‚

#### |ç¬¬ 2 ä¸ªæŒ‘æˆ˜: ä¿®å¤é‡æ–°è§¦å‘åŠ¨ç”»çš„é—®é¢˜

```js
function Welcome({ duration }) {
  const ref = useRef(null);

  useEffect(() => {
    const animation = new FadeInAnimation(ref.current);
    animation.start(duration);
    return () => {
      animation.stop();
    };
  }, [duration]);
```

Effect éœ€è¦è¯»å– duration çš„æœ€æ–°å€¼ï¼Œä½†ä½ ä¸å¸Œæœ›å®ƒå¯¹ duration çš„å˜åŒ–åšå‡ºâ€œååº”â€ã€‚ä½ ä½¿ç”¨ duration æ¥å¯åŠ¨åŠ¨ç”»ï¼Œä½†å¯åŠ¨åŠ¨ç”»ä¸æ˜¯å“åº”å¼çš„ã€‚å°†éå“åº”å¼ä»£ç è¡Œæå–åˆ° Effect Event ä¸­ï¼Œå¹¶ä» Effect ä¸­è°ƒç”¨è¯¥å‡½æ•°

```js
function Welcome({ duration }) {
  const ref = useRef(null);

  const onAppear = useEffectEvent(animation => {
    animation.start(duration); // animation è¿˜å¯ä»¥ä½œä¸ºå‚æ•°âœ…
  });

  useEffect(() => {
    const animation = new FadeInAnimation(ref.current);
    onAppear(animation);
    return () => {
      animation.stop();
    };
  }, []);
```

#### ç¬¬ 4 ä¸ªæŒ‘æˆ˜: å†æ¬¡ä¿®å¤èŠå¤©é‡æ–°è¿æ¥çš„é—®é¢˜

é—®é¢˜ä»£ç ï¼š

```js
export default function ChatRoom({ roomId, createConnection, onMessage }) {
  useEffect(() => {
    const connection = createConnection();
    connection.on("message", (msg) => onMessage(msg));
    connection.connect();
    return () => connection.disconnect();
  }, [createConnection, onMessage]);

  return <h1>æ¬¢è¿æ¥åˆ° {roomId} æˆ¿é—´ï¼</h1>;
}
```

**ä¸»è¦è§£å†³ [createConnection, onMessage] ä¾èµ–é—®é¢˜ âœ…**ï¼Œç›´æ¥ä¸Šæ­£ç¡®ç­”æ¡ˆï¼Œæ›´å¤šåˆ†æçœ‹æ–‡æ¡£å§ï¼š

```js
import { useState, useEffect } from "react";
import { experimental_useEffectEvent as useEffectEvent } from "react";
import {
  createEncryptedConnection,
  createUnencryptedConnection,
} from "./chat.js";

export default function ChatRoom({ roomId, isEncrypted, onMessage }) {
  const onReceiveMessage = useEffectEvent(onMessage);

  useEffect(() => {
    function createConnection() {
      const options = {
        serverUrl: "https://localhost:1234",
        roomId: roomId,
      };
      if (isEncrypted) {
        return createEncryptedConnection(options);
      } else {
        return createUnencryptedConnection(options);
      }
    }

    const connection = createConnection();
    connection.on("message", (msg) => onReceiveMessage(msg));
    connection.connect();
    return () => connection.disconnect();
  }, [roomId, isEncrypted]);

  return <h1>æ¬¢è¿æ¥åˆ° {roomId} æˆ¿é—´ï¼</h1>;
}
```
