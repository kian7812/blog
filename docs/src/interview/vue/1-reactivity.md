# Vue3ä¸­çš„å“åº”å¼

Vue3ä¸­çš„å“åº”å¼æ˜¯å¦‚ä½•è¢«JavaScriptå®ç°çš„ï¼ˆæ¸…é£ï¼‰
- https://zhuanlan.zhihu.com/p/496900151ï¼ˆå…¨ï¼‰ https://juejin.cn/post/7085376517491916807 ï¼ˆä¸å…¨ï¼‰
- ï¼ˆè¿™ç¯‡å°±å¤Ÿäº†~ğŸ‘ğŸ»æ–‡å­—æè¿°æ¯”è¾ƒé€‚åˆæˆ‘ï¼‰
- ï¼ˆä»¥ä¸‹å†…å®¹å‚è€ƒçš„è¿™ç¯‡æ–‡ç« ï¼‰

## å¼€å§‹ä¹‹å‰

æºç ä¸­æ‹¥æœ‰éå¸¸å¤šçš„æ¡ä»¶åˆ†æ”¯åˆ¤æ–­å’Œé”™è¯¯å¤„ç†ï¼ŒåŒæ—¶æºç ä¸­ä¹Ÿè€ƒè™‘äº†æ•°ç»„ã€Setã€Map ä¹‹ç±»çš„æ•°æ®ç»“æ„ã€‚
è¿™é‡Œï¼Œæˆ‘ä»¬ä»…ä»…å…ˆè€ƒè™‘åŸºç¡€çš„å¯¹è±¡ï¼Œè‡³äºå…¶ä»–æ•°æ®ç±»å‹æˆ‘ä¼šåœ¨ä¹‹åçš„æ–‡ç« ä¸­è¯¦ç»†å’Œå¤§å®¶ä¸€ä¸€é“æ¥ã€‚

åœ¨ VueJs ä¸­çš„å­˜åœ¨ä¸€ä¸ªæ ¸å¿ƒçš„ Api Effect ï¼Œè¿™ä¸ª Api åœ¨ Vue 3.2 ç‰ˆæœ¬ä¹‹åæš´éœ²ç»™äº†å¼€å‘è€…å»è°ƒç”¨ï¼Œåœ¨3.2ä¹‹å‰éƒ½æ˜¯ Vuejs å†…éƒ¨æ–¹æ³•å¹¶ä¸æä¾›ç»™å¼€å‘è€…ä½¿ç”¨ã€‚

ç®€å•æ¥è¯´æˆ‘ä»¬`æ‰€æœ‰æ¨¡ç‰ˆï¼ˆç»„ä»¶ï¼‰æœ€ç»ˆéƒ½ä¼šè¢« effect åŒ…è£¹` ï¼Œå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ Effect ä¼šé‡æ–°æ‰§è¡Œï¼Œ`æ‰€ä»¥ vuejs ä¸­çš„å“åº”å¼åŸç†å¯ä»¥è¯´æ˜¯åŸºäº effect æ¥å®ç°çš„` ã€‚

å½“ç„¶è¿™é‡Œä½ ä»…ä»…éœ€è¦äº†è§£ï¼Œ`æœ€ç»ˆç»„ä»¶æ˜¯ä¼šç¼–è¯‘æˆä¸ºä¸€ä¸ªä¸ª effect ï¼Œå½“å“åº”å¼æ•°æ®æ”¹å˜æ—¶ä¼šè§¦å‘ effect å‡½æ•°é‡æ–°æ‰§è¡Œä»è€Œæ›´æ–°æ¸²æŸ“é¡µé¢å³å¯`ã€‚

ä¹‹åæˆ‘ä»¬ä¹Ÿä¼šè¯¦ç»†ä»‹ç» effect å’Œ å“åº”å¼æ˜¯å¦‚ä½•å…³è”åˆ°ä¸€èµ·çš„ã€‚

ä¸€äº›åŸºç¡€çš„ç›®å½•ç»“æ„ï¼š
- reactivity/src/index.ts ç”¨äºç»Ÿä¸€å¼•å…¥å¯¼å‡ºå„ä¸ªæ¨¡å—
- reactivity/src/reactivity.ts ç”¨äºç»´æŠ¤ reactive ç›¸å…³ Apiã€‚
- reactivity/src/effect.ts ç”¨æˆ·ç»´æŠ¤ effect ç›¸å…³ Apiã€‚

## ç®€å•æ€è·¯æ¢³ç†

å…³äº Vuejs æ˜¯å¦‚ä½•å®ç°æ•°æ®å“åº”å¼ï¼Œç®€å•æ¥è¯´å®ƒå†…éƒ¨åˆ©ç”¨äº† Proxy Api è¿›è¡Œäº†è®¿é—®/è®¾ç½®æ•°æ®æ—¶è¿›è¡Œäº†åŠ«æŒã€‚
å¯¹äºæ•°æ®è®¿é—®æ—¶ï¼Œéœ€è¦è¿›è¡Œä¾èµ–æ”¶é›†ã€‚è®°å½•å½“å‰æ•°æ®ä¸­ä¾èµ–äº†å“ªäº› Effect ï¼Œå½“è¿›è¡Œæ•°æ®ä¿®æ”¹æ—¶å€™åŒæ ·ä¼šè¿›è¡Œè§¦å‘æ›´æ–°ï¼Œé‡æ–°æ‰§è¡Œå½“å‰æ•°æ®ä¾èµ–çš„ Effectã€‚ç®€å•æ¥è¯´ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„å“åº”å¼åŸç†ã€‚

å…³äº Effect ä½ å¯ä»¥æš‚æ—¶çš„å°†å®ƒç†è§£æˆä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå½“æ•°æ®æ”¹å˜å‡½æ•°ï¼ˆEffectï¼‰é‡æ–°æ‰§è¡Œä»è€Œå‡½æ•°æ‰§è¡Œå¯¼è‡´é¡µé¢é‡æ–°æ¸²æŸ“ã€‚

## ç®€å•å“åº”å¼3ä¸ªç‚¹

- Proxy ï¼ˆç±»æ¯” definepropertyï¼‰ã€Effect ï¼ˆç±»æ¯” Watcherï¼‰ã€Weakmap ï¼ˆç±»æ¯” Depï¼‰
- èµ·å§‹æ˜¯åˆå§‹åŒ–æ¸²æŸ“ proxy getter > tracker ä¾èµ–æ”¶é›† effectsã€‹
- å“åº”æ•°æ®å˜æ›´ proxy setter > trigger è§¦å‘æ‰§è¡Œä¾èµ–çš„ effects æ‰§è¡Œrenderæ¸²æŸ“ ã€‹
- (æ¯ä¸€æ¬¡getteréƒ½ä¼šé‡æ–°æ”¶é›†ä¾èµ–çš„)

## å¦‚ä½•æŠŠæºç ä¸­çš„å“åº”å¼è¯´å‡ºæ¥å‘¢ï¼ˆæµç¨‹+è°åšäº†ä»€ä¹ˆäº‹æƒ…æè¿°å§ï¼‰

## reactive(obj)

- æ ¹æ®ä¼ å…¥çš„å¯¹è±¡ obj åˆ›å»ºä¸€ä¸ª proxy å“åº”å¼ä»£ç†å¯¹è±¡ã€‚(è€ƒç‚¹proxyä¸defineproperty)
- å½“è®¿é—®proxyå¯¹è±¡å±æ€§æ—¶ï¼Œè§¦å‘ get é™·é˜±ä¼štrackæ”¶é›†effectä¾èµ–ï¼ŒåŒæ—¶è¿”å›å±æ€§å€¼ï¼›
- å½“ä¿®æ”¹proxyå¯¹è±¡å±æ€§å€¼æ—¶ï¼Œè§¦å‘ set é™·é˜±ä¼šè¿›è¡Œtriggerä¾èµ–effectsæ‰§è¡Œï¼ˆeffectæ‰§è¡Œå¦‚renderæ¸²æŸ“ä¼šé‡æ–°è§¦å‘proxyå“åº”å¯¹è±¡çš„getå†é‡æ–°è¿›è¡Œä¾èµ–æ”¶é›†ï¼‰ï¼›


## effect(fn)

- è°ƒç”¨ReactiveEffect(fn)åˆ›å»ºä¸€ä¸ªçš„effectå®ä¾‹
  - ReactiveEffect(fn)
  - å­˜å‚¨fn
  - å®šä¹‰runæ–¹æ³•ï¼ŒæŒ‡å®šå…¨å±€activeEffectå€¼ä¸ºå½“å‰effectå®ä¾‹ï¼ŒåŒæ—¶æ‰§è¡Œfnæ–¹æ³•
- é¦–æ¬¡ç«‹å³æ‰§è¡Œeffectå®ä¾‹runæ–¹æ³•
  - æ‰§è¡Œfnï¼Œå¦‚æœ‰proxyå“åº”å¼æ•°æ®ï¼Œä¼šè§¦å‘getï¼Œä¼šè¿›è¡Œtrackæ”¶é›†ä¾èµ–å½“å‰çš„activeEffectå®ä¾‹ã€‚
- å½“proxyå“åº”å¼æ•°æ®æ”¹å˜æ—¶ï¼Œä¼šè§¦å‘setï¼Œä¼šè¿›è¡Œtriggeræ‰§è¡Œä¾èµ–effectsçš„run fnã€‚
  - æ‰§è¡Œfnï¼Œåˆå›åˆ°ä¸Šä¸€æ­¥ï¼Œè§¦å‘getè¿›è¡Œä¾èµ–æ”¶é›†ã€‚

- effectså®ä¾‹å¯ä»¥æ˜¯ï¼š`ç»„ä»¶ã€è®¡ç®—å±æ€§ã€watcherã€è‡ªå®šä¹‰effect`

## track(target, type, key)

- æ·»åŠ å¯¹åº”çš„Mapå’ŒSetï¼š
  - å±€targetMapï¼Œç”¨äºå­˜å‚¨å“åº”å¼æ•°æ®å’ŒEffectçš„å…³ç³»Hashè¡¨
  - å…¨å±€çš„ WeakMap å­˜å‚¨é”®ä¸ºproxyåŸå§‹å¯¹è±¡targetï¼Œå€¼ä¸ºMapå¯¹è±¡ã€‚
  - è¿™ä¸ªMapå¯¹è±¡ å­˜å‚¨é”®ä¸ºè¢«ä½¿ç”¨åˆ°proxyå¯¹è±¡å±æ€§ï¼Œå€¼ä¸ºSetå¯¹è±¡ï¼Œç”¨æ¥å­˜å‚¨ä¾èµ–çš„effectsã€‚
- æ”¶é›†å½“å‰activeEffectä¾èµ–ã€‚

## trigger(target, type, key, value, oldValue) 

- å–å‡ºå“åº”å¼å±æ€§å¯¹åº” Set ä¸­çš„ effectsï¼Œæ‰§è¡Œeffectä¸­çš„run fnå‡½æ•°
- é‡æ–°è°ƒç”¨effect.run()
- é‡æ–°æ‰§è¡Œæ¸…ç©ºå½“å‰Effectä¾èµ–
- é‡æ–°æ‰§è¡ŒEffectä¸­fnè¿›è¡Œé‡æ–°æ”¶é›†ä¾èµ–ä»¥åŠè§†å›¾æ›´æ–°ã€‚

## é€’å½’å‡½æ•°æ‰§è¡Œæ˜¯æ ˆçš„å½¢å¼

vueç»„ä»¶æ¸²æŸ“ renderå‡½æ•°æ‰§è¡Œä¹Ÿæ˜¯æ ˆçš„å½¢å¼

## WeakMap Map Set
```
WeakMap å…¨å±€
    proxy Map
      å±æ€§ Set
          effects
              effects
```


