# Vueè¿›é˜¶é—®é¢˜


## è¯·è¯´æ˜nextTickçš„åŸç†ã€‚
nextTickæ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡ã€‚

nextTickä¸­çš„å›è°ƒæ˜¯åœ¨ä¸‹æ¬¡Domæ›´æ–°å¾ªç¯ç»“æŸä¹‹åæ‰§è¡Œçš„å»¶è¿Ÿå›è°ƒ
å¯ä»¥ç”¨äºè·å–æ›´æ–°åçš„Dom
Vueä¸­çš„æ•°æ®æ›´æ–°æ˜¯å¼‚æ­¥çš„ï¼Œä½¿ç”¨nextTickå¯ä»¥ä¿è¯ç”¨æˆ·å®šä¹‰çš„é€»è¾‘åœ¨æ›´æ–°ä¹‹åæ‰§è¡Œ

## computedå’Œwatchçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

computedå’Œwatchéƒ½åŸºäºwatcheræ¥å®ç°çš„ã€‚
computedçš„å±æ€§æ˜¯å…·å¤‡ç¼“å­˜çš„ï¼Œä¾èµ–çš„å€¼ä¸å‘ç”Ÿå˜åŒ–ï¼Œå¯¹å…¶å–å€¼æ—¶è®¡ç®—å±æ€§æ–¹æ³•ä¸ä¼šé‡å¤æ‰§è¡Œ
watchæ˜¯ç›‘æ§å€¼çš„å˜åŒ–ï¼Œå½“å€¼å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨å›è°ƒå‡½æ•°

## Vue.setæ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ
vueç»™å¯¹è±¡å’Œæ•°ç»„æœ¬èº«éƒ½å¢åŠ äº†depå±æ€§
å½“ç»™å¯¹è±¡æ–°å¢ä¸å­˜åœ¨çš„å±æ€§çš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘å¯¹è±¡ä¾èµ–çš„watcherå»æ›´æ–°
å½“ä¿®æ”¹æ•°ç»„ç´¢å¼•çš„æ—¶å€™ï¼Œå°±è°ƒç”¨æ•°ç»„æœ¬èº«çš„spliceæ–¹æ³•å»æ›´æ–°æ•°ç»„

## computedå’Œwatchçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
* computedå’Œwatchéƒ½åŸºäºwatcheræ¥å®ç°çš„ã€‚
* computedçš„å±æ€§æ˜¯å…·å¤‡ç¼“å­˜çš„ï¼Œä¾èµ–çš„å€¼ä¸å‘ç”Ÿå˜åŒ–ï¼Œå¯¹å…¶å–å€¼æ—¶è®¡ç®—å±æ€§æ–¹æ³•ä¸ä¼šé‡å¤æ‰§è¡Œ
* watchæ˜¯ç›‘æ§å€¼çš„å˜åŒ–ï¼Œå½“å€¼å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨å›è°ƒå‡½æ•°

computedï¼šé»˜è®¤computedä¹Ÿæ˜¯ä¸€ä¸ªwatcherå…·å¤‡ç¼“å­˜ï¼Œåªæœ‰å½“ä¾èµ–çš„æ•°æ®å˜åŒ–æ—¶æ‰ä¼šè®¡ç®—, å½“æ•°æ®æ²¡æœ‰å˜åŒ–æ—¶, å®ƒä¼šè¯»å–ç¼“å­˜æ•°æ®ã€‚å¦‚æœä¸€ä¸ªæ•°æ®ä¾èµ–äºå…¶ä»–æ•°æ®ï¼Œä½¿ç”¨ computed
watchï¼šæ¯æ¬¡éƒ½éœ€è¦æ‰§è¡Œå‡½æ•°ã€‚ watch æ›´é€‚ç”¨äºæ•°æ®å˜åŒ–æ—¶çš„å¼‚æ­¥æ“ä½œã€‚å¦‚æœéœ€è¦åœ¨æŸä¸ªæ•°æ®å˜åŒ–æ—¶åšä¸€äº›äº‹æƒ…ï¼Œä½¿ç”¨watchã€‚
methodï¼šåªè¦æŠŠæ–¹æ³•ç”¨åˆ°æ¨¡æ¿ä¸Šäº†,æ¯æ¬¡ä¸€å˜åŒ–å°±ä¼šé‡æ–°æ¸²æŸ“è§†å›¾ï¼Œæ€§èƒ½å¼€é”€å¤§


FinGet|æˆ‘æƒ³ç”¨å¤§ç™½è¯è®²æ¸…æ¥šwatchå’Œcomputedï¼šhttps://segmentfault.com/a/1190000039161403
åˆ›å®‡å‰ç«¯|åšé¢è¯•çš„ä¸å€’ç¿ï¼šæµ…è°ˆ Vue ä¸­ computed å®ç°åŸç† https://segmentfault.com/a/1190000016387717

// æœ‰ä¸ªå¤§æ¦‚çš„äº†è§£äº†ï¼Œç¨å¾®å†ç»†åŒ–ä¸‹ï¼Œå¯ä»¥ç”¨åˆ°é¢è¯•äº†ï¼›
// ç†è§£è¿™å—å¯¹ç†è§£æºç ï¼Œæœ‰å¾ˆå¤§å¸®åŠ©ï¼Œçœ‹æ¥æ˜¯è¿˜æ˜¯é¢è¯•ä¸ºå¯¼å‘çš„æ¨åŠ¨å­¦ä¹ ï¼Œè¿˜æ˜¯æŒºé è°±çš„ã€‚


Watcheråˆ†ä¸ºï¼šæ¸²æŸ“Watcherã€ç”¨æˆ·Watcherã€computedWatcherï¼Œå³computedã€watchã€ç»„ä»¶æ¸²æŸ“éƒ½æ˜¯é€šè¿‡Watcherå®Œæˆçš„ã€‚

watcherï¼šä¾¦å¬å™¨ã€è§‚å¯Ÿè€…
depï¼šè®¢é˜…å™¨ã€ä¾èµ–æ”¶é›†(è§‚å¯Ÿè€…|ä¾¦å¬å™¨)





## Vue2.0 å“åº”å¼æ•°æ®çš„åŸç†
æ•´ä½“æ€è·¯æ˜¯æ•°æ®åŠ«æŒ+è§‚å¯Ÿè€…æ¨¡å¼
å¯¹è±¡å†…éƒ¨é€šè¿‡ defineReactive æ–¹æ³•ï¼Œä½¿ç”¨ Object.defineProperty å°†å±æ€§è¿›è¡ŒåŠ«æŒï¼ˆåªä¼šåŠ«æŒå·²ç»å­˜åœ¨çš„å±æ€§ï¼‰ï¼Œæ•°ç»„åˆ™æ˜¯é€šè¿‡é‡å†™æ•°ç»„æ–¹æ³•æ¥å®ç°ã€‚å½“é¡µé¢ä½¿ç”¨å¯¹åº”å±æ€§æ—¶ï¼Œæ¯ä¸ªå±æ€§éƒ½æ‹¥æœ‰è‡ªå·±çš„ dep å±æ€§ï¼Œå­˜æ”¾ä»–æ‰€ä¾èµ–çš„ watcherï¼ˆä¾èµ–æ”¶é›†ï¼‰ï¼Œå½“å±æ€§å˜åŒ–åä¼šé€šçŸ¥è‡ªå·±å¯¹åº”çš„ watcher å»æ›´æ–°(æ´¾å‘æ›´æ–°)ã€‚
ç›¸å…³ä»£ç å¦‚ä¸‹

```js
class Observer {
  // è§‚æµ‹å€¼
  constructor(value) {
    this.walk(value);
  }
  walk(data) {
    // å¯¹è±¡ä¸Šçš„æ‰€æœ‰å±æ€§ä¾æ¬¡è¿›è¡Œè§‚æµ‹
    let keys = Object.keys(data);
    for (let i = 0; i < keys.length; i++) {
      let key = keys[i];
      let value = data[key];
      defineReactive(data, key, value);
    }
  }
}
// Object.definePropertyæ•°æ®åŠ«æŒæ ¸å¿ƒ å…¼å®¹æ€§åœ¨ie9ä»¥åŠä»¥ä¸Š
function defineReactive(data, key, value) {
  observe(value); // é€’å½’å…³é”®
  // --å¦‚æœvalueè¿˜æ˜¯ä¸€ä¸ªå¯¹è±¡ä¼šç»§ç»­èµ°ä¸€éodefineReactive å±‚å±‚éå†ä¸€ç›´åˆ°valueä¸æ˜¯å¯¹è±¡æ‰åœæ­¢
  //   æ€è€ƒï¼Ÿå¦‚æœVueæ•°æ®åµŒå¥—å±‚çº§è¿‡æ·± >>æ€§èƒ½ä¼šå—å½±å“
  Object.defineProperty(data, key, {
    get() {
      console.log("è·å–å€¼");

      //éœ€è¦åšä¾èµ–æ”¶é›†è¿‡ç¨‹ è¿™é‡Œä»£ç æ²¡å†™å‡ºæ¥
      return value;
    },
    set(newValue) {
      if (newValue === value) return;
      console.log("è®¾ç½®å€¼");
      //éœ€è¦åšæ´¾å‘æ›´æ–°è¿‡ç¨‹ è¿™é‡Œä»£ç æ²¡å†™å‡ºæ¥
      value = newValue;
    },
  });
}
export function observe(value) {
  // å¦‚æœä¼ è¿‡æ¥çš„æ˜¯å¯¹è±¡æˆ–è€…æ•°ç»„ è¿›è¡Œå±æ€§åŠ«æŒ
  if (
    Object.prototype.toString.call(value) === "[object Object]" ||
    Array.isArray(value)
  ) {
    return new Observer(value);
  }
}
```
## Vueä¸­å¦‚ä½•æ£€æµ‹æ•°ç»„çš„å˜åŒ–ï¼Ÿ
vueä¸­å¯¹æ•°ç»„æ²¡æœ‰è¿›è¡ŒdefinePropertyï¼Œè€Œæ˜¯é‡å†™äº†æ•°ç»„çš„7ä¸ªæ–¹æ³•ã€‚
åˆ†åˆ«æ˜¯ï¼š

push
shift
pop
splice
unshift
sort
reverse

å› ä¸ºè¿™äº›æ–¹æ³•éƒ½ä¼šæ”¹å˜æ•°ç»„æœ¬èº«ã€‚
æ•°ç»„é‡Œçš„ç´¢å¼•å’Œé•¿åº¦æ˜¯æ— æ³•è¢«ç›‘æ§çš„ã€‚



## Vue å¦‚ä½•æ£€æµ‹æ•°ç»„å˜åŒ–

æ•°ç»„è€ƒè™‘æ€§èƒ½åŸå› æ²¡æœ‰ç”¨ defineProperty å¯¹æ•°ç»„çš„æ¯ä¸€é¡¹è¿›è¡Œæ‹¦æˆªï¼Œè€Œæ˜¯é€‰æ‹©å¯¹ 7 ç§æ•°ç»„ï¼ˆpush,shift,pop,splice,unshift,sort,reverseï¼‰æ–¹æ³•è¿›è¡Œé‡å†™(AOP åˆ‡ç‰‡æ€æƒ³)

æ‰€ä»¥åœ¨ Vue ä¸­ä¿®æ”¹æ•°ç»„çš„ç´¢å¼•å’Œé•¿åº¦æ˜¯æ— æ³•ç›‘æ§åˆ°çš„ã€‚éœ€è¦é€šè¿‡ä»¥ä¸Š 7 ç§å˜å¼‚æ–¹æ³•ä¿®æ”¹æ•°ç»„æ‰ä¼šè§¦å‘æ•°ç»„å¯¹åº”çš„ watcher è¿›è¡Œæ›´æ–°

ç›¸å…³ä»£ç å¦‚ä¸‹

```js
// src/obserber/array.js
// å…ˆä¿ç•™æ•°ç»„åŸå‹
const arrayProto = Array.prototype;
// ç„¶åå°†arrayMethodsç»§æ‰¿è‡ªæ•°ç»„åŸå‹
// è¿™é‡Œæ˜¯é¢å‘åˆ‡ç‰‡ç¼–ç¨‹æ€æƒ³ï¼ˆAOPï¼‰--ä¸ç ´åå°è£…çš„å‰æä¸‹ï¼ŒåŠ¨æ€çš„æ‰©å±•åŠŸèƒ½
export const arrayMethods = Object.create(arrayProto);
let methodsToPatch = [
  "push",
  "pop",
  "shift",
  "unshift",
  "splice",
  "reverse",
  "sort",
];
methodsToPatch.forEach((method) => {
  arrayMethods[method] = function (...args) {
    //   è¿™é‡Œä¿ç•™åŸå‹æ–¹æ³•çš„æ‰§è¡Œç»“æœ
    const result = arrayProto[method].apply(this, args);
    // è¿™å¥è¯æ˜¯å…³é”®
    // thisä»£è¡¨çš„å°±æ˜¯æ•°æ®æœ¬èº« æ¯”å¦‚æ•°æ®æ˜¯{a:[1,2,3]} é‚£ä¹ˆæˆ‘ä»¬ä½¿ç”¨a.push(4)  thiså°±æ˜¯a  obå°±æ˜¯a.__ob__ è¿™ä¸ªå±æ€§å°±æ˜¯ä¸Šæ®µä»£ç å¢åŠ çš„ ä»£è¡¨çš„æ˜¯è¯¥æ•°æ®å·²ç»è¢«å“åº”å¼è§‚å¯Ÿè¿‡äº†æŒ‡å‘Observerå®ä¾‹
    const ob = this.__ob__;

    // è¿™é‡Œçš„æ ‡å¿—å°±æ˜¯ä»£è¡¨æ•°ç»„æœ‰æ–°å¢æ“ä½œ
    let inserted;
    switch (method) {
      case "push":
      case "unshift":
        inserted = args;
        break;
      case "splice":
        inserted = args.slice(2);
      default:
        break;
    }
    // å¦‚æœæœ‰æ–°å¢çš„å…ƒç´  insertedæ˜¯ä¸€ä¸ªæ•°ç»„ è°ƒç”¨Observerå®ä¾‹çš„observeArrayå¯¹æ•°ç»„æ¯ä¸€é¡¹è¿›è¡Œè§‚æµ‹
    if (inserted) ob.observeArray(inserted);
    // ä¹‹åå’±ä»¬è¿˜å¯ä»¥åœ¨è¿™é‡Œæ£€æµ‹åˆ°æ•°ç»„æ”¹å˜äº†ä¹‹åä»è€Œè§¦å‘è§†å›¾æ›´æ–°çš„æ“ä½œ--åç»­æºç ä¼šæ­æ™“
    return result;
  };
});
```

## Vue3.0 å’Œ 2.0 çš„å“åº”å¼åŸç†åŒºåˆ«
Vue3.x æ”¹ç”¨ Proxy æ›¿ä»£ Object.definePropertyã€‚å› ä¸º Proxy å¯ä»¥ç›´æ¥ç›‘å¬å¯¹è±¡å’Œæ•°ç»„çš„å˜åŒ–ï¼Œå¹¶ä¸”æœ‰å¤šè¾¾ 13 ç§æ‹¦æˆªæ–¹æ³•ã€‚

ç›¸å…³ä»£ç å¦‚ä¸‹

```js
import { mutableHandlers } from "./baseHandlers"; // ä»£ç†ç›¸å…³é€»è¾‘
import { isObject } from "./util"; // å·¥å…·æ–¹æ³•

export function reactive(target) {
  // æ ¹æ®ä¸åŒå‚æ•°åˆ›å»ºä¸åŒå“åº”å¼å¯¹è±¡
  return createReactiveObject(target, mutableHandlers);
}
function createReactiveObject(target, baseHandler) {
  if (!isObject(target)) {
    return target;
  }
  const observed = new Proxy(target, baseHandler);
  return observed;
}

const get = createGetter();
const set = createSetter();

function createGetter() {
  return function get(target, key, receiver) {
    // å¯¹è·å–çš„å€¼è¿›è¡Œæ”¾å°„
    const res = Reflect.get(target, key, receiver);
    console.log("å±æ€§è·å–", key);
    if (isObject(res)) {
      // å¦‚æœè·å–çš„å€¼æ˜¯å¯¹è±¡ç±»å‹ï¼Œåˆ™è¿”å›å½“å‰å¯¹è±¡çš„ä»£ç†å¯¹è±¡
      return reactive(res);
    }
    return res;
  };
}
function createSetter() {
  return function set(target, key, value, receiver) {
    const oldValue = target[key];
    const hadKey = hasOwn(target, key);
    const result = Reflect.set(target, key, value, receiver);
    if (!hadKey) {
      console.log("å±æ€§æ–°å¢", key, value);
    } else if (hasChanged(value, oldValue)) {
      console.log("å±æ€§å€¼è¢«ä¿®æ”¹", key, value);
    }
    return result;
  };
}
export const mutableHandlers = {
  get, // å½“è·å–å±æ€§æ—¶è°ƒç”¨æ­¤æ–¹æ³•
  set, // å½“ä¿®æ”¹å±æ€§æ—¶è°ƒç”¨æ­¤æ–¹æ³•
};

```

##  nextTick

nextTick ä¸­çš„å›è°ƒæ˜¯åœ¨ä¸‹æ¬¡ DOM æ›´æ–°å¾ªç¯ç»“æŸä¹‹åæ‰§è¡Œçš„å»¶è¿Ÿå›è°ƒã€‚åœ¨ä¿®æ”¹æ•°æ®ä¹‹åç«‹å³ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œè·å–æ›´æ–°åçš„ DOMã€‚ä¸»è¦æ€è·¯å°±æ˜¯é‡‡ç”¨å¾®ä»»åŠ¡ä¼˜å…ˆçš„æ–¹å¼è°ƒç”¨å¼‚æ­¥æ–¹æ³•å»æ‰§è¡Œ nextTick åŒ…è£…çš„æ–¹æ³•

```js

let callbacks = [];
let pending = false;
function flushCallbacks() {
  pending = false; //æŠŠæ ‡å¿—è¿˜åŸä¸ºfalse
  // ä¾æ¬¡æ‰§è¡Œå›è°ƒ
  for (let i = 0; i < callbacks.length; i++) {
    callbacks[i]();
  }
}
let timerFunc; //å®šä¹‰å¼‚æ­¥æ–¹æ³•  é‡‡ç”¨ä¼˜é›…é™çº§
if (typeof Promise !== "undefined") {
  // å¦‚æœæ”¯æŒpromise
  const p = Promise.resolve();
  timerFunc = () => {
    p.then(flushCallbacks);
  };
} else if (typeof MutationObserver !== "undefined") {
  // MutationObserver ä¸»è¦æ˜¯ç›‘å¬domå˜åŒ– ä¹Ÿæ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•
  let counter = 1;
  const observer = new MutationObserver(flushCallbacks);
  const textNode = document.createTextNode(String(counter));
  observer.observe(textNode, {
    characterData: true,
  });
  timerFunc = () => {
    counter = (counter + 1) % 2;
    textNode.data = String(counter);
  };
} else if (typeof setImmediate !== "undefined") {
  // å¦‚æœå‰é¢éƒ½ä¸æ”¯æŒ åˆ¤æ–­setImmediate
  timerFunc = () => {
    setImmediate(flushCallbacks);
  };
} else {
  // æœ€åé™çº§é‡‡ç”¨setTimeout
  timerFunc = () => {
    setTimeout(flushCallbacks, 0);
  };
}

export function nextTick(cb) {
  // é™¤äº†æ¸²æŸ“watcher  è¿˜æœ‰ç”¨æˆ·è‡ªå·±æ‰‹åŠ¨è°ƒç”¨çš„nextTick ä¸€èµ·è¢«æ”¶é›†åˆ°æ•°ç»„
  callbacks.push(cb);
  if (!pending) {
    // å¦‚æœå¤šæ¬¡è°ƒç”¨nextTick  åªä¼šæ‰§è¡Œä¸€æ¬¡å¼‚æ­¥ ç­‰å¼‚æ­¥é˜Ÿåˆ—æ¸…ç©ºä¹‹åå†æŠŠæ ‡å¿—å˜ä¸ºfalse
    pending = true;
    timerFunc();
  }
}

```




## Vue.set æ–¹æ³•åŸç†

äº†è§£ Vue å“åº”å¼åŸç†çš„åŒå­¦éƒ½çŸ¥é“åœ¨ä¸¤ç§æƒ…å†µä¸‹ä¿®æ”¹æ•°æ® Vue æ˜¯ä¸ä¼šè§¦å‘è§†å›¾æ›´æ–°çš„
1.åœ¨å®ä¾‹åˆ›å»ºä¹‹åæ·»åŠ æ–°çš„å±æ€§åˆ°å®ä¾‹ä¸Šï¼ˆç»™å“åº”å¼å¯¹è±¡æ–°å¢å±æ€§ï¼‰
2.ç›´æ¥æ›´æ”¹æ•°ç»„ä¸‹æ ‡æ¥ä¿®æ”¹æ•°ç»„çš„å€¼
Vue.set æˆ–è€…è¯´æ˜¯$set åŸç†å¦‚ä¸‹
å› ä¸ºå“åº”å¼æ•°æ® æˆ‘ä»¬ç»™å¯¹è±¡å’Œæ•°ç»„æœ¬èº«éƒ½å¢åŠ äº†__ob__å±æ€§ï¼Œä»£è¡¨çš„æ˜¯ Observer å®ä¾‹ã€‚å½“ç»™å¯¹è±¡æ–°å¢ä¸å­˜åœ¨çš„å±æ€§ é¦–å…ˆä¼šæŠŠæ–°çš„å±æ€§è¿›è¡Œå“åº”å¼è·Ÿè¸ª ç„¶åä¼šè§¦å‘å¯¹è±¡__ob__çš„ dep æ”¶é›†åˆ°çš„ watcher å»æ›´æ–°ï¼Œå½“ä¿®æ”¹æ•°ç»„ç´¢å¼•æ—¶æˆ‘ä»¬è°ƒç”¨æ•°ç»„æœ¬èº«çš„ splice æ–¹æ³•å»æ›´æ–°æ•°ç»„

```js
export function set(target: Array | Object, key: any, val: any): any {
  // å¦‚æœæ˜¯æ•°ç»„ è°ƒç”¨æˆ‘ä»¬é‡å†™çš„spliceæ–¹æ³• (è¿™æ ·å¯ä»¥æ›´æ–°è§†å›¾)
  if (Array.isArray(target) && isValidArrayIndex(key)) {
    target.length = Math.max(target.length, key);
    target.splice(key, 1, val);
    return val;
  }
  // å¦‚æœæ˜¯å¯¹è±¡æœ¬èº«çš„å±æ€§ï¼Œåˆ™ç›´æ¥æ·»åŠ å³å¯
  if (key in target && !(key in Object.prototype)) {
    target[key] = val;
    return val;
  }
  const ob = (target: any).__ob__;

  // å¦‚æœä¸æ˜¯å“åº”å¼çš„ä¹Ÿä¸éœ€è¦å°†å…¶å®šä¹‰æˆå“åº”å¼å±æ€§
  if (!ob) {
    target[key] = val;
    return val;
  }
  // å°†å±æ€§å®šä¹‰æˆå“åº”å¼çš„
  defineReactive(ob.value, key, val);
  // é€šçŸ¥è§†å›¾æ›´æ–°
  ob.dep.notify();
  return val;
}

```


## vm.$set çš„å®ç°åŸç†

```
function set(target, key, val) {
    const ob = target.__ob__
    defineReactive(ob.value, key, val)
    ob.dep.notify()
    return val
}
```

å½“å‘ä¸€ä¸ªå“åº”å¼å¯¹è±¡æ–°å¢å±æ€§çš„æ—¶å€™ï¼Œéœ€è¦å¯¹è¿™ä¸ªå±æ€§é‡æ–°è¿›è¡Œå“åº”å¼çš„è®¾ç½®ï¼Œå³ä½¿ç”¨ defineReactive å°†æ–°å¢çš„å±æ€§è½¬æ¢æˆ getter/setterã€‚
æˆ‘ä»¬åœ¨å‰é¢è®²è¿‡æ¯ä¸€ä¸ªå¯¹è±¡æ˜¯ä¼šé€šè¿‡ Observer ç±»å‹è¿›è¡ŒåŒ…è£…çš„ï¼Œå¹¶åœ¨ Observer ç±»é‡Œé¢åˆ›å»ºä¸€ä¸ªå±äºè¿™ä¸ªå¯¹è±¡çš„ä¾èµ–æ”¶é›†å­˜å‚¨å¯¹è±¡ depï¼Œ æœ€ååœ¨æ–°å¢å±æ€§çš„æ—¶å€™å°±é€šè¿‡è¿™ä¸ªä¾èµ–å¯¹è±¡è¿›è¡Œé€šçŸ¥ç›¸å…³ Watcher è¿›è¡Œå˜åŒ–æ›´æ–°ã€‚








## å‚è€ƒ


- https://juejin.cn/post/6961222829979697165
- https://juejin.cn/post/7043074656047202334



## Vue2 å“åº”å¼/åŒå‘ç»‘åŸç†
Vue æ•°æ®åŒå‘ç»‘å®šæ˜¯æŒ‡ï¼šæ•°æ®å˜åŒ–æ›´æ–°è§†å›¾ï¼Œè§†å›¾å˜åŒ–æ›´æ–°æ•°æ®ã€‚
Vue å“åº”å¼åŸç†æ˜¯é‡‡ç”¨æ•°æ®åŠ«æŒç»“åˆå‘å¸ƒè€…-è®¢é˜…è€…æ¨¡å¼çš„æ–¹å¼ï¼Œé€šè¿‡Object.defineProperty()æ¥åŠ«æŒå„ä¸ªå±æ€§çš„setterï¼Œgetterï¼Œåœ¨æ•°æ®å˜åŠ¨æ—¶å‘å¸ƒæ¶ˆæ¯ç»™è®¢é˜…è€…ï¼Œè§¦å‘æ›´æ–°ã€‚
~ Vueå“åº”å¼åŸç†ï¼ŸVueåŒå‘ç»‘å®šçš„åŸç†ï¼Ÿ
åŸç†1ï¼š
vue.js æ˜¯é‡‡ç”¨æ•°æ®åŠ«æŒç»“åˆå‘å¸ƒè€…-è®¢é˜…è€…æ¨¡å¼çš„æ–¹å¼ï¼Œé€šè¿‡Object.defineProperty()æ¥åŠ«æŒï¼ˆç»„ä»¶dataé€‰é¡¹çš„ï¼‰å„ä¸ªå±æ€§çš„setterã€getterï¼Œåœ¨æ•°æ®å˜åŠ¨æ—¶å‘å¸ƒæ¶ˆæ¯ç»™è®¢é˜…è€…ï¼Œè§¦å‘ç›¸åº”çš„ç›‘å¬å›è°ƒã€‚

åŸç†2ï¼š
1ã€Vue å°†éå†æ­¤dataå¯¹è±¡æ‰€æœ‰çš„ propertyï¼Œå¹¶ä½¿ç”¨ Object.defineProperty æŠŠè¿™äº› property å…¨éƒ¨è½¬ä¸º getter/setterã€‚
2ã€æ¯ä¸ªç»„ä»¶å®ä¾‹éƒ½å¯¹åº”ä¸€ä¸ª watcher å®ä¾‹ï¼Œå®ƒä¼šåœ¨ç»„ä»¶æ¸²æŸ“çš„è¿‡ç¨‹ä¸­æŠŠâ€œæ¥è§¦â€è¿‡çš„æ•°æ® property è®°å½•ä¸ºä¾èµ–ã€‚ä¹‹åå½“ä¾èµ–é¡¹çš„ setter è§¦å‘æ—¶ï¼Œä¼šé€šçŸ¥ watcherï¼Œä»è€Œä½¿å®ƒå…³è”çš„ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚

## ç®€è¿°ï¼Œå¦‚ä½•è¿½è¸ªå˜åŒ–
* Vue å°†éå†æ•°æ®å¯¹è±¡æ‰€æœ‰çš„ propertyï¼Œå¹¶ä½¿ç”¨ Object.defineProperty æŠŠè¿™äº› property å…¨éƒ¨è½¬ä¸º getter/setterï¼ŒåŒæ—¶è¿›è¡Œä¾èµ–æ”¶é›†ã€‚
* æ¯ä¸ªç»„ä»¶å®ä¾‹éƒ½å¯¹åº”ä¸€ä¸ª watcher å®ä¾‹ï¼Œå®ƒä¼šåœ¨ç»„ä»¶æ¸²æŸ“çš„è¿‡ç¨‹ä¸­æŠŠâ€œæ¥è§¦â€è¿‡çš„æ•°æ® property è®°å½•ä¸ºä¾èµ–ã€‚å½“ä¾èµ–é¡¹çš„ setter è§¦å‘æ—¶ï¼Œä¼šé€šçŸ¥ watcherï¼Œä»è€Œä½¿å®ƒå…³è”çš„ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚

## è°ˆè°ˆä½ å¯¹Vueä¸­å“åº”å¼æ•°æ®çš„ç†è§£ï¼Ÿ
æ•°ç»„å’Œå¯¹è±¡ç±»å‹çš„å€¼å˜åŒ–çš„æ—¶å€™ï¼Œé€šè¿‡defineReactiveæ–¹æ³•ï¼Œå€ŸåŠ©äº†definePropertyï¼Œå°†æ‰€æœ‰çš„å±æ€§æ·»åŠ äº†getterå’Œsetterã€‚ç”¨æˆ·åœ¨å–å€¼å’Œè®¾ç½®çš„æ—¶å€™ï¼Œå¯ä»¥è¿›è¡Œä¸€äº›æ“ä½œã€‚
ç¼ºé™·ï¼šåªèƒ½ç›‘æ§æœ€å¤–å±‚çš„å±æ€§ï¼Œå¦‚æœæ˜¯å¤šå±‚çš„ï¼Œå°±è¦è¿›è¡Œå…¨é‡é€’å½’ã€‚
geté‡Œé¢ä¼šåšä¾èµ–æœé›†ï¼ˆdep[watcher, watcher]ï¼‰ seté‡Œé¢ä¼šåšæ•°æ®æ›´æ–°ï¼ˆnotifyï¼Œé€šçŸ¥watcheræ›´æ–°ï¼‰


## Vueä¸­å¦‚ä½•è¿›è¡Œä¾èµ–æ”¶é›†çš„ï¼Ÿ
Vueåˆå§‹åŒ–çš„æ—¶å€™ï¼ŒæŒ‚è½½ä¹‹åä¼šè¿›è¡Œç¼–è¯‘ã€‚ç”ŸæˆrenderFunctionã€‚
å½“å–å€¼çš„æ—¶å€™ï¼Œå°±ä¼šæœé›†watcherï¼Œæ”¾åˆ°depé‡Œé¢ã€‚
å½“ç”¨æˆ·æ›´æ”¹å€¼çš„æ—¶å€™ï¼Œå°±ä¼šé€šçŸ¥watcherï¼Œå»æ›´æ–°è§†å›¾ã€‚

## è®¡ç®—å±æ€§ç¼“å­˜ vs æ–¹æ³•

```
è®¡ç®—å±æ€§æ˜¯åŸºäºå®ƒä»¬çš„å“åº”å¼ä¾èµ–è¿›è¡Œç¼“å­˜çš„ï¼Œcomputedçš„å€¼åœ¨getteræ‰§è¡Œåæ˜¯ä¼šç¼“å­˜ï¼Œåªæœ‰åœ¨å®ƒä¾èµ–çš„å“åº”å¼å±æ€§å€¼æ”¹å˜ä¹‹åï¼Œä¸‹ä¸€æ¬¡è·å–computedçš„å€¼æ—¶æ‰ä¼šé‡æ–°è°ƒç”¨å¯¹åº”çš„getteræ¥è®¡ç®—ã€‚

è€Œæ¨¡æ¿é‡Œçš„æ–¹æ³•æˆ–æ˜¯æ¨¡æ¿é‡Œçš„è¡¨è¾¾å¼ï¼Œæ¯å½“è§¦å‘é‡æ–°æ¸²æŸ“æ—¶ï¼Œå°†æ€»ä¼šå†æ¬¡æ‰§è¡Œæ–¹æ³•å’Œè¡¨è¾¾å¼ã€‚è¿˜æœ‰filters

è¡¥å……ï¼š
åªè¦æ¨¡æ¿çš„æ¸²æŸ“watcherï¼Œä¾èµ–çš„å±æ€§ï¼Œå‘ç”Ÿæ”¹å˜ï¼Œå°±è§¦å‘é‡æ–°æ¸²æŸ“ï¼Œæ¦‚ç‡è¿˜æ˜¯å¾ˆé«˜çš„ï¼Œ
æ¯å½“è§¦å‘æ¸²æŸ“æ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œç»„ä»¶æ¨¡æ¿é‡Œæ‰€æœ‰çš„æ–¹æ³•å’Œè¡¨è¾¾å¼ï¼Œ
è€Œè®¡ç®—å±æ€§ä¾èµ–çš„å±æ€§æ²¡æ”¹å˜ï¼Œä¼šç›´æ¥è¿”å›ç¼“å­˜å€¼ï¼ˆcomputed-watcherçš„valueï¼‰ï¼Œè¿™å°†å¾ˆå¤§æ¦‚ç‡æé«˜è®¡ç®—é€Ÿåº¦ã€‚
åº”ç”¨åœºæ™¯ï¼šé€‚ç”¨äºé‡æ–°è®¡ç®—æ¯”è¾ƒè´¹æ—¶ä¸ç”¨é‡å¤æ•°æ®è®¡ç®—çš„ç¯å¢ƒã€‚
è¡¥å……ï¼šè®¡ç®—å±æ€§æ˜¯ä¸ªå®ï¼Œç›¸æ¯”äºæ–¹æ³•ã€{{ è¡¨è¾¾å¼è®¡ç®— }}ï¼Œç”±æ­¤å¼•å‡ºç»„ä»¶æ‹†åˆ†ç²’åº¦è¦åˆé€‚çš„å°å°±å¯ä»¥æ›´å°ç²’åº¦çš„è§¦å‘æ¸²æŸ“
```

## computed å’Œ watch çš„åŒºåˆ«å’Œè¿ç”¨çš„åœºæ™¯ï¼Ÿ
* computedï¼š
è®¡ç®—å±æ€§æ˜¯ä¾èµ–å…¶å®ƒå±æ€§å€¼ï¼Œå¹¶ä¸”å…·æœ‰ç¼“å­˜ç‰¹æ€§ï¼Œåªæœ‰å®ƒä¾èµ–çš„å±æ€§å€¼å‘ç”Ÿæ”¹å˜ï¼Œä¸‹ä¸€æ¬¡è·å– computed çš„å€¼æ—¶æ‰ä¼šé‡æ–°è®¡ç®— computed çš„å€¼ï¼›
è®¡ç®—å±æ€§å¯é…ç½®ä¸€ä¸ªgetå’Œä¸€ä¸ªsetæ–¹æ³•ï¼Œå½“ä¾èµ–çš„å“åº”å¼æ•°æ®å˜åŒ–æ—¶è°ƒç”¨getæ–¹æ³•ï¼Œå½“è®¡ç®—å±æ€§è¢«èµ‹å€¼æ—¶è°ƒç”¨setæ–¹æ³•ã€‚
è®¡ç®—å±æ€§æ˜¯åŒæ­¥ã€‚

* watchï¼š
æ²¡æœ‰ç¼“å­˜æ€§ï¼Œæ›´å¤šçš„æ˜¯è§‚å¯Ÿä½œç”¨ï¼›
å½“ç›‘å¬çš„æ•°æ®å˜åŒ–æ—¶ä¼šæ‰§è¡Œå›è°ƒï¼›
ç›‘å¬çš„å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€æ–°çš„å€¼ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¾“å…¥ä¹‹å‰çš„å€¼ï¼›
å½“æˆ‘ä»¬éœ€è¦æ·±åº¦ç›‘å¬å¯¹è±¡ä¸­çš„å±æ€§æ—¶ï¼Œå¯ä»¥é…ç½®deepï¼štrueé€‰é¡¹ï¼Œè¿™æ ·ä¾¿ä¼šå¯¹å¯¹è±¡ä¸­çš„æ¯ä¸€é¡¹è¿›è¡Œç›‘å¬ã€‚
ç›‘å¬å±æ€§æ”¯æŒå¼‚æ­¥æ“ä½œã€‚

* è¿ç”¨åœºæ™¯ï¼š
computedï¼šå½“æˆ‘ä»¬éœ€è¦è¿›è¡Œæ•°å€¼è®¡ç®—ï¼Œå¹¶ä¸”ä¾èµ–äºå…¶å®ƒæ•°æ®æ—¶ï¼Œåº”è¯¥ä½¿ç”¨ computedï¼Œå› ä¸ºå¯ä»¥åˆ©ç”¨ computed çš„ç¼“å­˜ç‰¹æ€§ï¼Œé¿å…æ¯æ¬¡è·å–å€¼æ—¶ï¼Œéƒ½è¦é‡æ–°è®¡ç®—ï¼›
  // é‡ç‚¹æ˜¯è§¦å‘é‡æ–°æ¸²æŸ“æ—¶ï¼Œå¦‚æœä¾èµ–å±æ€§æ²¡å˜ï¼Œè®¡ç®—å±æ€§ç›´æ¥å–ç¼“å­˜ï¼Œä¸éœ€è¦é‡æ–°è®¡ç®—çš„ï¼Œå› ä¸ºæœ‰ç»„ä»¶é‡æ–°æ¸²æŸ“æ˜¯é¢‘å‘çš„ã€‚
watchï¼šå½“æˆ‘ä»¬éœ€è¦åœ¨æ•°æ®å˜åŒ–æ—¶æ‰§è¡Œå¼‚æ­¥æˆ–å¼€é”€è¾ƒå¤§çš„æ“ä½œæ—¶ï¼Œåº”è¯¥ä½¿ç”¨ watchã€‚

## watch-deep ä½¿ç”¨å­—ç¬¦ä¸²å½¢å¼ç›‘å¬ï¼Œä¼˜åŒ–æ·±åº¦ç›‘å¬ï¼Ÿ
deepçš„æ„æ€å°±æ˜¯æ·±å…¥è§‚å¯Ÿï¼Œç›‘å¬å™¨ä¼šä¸€å±‚å±‚çš„å¾€ä¸‹éå†ï¼Œç»™å¯¹è±¡çš„æ‰€æœ‰å±æ€§éƒ½åŠ ä¸Šè¿™ä¸ªç›‘å¬å™¨ï¼Œ
ä½†æ˜¯è¿™æ ·æ€§èƒ½å¼€é”€å°±ä¼šéå¸¸å¤§äº†ï¼Œä»»ä½•ä¿®æ”¹objé‡Œé¢ä»»ä½•ä¸€ä¸ªå±æ€§éƒ½ä¼šè§¦å‘è¿™ä¸ªç›‘å¬å™¨é‡Œçš„ handler
watch: {
  obj: {
    handler(newName, oldName) {
      console.log('obj.a changed');
    },
    immediate: true,
    deep: true
  }
}

ä¼˜åŒ–ï¼šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²çš„å½¢å¼ç›‘å¬
watch: {
  'obj.a': {
    handler(newName, oldName) {
      console.log('obj.a changed');
    },
    immediate: true,
    // deep: true
  }
}

è¿™æ ·Vue.jsæ‰ä¼šä¸€å±‚ä¸€å±‚è§£æä¸‹å»ï¼Œç›´åˆ°é‡åˆ°å±æ€§aï¼Œç„¶åæ‰ç»™aè®¾ç½®ç›‘å¬å‡½æ•°ã€‚

å¦‚æœæ²¡æœ‰å†™åˆ°ç»„ä»¶ä¸­ï¼Œä¸è¦å¿˜è®°ä½¿ç”¨unWatchæ‰‹åŠ¨æ³¨é”€å“¦ã€‚

## nextTickæ˜¯åšä»€ä¹ˆâ½¤çš„ï¼Œå…¶åŸç†æ˜¯ä»€ä¹ˆ?ï¼ˆğŸ‘ğŸ»ï¼‰
èƒ½å›ç­”æ¸…æ¥šè¿™é“é—®é¢˜çš„å‰æï¼Œæ˜¯æ¸…æ¥š EventLoop è¿‡ç¨‹ã€‚
ä½œç”¨* åœ¨ä¸‹æ¬¡ DOM æ›´æ–°å¾ªç¯ç»“æŸåæ‰§â¾å»¶è¿Ÿå›è°ƒï¼Œåœ¨ä¿®æ”¹æ•°æ®ä¹‹åâ½´å³ä½¿â½¤ nextTick æ¥è·å–æ›´æ–°åçš„DOMã€‚
åŸç†* nextTick å¯¹äº micro task çš„å®ç°ï¼Œä¼šå…ˆæ£€æµ‹æ˜¯å¦â½€æŒ Promise ï¼Œä¸â½€æŒçš„è¯ï¼Œç›´æ¥æŒ‡å‘ macrotaskï¼Œâ½½ macro task çš„å®ç°ï¼Œä¼˜å…ˆæ£€æµ‹æ˜¯å¦â½€æŒ setImmediate ï¼ˆâ¾¼ç‰ˆæœ¬IEå’ŒEtageâ½€æŒï¼‰ï¼Œä¸â½€æŒçš„å†å»æ£€æµ‹æ˜¯å¦â½€æŒ MessageChannelï¼Œå¦‚æœä»ä¸â½€æŒï¼Œæœ€ç»ˆé™çº§ä¸º setTimeout 0ï¼›
* é»˜è®¤çš„æƒ…å†µï¼Œä¼šå…ˆä»¥ micro task â½…å¼æ‰§â¾ï¼Œå› ä¸º micro task å¯ä»¥åœ¨â¼€æ¬¡ tick ä¸­å…¨éƒ¨æ‰§â¾å®Œæ¯•ï¼Œåœ¨â¼€äº›æœ‰é‡ç»˜å’ŒåŠ¨ç”»çš„åœºæ™¯æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚
* ä½†æ˜¯ç”±äº micro task ä¼˜å…ˆçº§è¾ƒâ¾¼ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šåœ¨äº‹ä»¶å†’æ³¡è¿‡ç¨‹ä¸­è§¦å‘ï¼Œå¯¼è‡´â¼€äº›é—®é¢˜ï¼Œæ‰€ä»¥æœ‰äº›åœ°â½…ä¼šå¼ºåˆ¶ä½¿â½¤ macro task ï¼ˆå¦‚ v-on ï¼‰ã€‚
æ³¨æ„ï¼šä¹‹æ‰€ä»¥å°† nextTick çš„å›è°ƒå‡½æ•°æ”¾â¼Šåˆ°æ•°ç»„ä¸­â¼€æ¬¡æ€§æ‰§â¾ï¼Œâ½½ä¸æ˜¯ç›´æ¥åœ¨ nextTick ä¸­æ‰§â¾å›è°ƒå‡½æ•°ï¼Œæ˜¯ä¸ºäº†ä¿è¯åœ¨åŒâ¼€ä¸ªtickå†…å¤šæ¬¡æ‰§â¾äº† nextTcik ï¼Œä¸ä¼šå¼€å¯å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œâ½½æ˜¯æŠŠè¿™äº›å¼‚æ­¥ä»»åŠ¡éƒ½å‹æˆâ¼€ä¸ªåŒæ­¥ä»»åŠ¡ï¼Œåœ¨ä¸‹â¼€ä¸ªtickå†…æ‰§â¾å®Œæ¯•ã€‚ï¼ˆæ„æ€æ˜¯æœ‰å¯èƒ½nextTické‡Œä¹Ÿä¼šä¿®æ”¹å“åº”å¼æ•°æ®ï¼‰

æ³¨æ„ï¼š
- domæ›´æ–°å’ŒnextTickæ‰§è¡Œ(å¦‚æœæ˜¯micro-taskå®ç°)ï¼Œæ˜¯åœ¨åŒä¸€ä¸ªtickä¸­è¿›è¡Œçš„ã€‚
- ä¸‹ä¸€æ¬¡çš„æ„æ€ï¼Œæ•°æ®å˜åŒ–åï¼Œre-renderæ˜¯å¼‚æ­¥çš„ï¼Œre-renderæ˜¯ä¸‹ä¸€æ¬¡ä»»åŠ¡é‡è¿›è¡Œçš„ã€‚
- DOM æ¸²æŸ“æ—¢ç„¶åœ¨å¾®ä»»åŠ¡ä¹‹åï¼Œä¸ºä»€ä¹ˆåœ¨å¾®ä»»åŠ¡ä¸­ï¼Œå¯ä»¥æ‹¿åˆ°æ¸²æŸ“åçš„ DOM å‘¢ï¼Œ
  - å¾®ä»»åŠ¡ä¸­è·å¾—çš„domå¯¹è±¡å·²ç»æ˜¯æ›´æ–°è¿‡åçš„ï¼Œåªæ˜¯è¿˜æ²¡æ¸²æŸ“ã€‚
```
#å›› æ£€æµ‹å˜åŒ–çš„æ³¨æ„äº‹é¡¹

~ ä¸ºä»€ä¹ˆ `vm.a` æ˜¯å“åº”çš„ï¼Œ `vm.b` æ˜¯éå“åº”çš„ï¼Ÿ
@å¯¹äºå¯¹è±¡ï¼š
* Vue æ— æ³•æ£€æµ‹æ ¹çº§ property çš„æ·»åŠ æˆ–ç§»é™¤ï¼Œ
* ç”±äº Vue ä¼šåœ¨åˆå§‹åŒ–å®ä¾‹æ—¶å¯¹ property æ‰§è¡Œ getter/setter è½¬åŒ–ï¼Œæ‰€ä»¥ property å¿…é¡»åœ¨ data å¯¹è±¡ä¸Šå­˜åœ¨æ‰èƒ½è®© Vue å°†å®ƒè½¬æ¢ä¸ºå“åº”å¼çš„ã€‚
* å¯¹äºå·²ç»åˆ›å»ºçš„å®ä¾‹ï¼ŒVue ä¸å…è®¸åŠ¨æ€æ·»åŠ æ ¹çº§åˆ«çš„å“åº”å¼ propertyã€‚ä½†æ˜¯ï¼Œå¯ä»¥ä½¿ç”¨ Vue.set(object, propertyName, value) æ–¹æ³•å‘åµŒå¥—å¯¹è±¡æ·»åŠ å“åº”å¼ propertyã€‚è¿˜å¯ä»¥ä½¿ç”¨ vm.$set å®ä¾‹æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯å…¨å±€ Vue.set æ–¹æ³•çš„åˆ«åï¼šthis.$set(this.someObject,'b',2)

~ ç›´æ¥ç»™ä¸€ä¸ªæ•°ç»„é¡¹é€šè¿‡ç´¢å¼•èµ‹å€¼ï¼ŒVue èƒ½æ£€æµ‹åˆ°å˜åŒ–å—ï¼Ÿ
~ Vueä¸èƒ½æ£€æµ‹æ•°ç»„çš„å“ªäº›å˜åŠ¨ï¼Ÿ
@å¯¹äºæ•°ç»„ï¼š
* Vue ä¸èƒ½æ£€æµ‹ä»¥ä¸‹æ•°ç»„çš„å˜åŠ¨ï¼š
1. å½“ä½ åˆ©ç”¨ç´¢å¼•ç›´æ¥è®¾ç½®ä¸€ä¸ªæ•°ç»„é¡¹æ—¶ï¼Œä¾‹å¦‚ï¼švm.items[indexOfItem] = newValue
2. å½“ä½ ä¿®æ”¹æ•°ç»„çš„é•¿åº¦æ—¶ï¼Œä¾‹å¦‚ï¼švm.items.length = newLength
ä¸ºäº†è§£å†³ç¬¬ä¸€ç±»é—®é¢˜ï¼Œä»¥ä¸‹ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥å®ç°å’Œ vm.items[indexOfItem] = newValue ç›¸åŒçš„æ•ˆæœï¼ŒåŒæ—¶ä¹Ÿå°†åœ¨å“åº”å¼ç³»ç»Ÿå†…è§¦å‘çŠ¶æ€æ›´æ–°ï¼š
Vue.set(vm.items, indexOfItem, newValue) // Vue.set
vm.items.splice(indexOfItem, 1, newValue) // Array.prototype.splice
ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ vm.$set å®ä¾‹æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯å…¨å±€æ–¹æ³• Vue.set çš„ä¸€ä¸ªåˆ«åï¼švm.$set(vm.items, indexOfItem, newValue)
ä¸ºäº†è§£å†³ç¬¬äºŒç±»é—®é¢˜ï¼Œä½ å¯ä»¥ä½¿ç”¨ spliceï¼švm.items.splice(newLength)

ä¸ºä»€ä¹ˆæ•°ç»„é•¿åº¦ä¸èƒ½è¢« getter/setter ï¼Ÿ
åœ¨çŸ¥ä¹ä¸Šæ‰¾äº†ä¸€ä¸ªç­”æ¡ˆï¼šå¦‚æœä½ çŸ¥é“æ•°ç»„çš„é•¿åº¦ï¼Œç†è®ºä¸Šæ˜¯å¯ä»¥é¢„å…ˆç»™æ‰€æœ‰çš„ç´¢å¼•è®¾ç½® getter/setter çš„ã€‚ä½†æ˜¯ä¸€æ¥å¾ˆå¤šåœºæ™¯ä¸‹ä½ ä¸çŸ¥é“æ•°ç»„çš„é•¿åº¦ï¼ŒäºŒæ¥ï¼Œå¦‚æœæ˜¯å¾ˆå¤§çš„æ•°ç»„ï¼Œé¢„å…ˆåŠ  getter/setter æ€§èƒ½è´Ÿæ‹…è¾ƒå¤§ã€‚

@å£°æ˜å“åº”å¼ property // ç®—æ˜¯ä¸ªè§„èŒƒ
ç”±äº Vue ä¸å…è®¸åŠ¨æ€æ·»åŠ æ ¹çº§å“åº”å¼ propertyï¼Œæ‰€ä»¥ä½ å¿…é¡»åœ¨åˆå§‹åŒ–å®ä¾‹å‰å£°æ˜æ‰€æœ‰æ ¹çº§å“åº”å¼ propertyï¼Œå“ªæ€•åªæ˜¯ä¸€ä¸ªç©ºå€¼ã€‚
è¿™æ ·çš„é™åˆ¶åœ¨èƒŒåæ˜¯æœ‰å…¶æŠ€æœ¯åŸå› çš„ï¼Œå®ƒæ¶ˆé™¤äº†åœ¨ä¾èµ–é¡¹è·Ÿè¸ªç³»ç»Ÿä¸­çš„ä¸€ç±»è¾¹ç•Œæƒ…å†µï¼Œä¹Ÿä½¿ Vue å®ä¾‹èƒ½æ›´å¥½åœ°é…åˆç±»å‹æ£€æŸ¥ç³»ç»Ÿå·¥ä½œã€‚
ä½†ä¸æ­¤åŒæ—¶åœ¨ä»£ç å¯ç»´æŠ¤æ€§æ–¹é¢ä¹Ÿæœ‰ä¸€ç‚¹é‡è¦çš„è€ƒè™‘ï¼šdata å¯¹è±¡å°±åƒç»„ä»¶çŠ¶æ€çš„ç»“æ„ (schema)ã€‚æå‰å£°æ˜æ‰€æœ‰çš„å“åº”å¼ propertyï¼Œå¯ä»¥è®©ç»„ä»¶ä»£ç åœ¨æœªæ¥ä¿®æ”¹æˆ–ç»™å…¶ä»–å¼€å‘äººå‘˜é˜…è¯»æ—¶æ›´æ˜“äºç†è§£ã€‚

```

```
~ vue2.xä¸­å¦‚ä½•ç›‘æµ‹æ•°ç»„å˜åŒ–ï¼Ÿï¼ˆå¥½æè¿°ï¼‰
* ä½¿ç”¨äº†å‡½æ•°åŠ«æŒçš„æ–¹å¼ï¼Œé‡å†™äº†æ•°ç»„çš„æ–¹æ³•ï¼ŒVueå°†dataä¸­çš„æ•°ç»„è¿›è¡Œäº†åŸå‹é“¾é‡å†™ï¼ŒæŒ‡å‘äº†è‡ªå·±å®šä¹‰çš„æ•°ç»„åŸå‹æ–¹æ³•ï¼Œå½“è°ƒç”¨æ•°ç»„apiæ—¶ï¼Œå¯ä»¥é€šçŸ¥ä¾èµ–æ›´æ–°ã€‚
* å¦‚æœæ•°ç»„ä¸­åŒ…å«ç€å¼•ç”¨ç±»å‹ï¼Œä¼šå¯¹æ•°ç»„ä¸­çš„å¼•ç”¨ç±»å‹å†æ¬¡é€’å½’éå†è¿›è¡Œç›‘æ§ã€‚è¿™æ ·å°±å®ç°äº†ç›‘æµ‹æ•°ç»„å˜åŒ–ã€‚

$ æ•°ç»„æ–¹æ³•å¦‚ä½•è§¦å‘å“åº”å¼æ›´æ–°ï¼Ÿ
æ•°ç»„è‡ªèº«å˜æ›´ï¼špush() pop() shift() unshift() splice() sort() reverse()
æ•°ç»„é‡æ–°èµ‹å€¼ï¼šfilter() concat() slice()

$ æ•°ç»„è‡ªèº«å˜æ›´çš„æ–¹æ³•è§¦å‘å“åº”å¼æ›´æ–°çš„åº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ
Vueå†…éƒ¨ä½¿ç”¨å‡½æ•°åŠ«æŒæ–¹å¼ï¼Œå¯¹æ•°ç»„æ–¹æ³•è¿›è¡Œäº†æ‹¦æˆªï¼Œé‡å†™äº†æ•°ç»„æ–¹æ³•ï¼ˆpushã€popã€shiftã€unshiftã€spliceã€sortã€reverseï¼‰
å½“ Vue å¯¹ data é€‰é¡¹æ•°æ®è¿›è¡Œæ•°æ®è§‚æµ‹æ—¶ï¼Œä¼šå¯¹æ•°ç»„æ•°æ®è¿›è¡ŒåŸå‹é“¾é‡å†™ value.__proto__ = arrayMethodsï¼ŒæŒ‡å‘é‡å†™çš„æ•°ç»„æ–¹æ³•å¯¹è±¡ä¸Š
å½“ data æ•°ç»„è°ƒç”¨æ•°ç»„æ–¹æ³•æ—¶ï¼Œå¯ä»¥é€šçŸ¥ä¾èµ–æ›´æ–°ï¼Œå¦‚æœ‰æ–°å¢æ•°ç»„å…ƒç´ çš„ä¹Ÿä¼šè¿›è¡Œé€’å½’æ•°æ®è§‚æµ‹ã€‚
è¿™æ ·å°±å®ç°äº†ç›‘æµ‹æ•°ç»„å˜åŒ–å¹¶è¿›è¡Œå“åº”å¼æ›´æ–°ã€‚
å…·ä½“æ•°ç»„æ–¹æ³•é‡å†™ä½œäº†ï¼š
1 æ‰§è¡ŒåŸå§‹æ•°ç»„æ–¹æ³•
2 å¯¹æ–°å¢ï¼ˆpushã€unshiftã€spliceï¼‰æ•°ç»„å…ƒç´ ï¼Œè¿›è¡Œè§‚æµ‹
3 dep ä¾èµ–è§¦å‘ notify é€šçŸ¥ï¼Œè¿›è¡Œå“åº”å¼æ›´æ–°
4 è¿”å›åŸå§‹æ‰§è¡Œç»“æœ

Vueå†…éƒ¨ä½¿ç”¨å‡½æ•°åŠ«æŒæ–¹å¼ï¼Œå¯¹æ•°ç»„æ–¹æ³•è¿›è¡Œäº†æ‹¦æˆªï¼Œé‡å†™äº†æ•°ç»„æ–¹æ³•ï¼ˆpushã€popã€shiftã€unshiftã€spliceã€sortã€reverseï¼‰
const arrayProto = Array.prototype
export const arrayMethods = Object.create(arrayProto)
['push', 'pop', 'shift', 'unshift', 'splice', 'sort', 'reverse'].forEach(function (method) {
  // cache original method
  const original = arrayProto[method]
  def(arrayMethods, method, function mutator (...args) {
    const result = original.apply(this, args)
    const ob = this.__ob__
    let inserted
    switch (method) {
      case 'push':
      case 'unshift':
        inserted = args
        break
      case 'splice':
        inserted = args.slice(2)
        break
    }
    if (inserted) ob.observeArray(inserted)
    // notify change
    ob.dep.notify()
    return result
  })
})
0 åœ¨ arrayMethods æ·»åŠ é‡å†™æ•°ç»„æ–¹æ³•ï¼Œé‡å†™è¿›è¡Œäº†ä¸‹é¢3æ­¥ï¼š
1 æ‰§è¡ŒåŸå§‹æ•°ç»„æ–¹æ³•
2 å¯¹æ–°å¢ï¼ˆpushã€unshiftã€spliceï¼‰æ•°ç»„å…ƒç´ ï¼Œè¿›è¡Œè§‚æµ‹
3 dep ä¾èµ–è§¦å‘ notify é€šçŸ¥ï¼Œè¿›è¡Œå“åº”å¼æ›´æ–°
4 è¿”å›åŸå§‹æ‰§è¡Œç»“æœ

å½“ Vue å¯¹ data é€‰é¡¹æ•°æ®è¿›è¡Œæ•°æ®è§‚æµ‹æ—¶ï¼Œä¼šå¯¹æ•°ç»„æ•°æ®è¿›è¡ŒåŸå‹é“¾é‡å†™ value.__proto__ = arrayMethodsï¼ŒæŒ‡å‘é‡å†™çš„æ•°ç»„æ–¹æ³•å¯¹è±¡ä¸Š
ç»§æ‰¿å…³ç³»: arr -> arrayMethods -> Array.prototype -> Object.prototype -> â€¦

# Vueä¸­å¦‚ä½•æ£€æµ‹æ•°ç»„çš„å˜åŒ–ï¼Ÿ
ueä¸­å¯¹æ•°ç»„æ²¡æœ‰è¿›è¡ŒdefinePropertyï¼Œè€Œæ˜¯é‡å†™äº†æ•°ç»„çš„7ä¸ªæ–¹æ³•ã€‚ åˆ†åˆ«æ˜¯ï¼š
* push
* shift
* pop
* splice
* unshift
* sort
* reverse
å› ä¸ºè¿™äº›æ–¹æ³•éƒ½ä¼šæ”¹å˜æ•°ç»„æœ¬èº«ã€‚
æ•°ç»„é‡Œçš„ç´¢å¼•å’Œé•¿åº¦æ˜¯æ— æ³•è¢«ç›‘æ§çš„ã€‚
```

```
~ vm.$set çš„å®ç°åŸç†æ˜¯ï¼š
~ Vue æ€ä¹ˆç”¨ vm.$set() è§£å†³å¯¹è±¡æ–°å¢å±æ€§ä¸èƒ½å“åº”çš„é—®é¢˜ ï¼Ÿï¼ˆä¸é”™ï¼‰
å—ç°ä»£ JavaScript çš„é™åˆ¶ ï¼ŒVue æ— æ³•æ£€æµ‹åˆ°å¯¹è±¡å±æ€§çš„æ·»åŠ æˆ–åˆ é™¤ã€‚ç”±äº Vue ä¼šåœ¨åˆå§‹åŒ–å®ä¾‹æ—¶å¯¹å±æ€§æ‰§è¡Œ getter/setter è½¬åŒ–ï¼Œæ‰€ä»¥å±æ€§å¿…é¡»åœ¨ data å¯¹è±¡ä¸Šå­˜åœ¨æ‰èƒ½è®© Vue å°†å®ƒè½¬æ¢ä¸ºå“åº”å¼çš„ã€‚ä½†æ˜¯ Vue æä¾›äº† Vue.set (object, propertyName, value) / vm.$set (object, propertyName, value) æ¥å®ç°ä¸ºå¯¹è±¡æ·»åŠ å“åº”å¼å±æ€§ï¼Œé‚£æ¡†æ¶æœ¬èº«æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ
æˆ‘ä»¬æŸ¥çœ‹å¯¹åº”çš„ Vue æºç ï¼švue/src/core/instance/index.js
export function set (target: Array<any> | Object, key: any, val: any): any {
  // target ä¸ºæ•°ç»„
  if (Array.isArray(target) && isValidArrayIndex(key)) {
    // ä¿®æ”¹æ•°ç»„çš„é•¿åº¦, é¿å…ç´¢å¼•>æ•°ç»„é•¿åº¦å¯¼è‡´splcie()æ‰§è¡Œæœ‰è¯¯
    target.length = Math.max(target.length, key)
    // åˆ©ç”¨æ•°ç»„çš„spliceå˜å¼‚æ–¹æ³•è§¦å‘å“åº”å¼
    target.splice(key, 1, val)
    return val
  }
  // è¿™é‡Œ key å°±æ˜¯å¯¹è±¡äº†ï¼Œä¸” key å·²ç»å­˜åœ¨ï¼Œç›´æ¥ä¿®æ”¹å±æ€§å€¼
  if (key in target && !(key in Object.prototype)) {
    target[key] = val // å¯¹è±¡ key å­˜åœ¨ï¼Œè¯´æ˜å·²ç»ç»è¿‡äº†å“åº”åŒ–å¤„ç†äº†
    return val
  }
  const ob = (target: any).__ob__
  // target æœ¬èº«å°±ä¸æ˜¯å“åº”å¼æ•°æ®, ç›´æ¥èµ‹å€¼
  if (!ob) {
    target[key] = val
    return val
  }
  // å¯¹å±æ€§è¿›è¡Œå“åº”å¼å¤„ç†ï¼Œå¯¹æ–°å¢çš„ key defineReactiveï¼ŒåŒæ—¶è§¦å‘é€šçŸ¥
  defineReactive(ob.value, key, val)
  ob.dep.notify()
  return val
}
æˆ‘ä»¬é˜…è¯»ä»¥ä¸Šæºç å¯çŸ¥ï¼Œvm.$set çš„å®ç°åŸç†æ˜¯ï¼šã€ŒğŸ‘ã€
* å¦‚æœç›®æ ‡æ˜¯æ•°ç»„ï¼Œç›´æ¥ä½¿ç”¨æ•°ç»„çš„ splice æ–¹æ³•è§¦å‘ç›¸åº”å¼ï¼›
* å¦‚æœç›®æ ‡æ˜¯å¯¹è±¡ï¼Œä¼šå…ˆåˆ¤è¯»å±æ€§æ˜¯å¦å­˜åœ¨ã€å¯¹è±¡æ˜¯å¦æ˜¯å“åº”å¼ï¼Œæœ€ç»ˆå¦‚æœè¦å¯¹å±æ€§è¿›è¡Œå“åº”å¼å¤„ç†ï¼Œåˆ™æ˜¯é€šè¿‡è°ƒç”¨ defineReactive æ–¹æ³•è¿›è¡Œå“åº”å¼å¤„ç†ï¼ˆ defineReactive æ–¹æ³•å°±æ˜¯ Vue åœ¨åˆå§‹åŒ–å¯¹è±¡æ—¶ï¼Œç»™å¯¹è±¡å±æ€§é‡‡ç”¨ Object.defineProperty åŠ¨æ€æ·»åŠ  getter å’Œ setter çš„åŠŸèƒ½æ‰€è°ƒç”¨çš„æ–¹æ³•ï¼‰
```
```
åè¯è§£é‡Šï¼Œæœ‰åŠ©äºç†è§£
Dep ä¾èµ–çš„æ„æ€ï¼Œä¾èµ–æ”¶é›†ï¼Œä¸¤å±‚æ„æ€ï¼šDepè¿™ä¸ªä¾èµ–å»æ”¶é›†Watcherè§‚å¯Ÿè€…ï¼ŒåŒæ—¶Watcherä¹Ÿåœ¨åšaddDepæ·»åŠ ä¾èµ–ï¼Œäº’ç›¸çš„ï¼Œäº’ç›¸æ”¶é›†ã€‚
depend ä¾èµ–
addDep æ·»åŠ ä¾èµ–çš„æ„æ€
watcher è§‚å¯Ÿè€…
subscribe è®¢é˜…
```

```
VueåŒå‘ç»‘å®šåŸç†ç®€å•ç‰ˆï¼Ÿ

# ä¸‹é¢çš„åªæ˜¯æ¨¡æ‹ŸVueå“åº”å¼è¿‡ç¨‹ â€”â€”â€”â€”â€”â€”
DocumentFragmentï¼ˆæ–‡æ¡£ç‰‡æ®µï¼‰å¯ä»¥çœ‹åšæ˜¯èŠ‚ç‚¹å®¹å™¨
*ä½¿ç”¨ï¼š
å®ƒå¯ä»¥åŒ…å«å¤šä¸ªå­èŠ‚ç‚¹ï¼Œå¯ä»¥æŠŠå®ƒæ’å…¥åˆ°DOMä¸­ï¼Œ
åªæœ‰å®ƒçš„å­èŠ‚ç‚¹ä¼šæ’å…¥ç›®æ ‡èŠ‚ç‚¹ï¼Œæ‰€ä»¥å¯ä»¥æŠŠå®ƒçœ‹åšæ˜¯ä¸€ç»„èŠ‚ç‚¹å®¹å™¨ã€‚
*Vueä¸­ï¼š
Vueè¿›è¡Œç¼–è¯‘çš„æ—¶å€™å°±æ˜¯å°†æŒ‚è½½ç›®æ ‡çš„æ‰€æœ‰å­èŠ‚ç‚¹åŠ«æŒåˆ°DocumentFragmentä¸­ï¼Œ
ç»è¿‡å¤„ç†åå†å°†DocumentFragmentæ•´ä½“è¿”å›åˆ°æŒ‚è½½ç›®æ ‡ã€‚
*ä¼˜ç‚¹ï¼š
ä½¿ç”¨DocumentFragmentå¤„ç†èŠ‚ç‚¹é€Ÿåº¦å’Œæ€§èƒ½ä¼˜äºç›´æ¥æ“ä½œDOMã€‚

observe æ–¹æ³•
éå†vueå®ä¾‹ä¸­dataçš„å±æ€§ï¼Œé€ä¸€è°ƒç”¨defineReactiveæ–¹æ³•ï¼ŒæŠŠä»–ä»¬å®šä¹‰ä¸ºè®¿é—®å™¨å±æ€§

defineReactive æ–¹æ³•
ç»™vueå®ä¾‹ä¸­çš„dataçš„å•ä¸ªå±æ€§é‡æ–°å®šä¹‰ä¸ºè®¿é—®å™¨å±æ€§getterã€setterï¼Œå¹¶åœ¨setæ–¹æ³•ä¸­å°†æ–°çš„å€¼æ›´æ–°åˆ°å¯¹åº”çš„å±æ€§ä¸Šï¼Œ
åœ¨è¿™é‡Œç”Ÿæˆä¸€ä¸ªdepå®ä¾‹ï¼Œæ¯ä¸€ä¸ªdataçš„å±æ€§ç”Ÿæˆä¸»é¢˜å¯¹è±¡Depï¼Œ
getterä¸­ï¼Œå¦‚æœä¸»é¢˜å¯¹è±¡ç±»çš„é™æ€å±æ€§targetæœ‰å€¼ï¼ˆæ­¤æ—¶å› ä¸ºWatcherçš„getæ–¹æ³•è¢«è°ƒç”¨ï¼‰ï¼Œç»™ä¸»é¢˜å¯¹è±¡æ·»åŠ è®¢é˜…è€…Watcherå®ä¾‹ï¼Œdep.addSub(Dep.target)ï¼Œå®Œæˆä¾èµ–æ”¶é›†ï¼ŒDep.targetå°±æ˜¯Watcherå®ä¾‹ï¼Œ
setterä¸­ï¼Œé…ç½®dep.notify()ï¼Œè¯¥å±æ€§å€¼è¢«é‡å¤èµ‹å€¼æ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªä¸»ä½“å¯¹è±¡depé€šçŸ¥ï¼Œå®ƒé‡Œé¢æ·»åŠ çš„å„ä¸ªWatcherï¼Œæ¯ä¸ªWatcheréƒ½ä¼šè§¦å‘è‡ªå·±çš„updataï¼Œé‡æ–°ç¼–è¯‘æ›´æ–°è§†å›¾ç­‰ã€‚

nodeToFragment æ–¹æ³•
éå†èŠ‚ç‚¹ï¼Œä¸ºæ¯ä¸ªå­èŠ‚ç‚¹æ‰§è¡Œcompileï¼Œ
compileå¥½çš„èŠ‚ç‚¹ï¼ŒåŠ«æŒåˆ°DocumentFragmentä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºç¼–è¯‘ã€‚

compile æ–¹æ³• // éšè—è¿™ä¼šå½¢æˆrenderå‡½æ•°
ç›‘å¬inputå€¼å˜åŒ–ï¼Œå¹¶ç»™vueå®ä¾‹ä¸­ç›¸åº”dataçš„è®¿é—®å™¨å±æ€§èµ‹å€¼ï¼Œè¿™é‡Œä¼šè§¦å‘å¯¹åº”dataå±æ€§çš„setterï¼Œ
åœ¨ç¼–è¯‘æ–¹æ³•compileä¸­ï¼ŒåŠ«æŒå­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¸ºæ¯ä¸ªä¸æ•°æ®ç»‘å®šç›¸å…³çš„èŠ‚ç‚¹ç”Ÿæˆä¸€ä¸ªè®¢é˜…è€…new Watcherï¼Œ// åœ¨vueé‡Œæ¯ä¸ªç»„ä»¶ç”Ÿæˆä¸€ä¸ªWatcherå®ä¾‹

Watcher
æ¯ä¸ªä¸æ•°æ®ç»‘å®šç›¸å…³çš„èŠ‚ç‚¹ç”Ÿæˆä¸€ä¸ªè®¢é˜…è€…new Watcherï¼Œ// åœ¨vueé‡Œæ¯ä¸ªç»„ä»¶ç”Ÿæˆä¸€ä¸ªWatcherå®ä¾‹
Dep.target = this å°†å®ä¾‹è‡ªå·±èµ‹å€¼ç»™Depé™æ€å±æ€§targetï¼Œä¹Ÿæ˜¯watcherä¸depå…³è”çš„å”¯ä¸€æ¡¥æ¢ï¼Œ
get() {} é€šè¿‡å±æ€§åè·å–dataå±æ€§å€¼ï¼Œè§¦å‘dataå±æ€§getterï¼Œè§¦å‘ä¾èµ–æ”¶é›†ï¼Œ
update () {} ä¸­ç»™è™šæ‹ŸèŠ‚ç‚¹èµ‹å€¼ã€‚

Dep
dataçš„æ¯ä¸€ä¸ªå±æ€§ç”Ÿæˆä¸»é¢˜å¯¹è±¡Depï¼Œæ”¶é›†è®¢é˜…è€…ã€å®šä¹‰notifyé€šçŸ¥ï¼Œç”¨æ¥æ‰§è¡Œæ‰€æœ‰è®¢é˜…ï¼Œå¯ä»¥æ”¶é›†å…³è”å¤šä¸ªç»„ä»¶Watcherå®ä¾‹ã€‚// åœ¨vueé‡Œæ¯ä¸ªç»„ä»¶ç”Ÿæˆä¸€ä¸ªWatcherå®ä¾‹
this.subs = []
addSub: this.subs.push(sub)
notify: this.subs.forEach(function (sub) {
          sub.update();
        });
â€”â€”â€”â€”â€”â€”â€”â€”
```